function MarkerSelector(e,t,n,r){if(t.type==="circle")return new CityDashboard.CircleMarker(e,t,n,r);else if(t.type==="image")return new CityDashboard.ImageMarker(e,t,n,r);else if(t.type==="polyline")return new CityDashboard.PolylineMarker(e,t,n,r);else if(t.type==="simple")return new CityDashboard.SimpleMarker(e,t,n,r)}function isPointInPoly(e,t){for(var n=false,r=-1,i=e.length,s=i-1;++r<i;s=r)(e[r].y<=t.y&&t.y<e[s].y||e[s].y<=t.y&&t.y<e[r].y)&&t.x<(e[s].x-e[r].x)*(t.y-e[r].y)/(e[s].y-e[r].y)+e[r].x&&(n=!n);return n}function GridSelector(e,t,n,r){if(t.type==="square")return new CityDashboard.SquareGrid(e,t,n,r);else if(t.type==="hexagonal")return new CityDashboard.HexagonalGrid(e,t,n,r)}function HeatmapSelector(e,t,n,r){if(t.type==="point-heatmap")return new CityDashboard.PointHeatmap(e,t,n,r);else if(t.type==="segment-heatmap")return new CityDashboard.SegmentHeatmap(e,t,n,r)}function DTesselationSelector(e,t,n,r){if(t.type==="delaunay")return new CityDashboard.Delaunay(e,t,n,r);else if(t.type==="voronoi")return new CityDashboard.Voronoi(e,t,n,r)}function LayerSelector(e,t){if(e.layer==="grid-layer")return new CityDashboard.GridLayer(e,t);else if(e.layer==="marker-layer")return new CityDashboard.MarkerLayer(e,t);else if(e.layer==="heatmap-layer")return new CityDashboard.HeatmapLayer(e,t);else if(e.layer==="delaunay-layer")return new CityDashboard.DelaunayLayer(e,t)}(function(e){e.fn.resizable=function(t){function a(t){r=t.clientX;i=t.clientY;s=u.outerWidth();o=u.outerHeight();e(document).on("mousemove",p);e(document).on("mouseup",d)}function p(e){if(l)u.css("height",o+e.clientY-i+"px");if(f)u.css("width",s+e.clientX-r+"px");if(c)u.css("top",e.clientY+"px").css("height",o+i-e.clientY+"px");if(h)u.css("left",e.clientX+"px").css("width",s-e.clientX+"px")}function d(t){e(document).off("mousemove",p);e(document).off("mouseup",d);u.trigger("resize")}var n=e("<div>").addClass("resizer").addClass(t+"-resize");this.append(n).addClass("resizable");n.on("mousedown",a);var r,i,s,o;var u=this;var f,l,c,h;l=t.search("s")>=0;f=t.search("e")>=0;c=t.search("n")>=0;h=t.search("w")>=0;this.scroll(function(e){n.css("top",u.scrollTop())});return this};e.fn.setID=function(e){if(e.charAt(0)==="#")e=e.slice(1);this.attr("id",e);return this};e.fn.movable=function(){var t=this.children(".options-panel");if(!t.length){t=e("<span>").addClass("options-panel");this.prepend(t)}var n=e("<span>").addClass("up-button").append("&#x25B2;");var r=e("<span>").addClass("down-button").append("&#x25BC;");t.prepend(r);t.prepend(n);var i=this;n.on("click",function(){i.insertBefore(i.prev())});r.on("click",function(){i.insertAfter(i.next())});return this};e.fn.closable=function(t){if(!t){t=function(){return}}var n=this.children(".options-panel");if(!n.length){n=e("<span>").addClass("options-panel");this.prepend(n)}var r=e("<span>").addClass("close-button").text("X");n.append(r);var i=this;r.on("click",function(){i.remove();t()});return this}})(jQuery);var CityDashboard={mainContainerID:"#city-dashboard",mapWindowID:"#mapWindow",infoWindowID:"#infoWindow",filterBarID:"#filterBar",getData:function(e,t,n){if(e.charAt(0)!=="#"){$.getJSON(e,function(e){n.data=e;return t(n)})}else{return t(n)}}};CityDashboard.GoogleMap=function(e){this.center={lat:e.lat||0,lng:e.lng||0};this.zoom=e.zoom||12;var t=$(CityDashboard["mapWindowID"])[0];this.googlemap=new google.maps.Map(t,{zoom:this.zoom,center:new google.maps.LatLng(this.center.lat,this.center.lng),disableDefaultUI:true});$(CityDashboard["mainContainerID"])[0].data=this.googlemap};CityDashboard.GoogleMap.prototype={constructor:CityDashboard.Map};CityDashboard.Marker=function(e,t,n,r){this.layer_params=e;this.attr=t;this.map=n;this.marker=undefined;this.layer=r};CityDashboard.Marker.prototype={constructor:CityDashboard.Marker,addEvents:function(){function t(){$("#infoWindow").trigger("marker-pressed",{id:e.layer.id,value:e.layer_params,attr:e.attr});for(var t=0;t<e.layer.markers.length;t++){var n=e.layer.markers[t].marker;if(n==this){n.setAnimation(google.maps.Animation.BOUNCE)}else{n.setAnimation(null)}}}google.maps.event.addListener(this.marker,"click",t);var e=this},triggerInitialEvent:function(){}};CityDashboard.CircleMarker=function(e,t,n,r){CityDashboard.Marker.call(this,e,t,n,r);var i=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng));var s=new google.maps.Circle({center:i,map:n,radius:t.radius||400,strokeColor:t.strokeColor||"#FF0000",strokeOpacity:t.strokeOpacity||.8,strokeWeight:t.strokeWeight||2,fillColor:t.fillColor||"#FF0000",fillOpacity:t.fillOpacity||.35,title:e.landmark||""});this.marker=s};CityDashboard.CircleMarker.prototype=Object.create(CityDashboard.Marker.prototype);CityDashboard.CircleMarker.prototype={constructor:CityDashboard.CircleMarker,addEvents:function(){function t(){$("#infoWindow").trigger("marker-pressed",{id:e.layer.id,value:e.layer_params,attr:e.attr})}google.maps.event.addListener(this.marker,"click",t);var e=this},triggerInitialEvent:function(){$("#infoWindow").trigger("marker-pressed",{id:this.layer.id,value:this.layer_params,attr:this.attr})}};CityDashboard.ImageMarker=function(e,t,n,r){CityDashboard.Marker.call(this,e,t,n,r);var i=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng));var s={url:t.src||"../src/Layers/Markers/not_found.svg",scaledSize:new google.maps.Size(30,50)};var o=new google.maps.Marker({position:i,map:n,icon:s,title:e.landmark||""});this.marker=o};CityDashboard.ImageMarker.prototype=Object.create(CityDashboard.Marker.prototype);CityDashboard.ImageMarker.prototype={constructor:CityDashboard.ImageMarker,addEvents:function(){function t(){$("#infoWindow").trigger("marker-pressed",{id:e.layer.id,value:e.layer_params,attr:e.attr});for(var t=0;t<e.layer.markers.length;t++){var n=e.layer.markers[t].marker;if(n==this){n.setAnimation(google.maps.Animation.BOUNCE)}else{n.setAnimation(null)}}}google.maps.event.addListener(this.marker,"click",t);var e=this},triggerInitialEvent:function(){$("#infoWindow").trigger("marker-pressed",{id:this.layer.id,value:this.layer_params,attr:this.attr});for(i=0;i<this.layer.markers.length;i++){this.layer.markers[i].marker.setAnimation(null)}this.marker.setAnimation(google.maps.Animation.BOUNCE)}};CityDashboard.SimpleMarker=function(e,t,n,r){CityDashboard.Marker.call(this,e,t,n,r);var i=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng));var s=new google.maps.Marker({position:i,map:n,title:e.landmark||""});this.marker=s};CityDashboard.SimpleMarker.prototype=Object.create(CityDashboard.Marker.prototype);CityDashboard.SimpleMarker.prototype={constructor:CityDashboard.SimpleMarker,addEvents:function(){function t(){$("#infoWindow").trigger("marker-pressed",{id:e.layer.id,value:e.layer_params,attr:e.attr});for(var t=0;t<e.layer.markers.length;t++){var n=e.layer.markers[t].marker;if(n==this){n.setAnimation(google.maps.Animation.BOUNCE)}else{n.setAnimation(null)}}}google.maps.event.addListener(this.marker,"click",t);var e=this},triggerInitialEvent:function(){$("#infoWindow").trigger("marker-pressed",{id:this.layer.id,value:this.layer_params,attr:this.attr});for(i=0;i<this.layer.markers.length;i++){this.layer.markers[i].marker.setAnimation(null)}this.marker.setAnimation(google.maps.Animation.BOUNCE)}};CityDashboard.PolylineMarker=function(e,t,n,r){CityDashboard.Marker.call(this,e,t,n,r);var i=[];var s=e.points.length;for(var o=0;o<s;o++){i[o]=new google.maps.LatLng(parseFloat(e.points[o].lat),parseFloat(e.points[o].lng))}var u=new google.maps.Polyline({path:i,strokeColor:t.strokeColor||"#000000",strokeOpacity:t.strokeOpacity||1,strokeWeight:t.strokeWeight||2});u.setMap(n)};CityDashboard.PolylineMarker.prototype=Object.create(CityDashboard.Marker.prototype);CityDashboard.PolylineMarker.prototype={constructor:CityDashboard.PolylineMarker,addEvents:function(){},triggerInitialEvent:function(){}};CityDashboard.Grid=function(e,t,n,r){this.layer_params=e;this.attr=t;this.map=n;this.layer=r;this.tiles=[]};CityDashboard.Grid.prototype={constructor:CityDashboard.Grid,build:function(){},addEvents:function(){}};CityDashboard.HexagonalGrid=function(e,t,n,r){CityDashboard.Grid.call(this,e,t,n,r)};CityDashboard.HexagonalGrid.prototype=Object.create(CityDashboard.Grid.prototype);CityDashboard.HexagonalGrid.prototype={constructor:CityDashboard.HexagonalGrid,build:function(e){l=this.attr.size||.02;var t=this.tiles.length;for(var n=0;n<t;n++){this.tiles[n].setMap(null)}this.tiles=[];var r=this.map.getZoom();var i=l*Math.pow(2,12);var s=[];for(var n=0;n<22;n++){s.push(i);i=i/2}var o=["transparent","blue","cyan","green","yellow","red"];var u=s[r];var a=e.getNorthEast();var f=e.getSouthWest();var c=Math.ceil(3/4*Math.abs(f.lat()-a.lat())/u);var h=Math.ceil(5/8*Math.abs(f.lng()-a.lng())/u);var p=u*Math.sin(Math.PI/6);var d=u*Math.cos(Math.PI/6);for(var n=0;n<c;n++){for(var v=0;v<h;v++){var m=a.lat()-(u+p)*n;var g;if(n%2==0)g=a.lng()-2*d*v+d;else g=a.lng()-2*d*v;poly=[{x:m,y:g},{x:m-u,y:g},{x:m-u-p,y:g-d},{x:m-u,y:g-2*d},{x:m,y:g-2*d},{x:m+p,y:g-d},{x:m,y:g}];var y=[new google.maps.LatLng(poly[0].x,poly[0].y),new google.maps.LatLng(poly[1].x,poly[1].y),new google.maps.LatLng(poly[2].x,poly[2].y),new google.maps.LatLng(poly[3].x,poly[3].y),new google.maps.LatLng(poly[4].x,poly[4].y),new google.maps.LatLng(poly[5].x,poly[5].y),new google.maps.LatLng(poly[6].x,poly[6].y)];pointsInScreen=[];weightsInScreen=[];for(var b=0;b<this.layer_params.points.length;b++){if(e.contains(new google.maps.LatLng(this.layer_params.points[b].lat,this.layer_params.points[b].lng))){pointsInScreen.push(this.layer_params.points[b]);weightsInScreen.push(this.layer_params.weights[b])}}var w=0;var E=1/weightsInScreen.length;var S=0;for(var b=0;b<weightsInScreen.length;b++){S=S+weightsInScreen[b]}for(var b=0;b<weightsInScreen.length;b++){weightsInScreen[b]=weightsInScreen[b]/S}for(var b=0;b<pointsInScreen.length;b++){if(isPointInPoly(poly,{x:pointsInScreen[b].lat,y:pointsInScreen[b].lng}))w=w+weightsInScreen[b]}var x=new google.maps.Polygon({paths:y,strokeColor:this.attr.color||"#000000",strokeOpacity:.5,strokeWeight:2,fillColor:o[Math.floor(w*o.length+.5)]||"#000000",fillOpacity:.2,geodesic:true});x.setMap(this.map);this.tiles.push(x)}}},addEvents:function(){var e=this;google.maps.event.addListener(this.map,"bounds_changed",function(){window.setTimeout(e.build(this.getBounds()),50)})}};CityDashboard.SquareGrid=function(e,t,n,r){CityDashboard.Grid.call(this,e,t,n,r)};CityDashboard.SquareGrid.prototype=Object.create(CityDashboard.Grid.prototype);CityDashboard.SquareGrid.prototype={constructor:CityDashboard.SquareGrid,build:function(e){var t=this.attr.size||.03;var n=this.tiles.length;for(var r=0;r<n;r++){this.tiles[r].setMap(null)}this.tiles=[];var i=this.map.getZoom();var s=t*Math.pow(2,12);var o=[];for(var r=0;r<22;r++){o.push(s);s=s/2}var u=o[i];var a=e.getNorthEast()||0;var f=e.getSouthWest()||0;var l=Math.ceil(Math.abs(f.lat()-a.lat())/u);var c=Math.ceil(Math.abs(f.lng()-a.lng())/u);for(var r=0;r<l;r++){for(var h=0;h<c;h++){var p=a.lat()-u*r;var d=a.lng()-u*h;var v=[new google.maps.LatLng(p,d),new google.maps.LatLng(p-u,d),new google.maps.LatLng(p-u,d-u),new google.maps.LatLng(p,d-u),new google.maps.LatLng(p,d)];var m=new google.maps.Polygon({paths:v,strokeColor:this.attr.color||"#578b8b",strokeOpacity:.5,strokeWeight:2,fillColor:this.attr.color||"#578b8b",fillOpacity:0,geodesic:true});m.setMap(this.map);this.tiles.push(m)}}},addEvents:function(){var e=this;google.maps.event.addListener(this.map,"bounds_changed",function(){window.setTimeout(e.build(this.getBounds()),50)})}};CityDashboard.Heatmap=function(e,t,n,r){};CityDashboard.Heatmap.prototype={constructor:CityDashboard.Heatmap};CityDashboard.PointHeatmap=function(e,t,n,r){var i=[];var s=e.points.length;for(var o=0;o<s;o++){i[o]=new google.maps.LatLng(parseFloat(e.points[o].lat),parseFloat(e.points[o].lng))}var u=new google.maps.MVCArray(i);this.heatmap=new google.maps.visualization.HeatmapLayer({data:u,radius:t.radius||10});this.heatmap.setMap(n)};CityDashboard.PointHeatmap.prototype=Object.create(CityDashboard.Heatmap.prototype);CityDashboard.PointHeatmap.prototype={constructor:CityDashboard.PointHeatmap};CityDashboard.SegmentHeatmap=function(e,t,n,r){var i=[];var s=e.segments.length;for(var o=0;o<s;o++){i[o]=[];for(var u=0;u<e.segments[o].length;u++){i[o][u]={lat:parseFloat(e.segments[o][u].lat),lng:parseFloat(e.segments[o][u].lng)}}}var a=[];for(var o=0;o<i.length;o++){var f=i[o].length;for(var u=0;u<f-1;u++){var l=Math.sqrt(Math.pow(i[o][u+1].lat-i[o][u].lat,2)+Math.pow(i[o][u+1].lng-i[o][u].lng,2));var c=Math.floor(l/1e-5);var h={lat:(i[o][u+1].lat-i[o][u].lat)/c,lng:(i[o][u+1].lng-i[o][u].lng)/c};for(var p=0;p<c;p++){var d=i[o][u].lat;var v=i[o][u].lng;a.push({location:new google.maps.LatLng(d+h.lat*p,v+h.lng*p),weight:e.weights[o]||1})}}}this.heatmap=new google.maps.visualization.HeatmapLayer({data:a});this.heatmap.setMap(n)};CityDashboard.SegmentHeatmap.prototype=Object.create(CityDashboard.Heatmap.prototype);CityDashboard.SegmentHeatmap.prototype={constructor:CityDashboard.SegmentHeatmap};CityDashboard.DTesselation=function(e,t,n,r){this.layer_params=e;this.attr=t;this.map=n;this.layer=r};CityDashboard.DTesselation.prototype={constructor:CityDashboard.DTesselation,build:function(){},addEvents:function(){},Add_GMapLine:function(e,t,n,r,i,s,o){var u=180/Math.PI;if(n.length<2)return;var a=t[n[0]];var f=[a];for(var l=1;l<n.length;l++){var c=t[n[l]];f=f.concat(this.SplitSegment(a,c),[c]);a=c}var h=[];for(var p=0;p<f.length;p++){var c=f[p];var d=u*Math.atan2(c[2],Math.sqrt(c[0]*c[0]+c[1]*c[1]));var v=u*Math.atan2(c[1],c[0]);h.push(new google.maps.LatLng(d,v))}var m=new google.maps.Polyline({path:h,strokeColor:r,strokeWeight:i,strokeOpacity:s,clickable:false});m.setMap(o);e.push(m)},SplitSegment:function(e,t){var n=0;for(var r=0;r<3;r++){var i=t[r]-e[r];n+=i*i}var s=[];if(n<.01)return s;var o=new Array(3);for(var r=0;r<3;r++)o[r]=e[r]+t[r];var u=0;for(var r=0;r<3;r++){pc=o[r];u+=pc*pc}var a=1/Math.sqrt(u);for(var r=0;r<3;r++)o[r]*=a;return s.concat(this.SplitSegment(e,o),[o],this.SplitSegment(o,t))},ClearOvlyArray:function(e){while(e.length>0){var t=e.pop();t.setMap(null)}}};CityDashboard.Voronoi=function(e,t,n,r){CityDashboard.DTesselation.call(this,e,t,n,r);var i=[];var s=Math.PI/180;var o=180/Math.PI;var u=[];var a=[];var f=e.points.length;for(var l=0;l<f;l++){i[l]=new google.maps.LatLng(parseFloat(e.points[l].lat),parseFloat(e.points[l].lng))}var c=this;var h=function(){c.ClearOvlyArray(a);var e=[];for(var r=0;r<i.length;r++){var o=i[r];var u=s*o.lat();var f=s*o.lng();var l=Math.cos(u);var h=[l*Math.cos(f),l*Math.sin(f),Math.sin(u)];for(var p=0;p<3;p++)h[p]+=1e-10*(2*Math.random()-1);var d=0;for(var p=0;p<3;p++)d+=h[p]*h[p];var v=1/Math.sqrt(d);for(var p=0;p<3;p++)h[p]*=v;e.push(h)}var m=FindDelaunayTriangulation(e);for(var r=0;r<m.vor_edges.length;r++){var g=m.vor_edges[r];if(g[0]<0)continue;if(g[1]<0)continue;c.Add_GMapLine(a,m.vor_positions,g,t.color||"#578b8b",2,1,n)}};h();markers=[];for(var l=0;l<i.length;l++){var p=new google.maps.Marker({position:i[l],map:n,draggable:true});markers[l]=p}var d=function(){for(var e=0;e<i.length;e++){if(markers[e].position!=i[e]){i[e]=this.position;break}}h()};for(var l=0;l<i.length;l++){google.maps.event.addListener(markers[l],"drag",d)}};CityDashboard.Voronoi.prototype=Object.create(CityDashboard.DTesselation.prototype);CityDashboard.Voronoi.prototype={constructor:CityDashboard.Voronoi,build:function(){},addEvents:function(){},Add_GMapLine:function(e,t,n,r,i,s,o){var u=180/Math.PI;if(n.length<2)return;var a=t[n[0]];var f=[a];for(var l=1;l<n.length;l++){var c=t[n[l]];f=f.concat(this.SplitSegment(a,c),[c]);a=c}var h=[];for(var p=0;p<f.length;p++){var c=f[p];var d=u*Math.atan2(c[2],Math.sqrt(c[0]*c[0]+c[1]*c[1]));var v=u*Math.atan2(c[1],c[0]);h.push(new google.maps.LatLng(d,v))}var m=new google.maps.Polyline({path:h,strokeColor:r,strokeWeight:i,strokeOpacity:s,clickable:false});m.setMap(o);e.push(m)},SplitSegment:function(e,t){var n=0;for(var r=0;r<3;r++){var i=t[r]-e[r];n+=i*i}var s=[];if(n<.01)return s;var o=new Array(3);for(var r=0;r<3;r++)o[r]=e[r]+t[r];var u=0;for(var r=0;r<3;r++){pc=o[r];u+=pc*pc}var a=1/Math.sqrt(u);for(var r=0;r<3;r++)o[r]*=a;return s.concat(this.SplitSegment(e,o),[o],this.SplitSegment(o,t))},ClearOvlyArray:function(e){while(e.length>0){var t=e.pop();t.setMap(null)}}};CityDashboard.Delaunay=function(e,t,n,r){CityDashboard.DTesselation.call(this,e,t,n,r);var i=[];var s=Math.PI/180;var o=180/Math.PI;var u=[];var a=[];var f=e.points.length;for(var l=0;l<f;l++){i[l]=new google.maps.LatLng(parseFloat(e.points[l].lat),parseFloat(e.points[l].lng))}var c=this;var h=function(){c.ClearOvlyArray(u);var e=[];for(var r=0;r<i.length;r++){var o=i[r];var a=s*o.lat();var f=s*o.lng();var l=Math.cos(a);var h=[l*Math.cos(f),l*Math.sin(f),Math.sin(a)];for(var p=0;p<3;p++)h[p]+=1e-10*(2*Math.random()-1);var d=0;for(var p=0;p<3;p++)d+=h[p]*h[p];var v=1/Math.sqrt(d);for(var p=0;p<3;p++)h[p]*=v;e.push(h)}var m=FindDelaunayTriangulation(e);for(var r=0;r<m.edges.length;r++){var g=m.edges[r];c.Add_GMapLine(u,m.positions,g.verts,t.color||"#578b8b",2,1,n)}};h();markers=[];for(var l=0;l<i.length;l++){var p=new google.maps.Marker({position:i[l],map:n,draggable:true});markers[l]=p}var d=function(){for(var e=0;e<i.length;e++){if(markers[e].position!=i[e]){i[e]=this.position;break}}h()};for(var l=0;l<i.length;l++){google.maps.event.addListener(markers[l],"drag",d)}};CityDashboard.Delaunay.prototype=Object.create(CityDashboard.DTesselation.prototype);CityDashboard.Delaunay.prototype={constructor:CityDashboard.Delaunay,build:function(){},addEvents:function(){},Add_GMapLine:function(e,t,n,r,i,s,o){var u=180/Math.PI;if(n.length<2)return;var a=t[n[0]];var f=[a];for(var l=1;l<n.length;l++){var c=t[n[l]];f=f.concat(this.SplitSegment(a,c),[c]);a=c}var h=[];for(var p=0;p<f.length;p++){var c=f[p];var d=u*Math.atan2(c[2],Math.sqrt(c[0]*c[0]+c[1]*c[1]));var v=u*Math.atan2(c[1],c[0]);h.push(new google.maps.LatLng(d,v))}var m=new google.maps.Polyline({path:h,strokeColor:r,strokeWeight:i,strokeOpacity:s,clickable:false});m.setMap(o);e.push(m)},SplitSegment:function(e,t){var n=0;for(var r=0;r<3;r++){var i=t[r]-e[r];n+=i*i}var s=[];if(n<.01)return s;var o=new Array(3);for(var r=0;r<3;r++)o[r]=e[r]+t[r];var u=0;for(var r=0;r<3;r++){pc=o[r];u+=pc*pc}var a=1/Math.sqrt(u);for(var r=0;r<3;r++)o[r]*=a;return s.concat(this.SplitSegment(e,o),[o],this.SplitSegment(o,t))},ClearOvlyArray:function(e){while(e.length>0){var t=e.pop();t.setMap(null)}}};CityDashboard.Layer=function(e,t){this.wrappedLayer=undefined;if(e.id===undefined){throw Error("All layers must have an ID.")}this.id=e.id;this.dataSource=e.dataSource;this.elements=e.data.length?e.data:[e.data];this.elementsAttr=e.layer_attr||{type:"simple",action:"update"};this.map=t};CityDashboard.Layer.prototype={constructor:CityDashboard.Layer,filter:function(e){},clear:function(){}};CityDashboard.MarkerLayer=function(e,t){CityDashboard.Layer.call(this,e,t);this.markers=[];for(var n=this.elements.length-1;n>=0;n--){var r=MarkerSelector(this.elements[n],this.elementsAttr,this.map,this);this.markers.push(r);r.addEvents()}this.markers[0].triggerInitialEvent()};CityDashboard.MarkerLayer.prototype=Object.create(CityDashboard.Layer.prototype);CityDashboard.MarkerLayer.prototype={constructor:CityDashboard.MarkerLayer,filter:function(e){for(i=0;i<this.markers.length;i++){if(!e(this.markers[i].layer_params))this.markers[i].marker.setVisible(false);else this.markers[i].marker.setVisible(true)}for(i=0;i<this.markers.length;i++){if(this.markers[i].marker.getVisible()){this.markers[i].triggerInitialEvent();break}}},clear:function(){for(var e=0;e<this.markers.length;e++){this.markers[e].marker.setMap(null)}}};CityDashboard.GridLayer=function(e,t){CityDashboard.Layer.call(this,e,t);this.grid=GridSelector(this.elements[0],this.elementsAttr,this.map,this);this.grid.addEvents()};CityDashboard.GridLayer.prototype=Object.create(CityDashboard.Layer.prototype);CityDashboard.GridLayer.prototype={constructor:CityDashboard.GridLayer,clear:function(){for(var e=0;e<this.grid.tiles.length;e++){this.grid.tiles[e].setMap(null)}}};CityDashboard.HeatmapLayer=function(e,t){CityDashboard.Layer.call(this,e,t);this.heatmap=new HeatmapSelector(this.elements[0],this.elementsAttr,this.map,this)};CityDashboard.HeatmapLayer.prototype=Object.create(CityDashboard.Layer.prototype);CityDashboard.HeatmapLayer.prototype={constructor:CityDashboard.HeatmapLayer,clear:function(){this.heatmap.heatmap.setMap(null)}};CityDashboard.DelaunayLayer=function(e,t){CityDashboard.Layer.call(this,e,t);var n=DTesselationSelector(this.elements[0],this.elementsAttr,this.map,this);n.addEvents()};CityDashboard.DelaunayLayer.prototype=Object.create(CityDashboard.Layer.prototype);CityDashboard.DelaunayLayer.prototype={constructor:CityDashboard.DelaunayLayer,clear:function(){}};CityDashboard.Visualization=function(e){var t,n,r,i;this.id=e["id"];this.data_source=e["data-source"]||this.id;this.properties=e["properties"]||{};this.title=e["title"]||"";this.dataPreprocess=e["preprocess"]||function(e){return e};this.setData(e["data"]||{});var r=$("<h4>").append(this.title).addClass("viz-title");var s=this;this.viz=$("<div>").setID(this.id).addClass("visualization").append(r).append($("<hr>").addClass("viz-bar"));if(this.properties["closable"]===undefined||this.properties["closable"]){this.viz.closable(function(){return s.remove()})}if(this.properties["movable"]===undefined||this.properties["movable"]){this.viz.movable()}this.viz.append($("<h6>").addClass("latlngView"));$(CityDashboard["infoWindowID"]).append(this.viz);this.viz.css(this.properties);this.checkbox_handler=e["checkbox-handler"]||function(e,t){return t};if(e.checkbox)this.addCheckbox(e["checkbox"])};CityDashboard.Visualization.prototype={constructor:CityDashboard.Visualization,setData:function(e){if(!(e instanceof Array))e=jQuery.extend({},e);if(!e||Object.keys(e).length===0)this.data={};else this.data=this.dataPreprocess(e)},getData:function(){return this.data},refresh:function(){var e=$(this.id).find(".latlngView").empty();this.viz.find(".deflist").remove();var t=this.getData();var n=t.lat,r=t.lng;if(n&&r)e.text("lat: "+n+", lng: "+r).insertAfter($(this.id).find("hr"))},remove:function(){$(CityDashboard["infoWindowID"]).trigger("remove-viz",{id:this.id,"data-source":this.data_source})},createDefList:function(e){var t=this.id;$.each(e,function(e,n){if(e!=="lat"&&e!=="lng"&&e!=="value"){$(t).find(".deflist").append($("<dt>").text(e).addClass("deflist-key")).append($("<dd>").text(n).addClass("deflist-value"))}})},addCheckbox:function(e){var t=$("<span>").addClass("checkbox-panel");var n=[];for(var r in e){var i=$("<input>").attr("type","checkbox");n[n.length]=i[0].checked=e[r];t.append(i);var s=this;i.on("change",function(){var e=$(this).parent().children("input:checkbox").map(function(){return $(this).prop("checked")}).get();s.getData=function(){var t=s.data;if(!(s.data instanceof Array))t=jQuery.extend({},s.data);return s.checkbox_handler(e,t)};s.refresh()});i.after($("<label>").text(r))}this.viz.append(t);s.getData=function(){var e=s.data;if(!(s.data instanceof Array))e=jQuery.extend({},s.data);return s.checkbox_handler(n,e)}}};CityDashboard.SummaryVisualization=function(e){CityDashboard.Visualization.call(this,e);this.viz.addClass("summary-viz");this.refresh()};CityDashboard.SummaryVisualization.prototype=Object.create(CityDashboard.Visualization.prototype);CityDashboard.SummaryVisualization.prototype.refresh=function(){CityDashboard.Visualization.prototype.refresh.call(this);this.viz.append($("<dl>").addClass("deflist"));this.createDefList(this.data)};CityDashboard.GeneralVisualization=function(e){CityDashboard.Visualization.call(this,e);this.viz.addClass("general-viz");this.dom=e["dom"];this.refresh()};CityDashboard.GeneralVisualization.prototype=Object.create(CityDashboard.Visualization.prototype);CityDashboard.GeneralVisualization.prototype.refresh=function(){CityDashboard.Visualization.prototype.refresh.call(this);this.viz.append(this.dom)};CityDashboard.GeneralVisualization.prototype.remove=function(){CityDashboard.Visualization.prototype.remove.call(this)};CityDashboard.ChartistVisualization=function(e,t){CityDashboard.Visualization.call(this,e);this.chartConstructor=t;this.viz.addClass("chartist-viz").append($("<div>").addClass(this.properties["class"]));this.options=e["options"]||{};this.responsiveOptions=e["responsiveOptions"]||{};this.labels=e["labels"];this.refresh()};CityDashboard.ChartistVisualization.prototype=Object.create(CityDashboard.Visualization.prototype);CityDashboard.ChartistVisualization.prototype.refresh=function(){CityDashboard.Visualization.prototype.refresh.call(this);var e=this.getData();e=e.value||e;var t={series:e,labels:typeof this.labels==="function"?this.labels(e):this.labels};if(this.chart&&this.chart.optionsProvider){this.chart.update(t)}else this.chart=new this.chartConstructor(this.id+" > div",t,this.options,this.responsiveOptions);this.viz.append($("<dl>").addClass("deflist"));if(!(this.data instanceof Array))this.createDefList(this.data)};CityDashboard.ChartistVisualization.prototype.remove=function(){CityDashboard.Visualization.prototype.remove.call(this);this.chart.detach()};CityDashboard.D3Visualization=function(e){CityDashboard.Visualization.call(this,e);var t=$("<div>");this.viz.addClass("d3-viz").append(t);var n=.61803398875;var r=t.width();var i=n*r;this.svg=d3.select(this.id+" div").append("svg");if(e["golden-ratio"]){this._create=function(){arguments[1]=arguments[1].value||arguments[1];arguments[3]=t.width()*n;return e.viz.apply(e,arguments)}}else{this._create=function(){arguments[3]=i;arguments[1]=arguments[1].value||arguments[1];return e.viz.apply(e,arguments)}}CityDashboard.Visualization.prototype.refresh.call(this);this._create(this.svg,this.getData(),r,i)};CityDashboard.D3Visualization.prototype=Object.create(CityDashboard.Visualization.prototype);CityDashboard.D3Visualization.prototype.refresh=function(){CityDashboard.Visualization.prototype.refresh.call(this);this.svg.selectAll("*").remove();var e=this.getData();var t=$(this.id);this._create(this.svg,e,t.width(),t.height());this.viz.append($("<dl>").addClass("deflist"));if(!(e instanceof Array))this.createDefList(e)};CityDashboard.D3Visualization.prototype.remove=function(){CityDashboard.Visualization.prototype.remove.call(this);this.svg.remove()};CityDashboard.FilterBar=function(e){this.filters={none:function(e){return true}};this.filterNumber=e;this.bar=$("<div>").setID(CityDashboard["filterBarID"]).addClass("filterBar");var t=new google.maps.Geocoder;var n=function(){var e=$(CityDashboard["mainContainerID"])[0].data;var n=$(CityDashboard["filterBarID"]+" > .search").val();t.geocode({address:n},function(t,r){if(r==google.maps.GeocoderStatus.OK){e.setCenter(t[0].geometry.location);e.fitBounds(t[0].geometry.bounds)}else{$(CityDashboard["filterBarID"]+" > .search").val("not found: "+n)}})};$(CityDashboard["mainContainerID"]).append(this.bar);this.bar.append($("<input>").addClass("search").attr("type","search").on("change",n));var r=this;this.select=[];for(var i=0;i<this.filterNumber;i++){this.select[i]=$("<select>").on("change",function(){$(CityDashboard["mainContainerID"]).trigger("filterChanged",function(){return r.composeFilters()})});this.bar.append(this.select[i])}this.placeFilters()};CityDashboard.FilterBar.prototype={constructor:CityDashboard.FilterBar,addFilter:function(e){for(var t in e){this.filters[t]=e[t]}for(var n=this.select.length-1;n>=0;n--){this.select[n].empty()}this.placeFilters()},placeFilters:function(){var e=this;for(var t=0;t<this.filterNumber;t++){for(var n in this.filters){var r=$("<option>");r.val(function(){return e.filters[n]});r.text(n);this.select[t].append(r)}}},composeFilters:function(){var e=[];for(var t=this.select.length-1;t>=0;t--){e[e.length]=Function("return "+this.select[t].val())()}return function(t){for(var n=e.length-1;n>=0;n--){if(!e[n](t))return false}return true}}};CityDashboard.InfoWindow=function(e){e=e||[];this.visualizations={};this.dataSourceTable={};for(var t=0;t<e.length;t++){this.createVisualization(e[t])}var n=$(CityDashboard["infoWindowID"]);var r=this;var i=function(e,t){n.off("marker-pressed");if(t.attr.id&&!(t.attr.id in r.visualizations)){var s=jQuery.extend({},t["attr"]);s["data"]=t.value;s["data-source"]=t.id;r.createVisualization(s)}var o=r.dataSourceTable[t.id]||[];for(var u=o.length-1;u>=0;u--){o[u].setData(t.value);o[u].refresh()}n.on("marker-pressed",i)};n.on("marker-pressed",i);n.on("resize",function(e){for(var t in r.visualizations){r.visualizations[t].refresh()}});n.on("remove-viz",function(e,t){delete r.visualizations[t.id];var n=jQuery.inArray(r.dataSourceTable[t["data-source"]],t.id);r.dataSourceTable[t["data-source"]].splice(n,1)})};CityDashboard.InfoWindow.prototype={constructor:CityDashboard.InfoWindow,createVisualization:function(e){var t=this;var n=e.visualization;var r=function(e){var r;if(!n)return;else if(n==="summary-viz")r=new CityDashboard.SummaryVisualization(e);else if(n==="linechart-viz")r=new CityDashboard.ChartistVisualization(e,Chartist.Line);else if(n==="barchart-viz")r=new CityDashboard.ChartistVisualization(e,Chartist.Bar);else if(n==="piechart-viz")r=new CityDashboard.ChartistVisualization(e,Chartist.Pie);else if(n==="d3-viz")r=new CityDashboard.D3Visualization(e);else if(n==="general-viz")r=new CityDashboard.GeneralVisualization(e);t.visualizations[r.id]=r;t.dataSourceTable[r.data_source]=t.dataSourceTable[r.data_source]||[];t.dataSourceTable[r.data_source].push(r);return r};return CityDashboard.getData(e["data-source"],r,e)}};CityDashboard.Dashboard=function(e){this.layers=[];if(!e.anchor)throw new Error("Anchor ID is required.");this.anchor=e.anchor;this.layout="layout-"+(e.layout||"none");var t=$("<div>").setID(CityDashboard["mainContainerID"]).addClass("mainDashboard").addClass(this.layout);var n;if(this.layout!=="layout-none"){n=$("<div>").setID(CityDashboard["infoWindowID"]).addClass("infoWindow");var r;if(this.layout==="layout-left")r="e";else if(this.layout==="layout-right")r="w";n.resizable(r);t.append(n)}var i=$("<div>").setID(CityDashboard["mapWindowID"]).addClass("mapWindow");t.append(i);$(this.anchor).append(t);this.filters=new CityDashboard.FilterBar(e["filter-number"]||0);var s=this.layers;t.on("filterChanged",function(e,t){var n=t();for(var r=s.length-1;r>=0;r--){s[r].filter(n)}})};CityDashboard.Dashboard.prototype={constructor:CityDashboard.Dashboard,addLayer:function(e){var t=this.layers;var n=function(e){t[t.length]=LayerSelector(e,$(CityDashboard["mainContainerID"])[0].data)};CityDashboard.getData(e["data-source"],n,e);return this},addFilter:function(e){this.filters.addFilter(e);return this},clear:function(){for(var e=0;e<this.layers.length;e++){this.layers[e].clear()}this.layers=[]}}