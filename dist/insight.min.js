var niclabs={};niclabs.insight=function(e){"use strict";e.fn.template=function(t){"undefined"==typeof t?t=this.html():"string"==typeof t&&"#"===t.charAt(0)&&(t=e(t).html());var n=this;return this.bind("render",function(r,i){n.empty().append(t),n.find("[data-bind],[data-if]").each(function(){var t=e(this).attr("data-bind")||e(this).attr("data-if"),n=e(this).prop("tagName");t in i?e(this).attr("data-bind")&&("img"===n?e(this).attr("src",i[t]):"input"===n?e(this).val(i[t]):e(this).text(i[t])):e(this).detach()})}),this},e.fn.resizable=function(t){function n(t){o=t.clientX,s=t.clientY,l=h.outerWidth(),c=h.outerHeight(),e(document).on("mousemove",r),e(document).on("mouseup",i)}function r(e){f&&h.css("height",c+e.clientY-s+"px"),u&&h.css("width",l+e.clientX-o+"px"),d&&h.css("top",e.clientY+"px").css("height",c+s-e.clientY+"px"),g&&h.css("left",e.clientX+"px").css("width",l-e.clientX+"px")}function i(){e(document).off("mousemove",r),e(document).off("mouseup",i),h.trigger("resize")}var a=e("<div>").addClass("resizer").addClass(t+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",n);var o,s,l,c,u,f,d,g,h=this;return f=t.search("s")>=0,u=t.search("e")>=0,d=t.search("n")>=0,g=t.search("w")>=0,this.scroll(function(){a.css("top",h.scrollTop())}),this},e.fn.setID=function(e){return"#"===e.charAt(0)&&(e=e.slice(1)),this.attr("id",e),this},e.fn.movable=function(){var t=this.children(".header");0===t.length&&(t=e("<div>").addClass("header"),this.prepend(t));var n=e("<span>").addClass("button").attr("data-icon","up-arrow"),r=e("<span>").addClass("button").attr("data-icon","down-arrow");t.append(n),t.append(r);var i=this;return n.on("click",function(){i.insertBefore(i.prev())}),r.on("click",function(){i.insertAfter(i.next())}),this},e.fn.closable=function(t){t||(t=function(){});var n=this.children(".header");n.length||(n=e("<span>").addClass("header"),this.prepend(n));var r=e("<span>").addClass("button").attr("data-icon","close");n.prepend(r);var i=this;return r.on("click",function(){i.remove(),t()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(t,n){return e.inArray(t,this,n)},Object.size=function(e){var t,n=0;for(t in e)e.hasOwnProperty(t)&&n++;return n},Object.prototype.watch||Object.defineProperty(Object.prototype,"watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,t){var n=this[e],r=function(){return n},i=function(r){return n===r?!1:(t.call(this,e,n,r),void(n=r))};delete this[e]&&Object.defineProperty(this,e,{get:r,set:i,enumerable:!0,configurable:!0})}}),Object.prototype.unwatch||Object.defineProperty(Object.prototype,"unwatch",{enumerable:!1,configurable:!0,writable:!1,value:function(e){var t=this[e];delete this[e],this[e]=t}}),Object.prototype.spy||Object.defineProperty(Object.prototype,"spy",{enumerable:!1,configurable:!0,writable:!1,value:function(e){for(var t in this)this.hasOwnProperty(t)&&this.watch(t,e)}}),Object.prototype.unspy||Object.defineProperty(Object.prototype,"unspy",{enumerable:!1,configurable:!0,writable:!1,value:function(){for(var e in this)this.hasOwnProperty(e)&&this.unwatch(e)}});var t,n={};return{handler:function(e,t,r){if(e in n){if(t="undefined"==typeof t?n[e].kind:t,r="undefined"==typeof r?n[e].handler:r,t!==n[e].kind)throw new Error("There already exists a handler with name "+e+" for kind "+n[e].kind)}else if("undefined"==typeof t&&"undefined"==typeof r)throw new Error("Handler "+e+" does not exist");return n[e]={kind:t,handler:r},r},dashboard:function(e){return"undefined"==typeof e?t:t=niclabs.insight.Dashboard(e)}}}(jQuery),niclabs.insight.Color=function(){function e(e,t,n){e/=255,t/=255,n/=255;var r,i,a=Math.max(e,t,n),o=Math.min(e,t,n),s=a,l=a-o;if(i=0===a?0:l/a,a==o)r=0;else{switch(a){case e:r=(t-n)/l+(n>t?6:0);break;case t:r=(n-e)/l+2;break;case n:r=(e-t)/l+4}r/=6}return[r,i,s]}function t(e,t,n){var r,i,a,o=Math.floor(6*e),s=6*e-o,l=n*(1-t),c=n*(1-s*t),u=n*(1-(1-s)*t);switch(o%6){case 0:r=n,i=u,a=l;break;case 1:r=c,i=n,a=l;break;case 2:r=l,i=n,a=u;break;case 3:r=l,i=c,a=n;break;case 4:r=u,i=l,a=n;break;case 5:r=n,i=l,a=c}return[255*r,255*i,255*a]}function n(e){e=Math.floor(e);var t=e.toString(16);return 1==t.length?"0"+t:t}function r(e){return"#"+n(e[0])+n(e[1])+n(e[2])}function i(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]:null}return{rgbToHsv:e,hsvToRgb:t,rgbToHex:r,hexToRgb:i}}(),niclabs.insight.Dashboard=function(e){"use strict";return function(t){function n(e){return e="undefined"==typeof e?c++:e,"layer"+e}var r=["left","right","none"],i="#insight-dashboard";if(!("anchor"in t))throw new Error("Anchor id is required for creating a dashboard");var a=t.anchor;if(t.layout=t.layout||"none",r.indexOf(t.layout)<0)throw new Error("Layout must be one of '"+r.join("','")+"'");var o=e("<div>").setID(i).addClass("insight").addClass(t.layout);e(a).append(o);var s,l={},c=0,u={},f={};niclabs.insight.event.on("layer_data",function(e){s&&e.id===s.id&&niclabs.insight.event.trigger("active_layer_data",e)});var d={get element(){return e(i)[0]},get $(){return e(i)},config:function(e){return t[e]},info:function(t){return"undefined"!=typeof t&&(u="handler"in t?niclabs.insight.handler(t.handler)(d,t):t,e(i).append(u.element)),u},map:function(t){return"undefined"!=typeof t&&(f="handler"in t?niclabs.insight.handler(t.handler)(d,t):t,e(i).append(f.element)),f},layer:function(e,t){if("string"==typeof e)return l[e];if("number"==typeof e)return l[n(e)];var r,i;return"handler"in e?(i=e.id=e.id||n(),r=niclabs.insight.handler(e.handler)(d,e)):(r=e,i=r.id),l[i]=r,(t||1===Object.size(l))&&d.active(i),r},data:function(e){return s?s.data(e):[]},active:function(e){if("undefined"==typeof e)return"undefined"!=typeof s?s.id:void 0;if("undefined"!=typeof s&&s.clear(),"number"==typeof e&&(e=n(e)),!(e in l))throw new Error("Layer with id "+e+" does not exist");return s=l[e],s.load(),s},filter:function(e){return g.filter(e)},clear:function(){s&&s.clear()}},g=niclabs.insight.FilterBar(d);return o.append(g.element),niclabs.insight.event.on("filter_changed",function(t){e.each(l,function(e,n){n.filter(t)})}),d}}(jQuery),niclabs.insight.ElementList=function(){var e=function(e){function t(e){return e="undefined"==typeof e?i++:e,"__"+e}var n={},r={},i=0;return n.element=function(n){if("string"==typeof n)return r[n];if("number"==typeof n)return r[t(n)];var i,a;return"handler"in n?(a=n.id=n.id||t(),i=niclabs.insight.handler(n.handler)(e,n)):(i=n,a=i.id),r[a]=i,i},n.each=function(e){for(var t in r)e(t,r[t])},n.remove=function(e){if("number"==typeof obj&&(e=t(e)),e in r){var n=r[e];return delete r[e],n}},n};return e}(),niclabs.insight.Element=function(){var e=function(e){if(!("id"in e))throw Error("All UI elements must define an identifier");var t=e.id;if(!/^[^#. '"]+$/.test(t))throw Error("The UI element id must be at least 1 character long and cannot contain the following characters ['#','.',' ', ''', '\"'])");return{get id(){return t}}};return e}(jQuery),niclabs.insight.FilterBar=function(e){"use strict";return function(t){function n(){for(var e=[],t=0;t<a.length;t++)a[t].element.prop("selectedIndex")>0&&e.push(a[t].options[a[t].element.prop("selectedIndex")-1].filter);return function(t){for(var n=0;n<e.length;n++)if(!e[n](t))return!1;return!0}}var r="#insight-filters",i=e("<div>").setID(r).addClass("filters"),a=[],o=new google.maps.Geocoder,s=e("<input>").addClass("search").attr("type","search").attr("placeholder","Enter location");i.append(e("<div>").addClass("filter").append(s));var l=function(){var e=t.map().googlemap(),n=s.val();o.geocode({address:n},function(t,r){r==google.maps.GeocoderStatus.OK?(e.setCenter(t[0].geometry.location),e.fitBounds(t[0].geometry.bounds)):s.val("not found: "+n)})};return s.on("change",l),{get element(){var t=e(r);return i=0===t.length?i:t,i[0]},$:function(){var t=e(r);return i=0===t.length?i:t},filter:function(t){if("number"==typeof t)return a[t];var r=e("<select>"),o=t.description||"",s=e("<option>").text(o);r.append(s);var l;for(l=0;l<t.options.length;l++)s=e("<option>").text(t.options[l].name),r.append(s);return r.on("change",function(){niclabs.insight.event.trigger("filter_changed",n())}),i.append(e("<div>").addClass("filter").append(r)),t.element=r,a.push(t),r}}}}(jQuery),niclabs.insight.InfoView=function(){"use strict";var e=function(e,t){t=t||{};var n=t.id||"insight-info-view",r=niclabs.insight.UiElement({id:n});if(r.$.addClass("info"),"none"!==e.config("layout")){var i;"left"===e.config("layout")?i="e":"right"===e.config("layout")&&(i="w"),r.$.resizable(i)}var a=niclabs.insight.ElementList(e);r.block=function(e){var t=a.element(e);return r.$.append(t.element),t};var o;if(t.blocks)for(o=0;o<t.blocks.length;o++)r.block(t.blocks[o]);return r.$.on("resize",function(){a.each(function(e,t){t.refresh()})}),niclabs.insight.event.on("remove-block",function(e){a.remove(e.id)}),r};return niclabs.insight.handler("basic-info-view","info-view",e),e}(jQuery),niclabs.insight.Interpolation=function(){function e(e,t,n,r){return n+(r-n)*e/t}function t(t,n,r,i){var a=e(t,n,r[0],i[0]),o=e(t,n,r[1],i[1]),s=e(t,n,r[2],i[2]);return[a,o,s]}function n(e,n,r,i){var a=niclabs.insight.Color.rgbToHsv(r[0],r[1],r[2]),o=niclabs.insight.Color.rgbToHsv(i[0],i[1],i[2]),s=t(e,n,a,o);return niclabs.insight.Color.hsvToRgb(s[0],s[1],s[2])}return{interpolate:e,interpolate3d:t,interpolateRgb:n}}(),niclabs.insight.MapView=function(e){"use strict";return function(t){var n="#insight-map-view",r={lat:t.lat||0,lng:t.lng||0},i=t.zoom||12,a=e("<div>").setID(n).addClass("map"),o={get element(){var t=e(n);return a=0===t.length?a:t,a[0]},get $(){var t=e(n);return a=0===t.length?a:t},center:function(e,t){return r.lat=e="undefined"==typeof e?r.lat:e,r.lng=t="undefined"==typeof t?r.lng:t,r},get lat(){return r.lat},get lng(){return r.lng},get width(){return o.$.width()},get height(){return o.$.height()},zoom:function(e){return i=e="undefined"==typeof e?i:e}};return o}}(jQuery),niclabs.insight.UiElement=function(e){var t=function(t){var n=niclabs.insight.Element(t),r=e("<div>").attr("id",n.id);return Object.defineProperty(n,"$",{get:function(){var t=e("#"+n.id);return r=0===t.length?r:t}}),Object.defineProperty(n,"element",{get:function(){return n.$[0]}}),n.append=function(e){return n.$.append(e.$),n},n};return t}(jQuery),niclabs.insight.event=function(){"use strict";function e(e,n){if(e in t)for(var r=0;r<t[e].length;r++)if(t[e][r]===n)return r;return-1}var t={};return{on:function(n,r){var i=e(n,r);return 0>i?(n in t||(t[n]=[]),t[n].push(r)-1):i},off:function(n,r){var i="number"==typeof r?r:e(n,r);return i>=0?(t[n].splice(i,1),!0):!1},trigger:function(e,n){if(e in t)for(var r=0;r<t[e].length;r++)t[e][r](n)}}}(),niclabs.insight.info=function(){var e=function(e){var t=niclabs.insight.dashboard();if("undefined"==typeof t)throw new Error("Dashboard has not been initialized");return t.info(e)};return e}(),niclabs.insight.info.Block=function(e){"use strict";var t=function(t,n){function r(){niclabs.insight.event.trigger("remove-block",{id:o})}function i(e,t){h=niclabs.insight.event.on("map_element_selected",function(n){t&&n.layer!==t||e.refresh(e.__data__(n))}),p=niclabs.insight.event.on("layer_summary",function(n){t&&n.id!==t||e.refresh(e.__data__(n.data))})}function a(){niclabs.insight.event.off("map_element_selected",h),niclabs.insight.event.off("layer_summary",p)}if(!("id"in n))throw new Error("All information blocks must have an id");var o=n.id,s="#"===o.charAt(0)?o:"#"+o,l=n.title||"",c={closable:"undefined"==typeof n.closable?!0:n.closable,movable:"undefined"==typeof n.movable?!0:n.movable},u=n.preprocess||function(e){return e},f=e("<div>").addClass("header").append(e("<span>").attr("data-bind","title").addClass("title").append(l)),d=e("<div>").setID(s).addClass("block").append(f),g=e("<div>").addClass("content");d.append(g),c.closable&&d.closable(function(){r()}),c.movable&&d.movable(),d.css(c);var h,p,b,m={},y={get id(){return o},get element(){var t=e(s);return d=0===t.length?d:t,d[0]},get $(){var t=e(s);return d=0===t.length?d:t},get layer(){return b},get content(){var t=e(s).find(".content");return g=0===t.length?g:t},title:function(e){return"undefined"!=typeof e&&(l=e,y.$.find(".title").text(e)),l},__data__:function(e){return"undefined"==typeof e?m:m=0===Object.keys(e).length?{}:u(e)},remove:r,data:function(t){return"undefined"==typeof t?m:(b=void 0,a(y),"string"==typeof t?"#"===t.charAt(0)?(b=t.substring(1),m=n.defaults||{},i(y,b),m):(e.getJSON(t,y.__data__),t):y.__data__("function"==typeof t?t.call(y):t))},refresh:function(){}};return"data"in n?y.data(n.data):(i(y),m=n.defaults||{}),y};return t}(jQuery),niclabs.insight.info.ChartistBlock=function(e){var t=function(t,n,r){var i=niclabs.insight.info.Block(t,r),a=r.chartist;i.content.addClass("chartist-viz").append(e("<div>").addClass(a["class"]));var o,s=a.options||{},l=a.responsiveOptions||{},c=a.labels,u=i.refresh;i.refresh=function(e){e="undefined"==typeof e?i.data():e,u(e),e=e.value||e;var t={series:e,labels:"function"==typeof c?c(e):c};o&&o.optionsProvider?o.update(t):o=new n(i.content.find("div")[0],t,s,l)};var f=i.remove;return i.remove=function(){f(),o.detach()},i.refresh(),i},n=function(e,n){var r=t(e,Chartist.Line,n);return r},r=function(e,n){var r=t(e,Chartist.Bar,n);return r},i=function(e,n){var r=t(e,Chartist.Pie,n);return r};return niclabs.insight.handler("chartist-linechart","info-block",n),niclabs.insight.handler("chartist-barchart","info-block",r),niclabs.insight.handler("chartist-piechart","info-block",i),t}(jQuery),niclabs.insight.info.SummaryBlock=function(){var e=function(e,t){var n=niclabs.insight.info.Block(e,t),r=t.template||'        <h6 class="latLngView" data-if="lat">             lat: <span data-bind="lat"> -- </span>             lng: <span data-bind="lng"> -- </span>         </h6>        <dl class="deflist">            <dt class="deflist-key" data-if="description">description</dt>             <dd class="deflist-value" data-bind="description">none</dd>             <dt class="deflist-key" data-if="landmark">landmark</dt>             <dd class="deflist-value" data-bind="landmark">none</dd>             <dt class="deflist-key" data-if="fun-fact">fun-fact</dt>             <dd class="deflist-value" data-bind="fun-fact">none</dd>         </dl>        ';n.content.template(r);var i=n.refresh;return n.refresh=function(e){e="undefined"!=typeof e?e:n.data(),i(e),n.content.trigger("render",e)},n.refresh(),n};return niclabs.insight.handler("summary-block","info-block",e),e}(jQuery),niclabs.insight.layer=function(){var e=function(e,t){var n=niclabs.insight.dashboard();if("undefined"==typeof n)throw new Error("Dashboard has not been initialized");return n.layer(e,t)};return e}(),niclabs.insight.layer.GridLayer=function(){var e=function(e,t){function n(t,n){var r;if("type"in n){var a={layer:i.id,data:t};$.extend(a,n),r=niclabs.insight.handler(n.type)(e,a)}else r=n;return r}var r,i=niclabs.insight.layer.Layer(e,t),a=t.grid||{type:"hexagon"};return i.draw=function(e){r=n(e,a)},i.clear=function(){r&&r.clear()},i.filter=function(){},i};return niclabs.insight.handler("grid-layer","layer",e),e}(),niclabs.insight.layer.HeatmapLayer=function(e){var t=function(t,n){function r(n,r){var i;if("type"in r){var o={layer:a.id,data:n};e.extend(o,r),i=niclabs.insight.handler(r.type)(t,o)}else i=r;return i}var i,a=niclabs.insight.layer.Layer(t,n),o=n.heatmap||{type:"point-heatmap"};return a.draw=function(e){i=r(e,o)},a.clear=function(){i&&i.clear()},a.filter=function(){},a};return niclabs.insight.handler("heatmap-layer","layer",t),t}(jQuery),niclabs.insight.layer.Layer=function(e){"use strict";var t=function(t,n){if(!("id"in n))throw Error("All layers must have an id.");var r=n.id;if(!("data"in n))throw Error("All layers must provide a data source.");var i=!1,a=[];"string"==typeof n.data?i=n.data:a=n.data&&Array.isArray(n.data)?n.data:[n.data];var o=n.summary||!1,s=!1,l={get id(){return r},data:function(e){return"undefined"==typeof e?s||!i?a:i:"string"==typeof e?(i=e,s&&l.load(),i):a=e.length?e:[e]},load:function(){function t(e){if(a=e,niclabs.insight.event.trigger("layer_data",{id:r,data:a}),l.clear(),o){var t=o;"function"==typeof o&&(t=o(a)),niclabs.insight.event.trigger("layer_summary",{id:r,data:t})}l.draw(a)}i?e.getJSON(i,t):t(a)},draw:function(){},filter:function(){},clear:function(){}};return l};return t}(jQuery),niclabs.insight.layer.MarkerLayer=function(e){var t=function(t,n){function r(n,r,a){var o;if("type"in a){var s={layer:i.id};e.extend(s,a,n[r]),o=niclabs.insight.handler(a.type)(t,s)}else o=a;return o.clickable(!0),o}var i=niclabs.insight.layer.Layer(t,n),a=n.marker||{type:"simple-marker"},o=[];return i.draw=function(e){for(var t=0;t<e.length;t++)o.push(r(e,t,a))},i.clear=function(){for(var e=0;e<o.length;e++)o[e].clear()},i.filter=function(e){for(var t=i.data(),n=0;n<o.length;n++)o[n].visible(e(t[n]))},i};return niclabs.insight.handler("marker-layer","layer",t),t}(jQuery),niclabs.insight.map=function(){"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),"undefined"==typeof Number.prototype.toDeg&&(Number.prototype.toDeg=function(){return 180*this/Math.PI});var e=function(e){var t=niclabs.insight.dashboard();if("undefined"==typeof t)throw new Error("Dashboard has not been initialized");return t.map(e)};return e}(),niclabs.insight.map.GoogleMercator=function(){function e(e,t,n){return null!==t&&(e=Math.max(e,t)),null!==n&&(e=Math.min(e,n)),e}var t=256,n={x:t/2,y:t/2},r=t/360,i=t/(2*Math.PI);return{geographic:function(e){var t=(e.x-n.x)/r,a=(e.y-n.y)/-i,o=(2*Math.atan(Math.exp(a))-Math.PI/2).toDeg();return{lat:o,lng:t}},cartesian:function(t){"function"==typeof t.lat&&"function"==typeof t.lng&&(t={lat:t.lat(),lng:t.lng()});var a=n.x+t.lng*r,o=e(Math.sin(t.lat.toRad()),-.9999,.9999),s=n.y+.5*Math.log((1+o)/(1-o))*-i;return{x:a,y:s}},distance:function(e,t){return t="undefined"!=typeof t?t:12,e/(1<<t)}}}(),niclabs.insight.map.GoogleMap=function(){"use strict";var e=function(e,t){var n=niclabs.insight.MapView(t),r=new google.maps.Map(n.element,{zoom:n.zoom(),center:new google.maps.LatLng(n.lat,n.lng),disableDefaultUI:!0}),i=n.zoom;google.maps.event.addListener(r,"zoom_changed",function(){i(r.getZoom())}),n.zoom=function(e){return e=i(e),r.setZoom(e),e};var a=n.center;return google.maps.event.addListener(r,"center_changed",function(){var e=r.getCenter();a(e.lat(),e.lng())}),n.center=function(e,t){var n=a(e,t);return r.setCenter({lat:n.lat,lng:n.lng}),n},n.googlemap=function(){return r},n};return niclabs.insight.handler("google-map","map-view",e),e}(jQuery),niclabs.insight.quadtree={},niclabs.insight.quadtree.Bounds=function(){var e=function(e,t){var n={x:(e.x+t.x)/2,y:(e.y+t.y)/2};return{get center(){return n},get min(){return e},get max(){return t},contains:function(n){return e.x<=n.x&&n.x<t.x&&e.y<=n.y&&n.y<t.y},intersects:function(n){return t.x<n.min.x?!1:e.x>n.max.x?!1:t.y<n.min.y?!1:e.y>n.max.y?!1:!0}}};return e}(),niclabs.insight.quadtree.PointQuadTree=function(){var e=function(t,n,r){function i(){a=e(niclabs.insight.quadtree.Bounds(t.min,t.center),n,r-1),o=e(niclabs.insight.quadtree.Bounds({x:t.center.x,y:t.min.y},{x:t.max.x,y:t.center.y}),n,r-1),s=e(niclabs.insight.quadtree.Bounds({x:t.min.x,y:t.center.y},{x:t.center.x,y:t.max.y}),n,r-1),l=e(niclabs.insight.quadtree.Bounds(t.center,t.max,n,r-1))}n=n||50,r=r||40;var a,o,s,l,c=[],u={get capacity(){return n},get bounds(){return t},insert:function(e){return t.contains(e)?c.length<n||0>=r?(c.push(e),!0):(void 0===a&&i(),a.insert(e)?!0:o.insert(e)?!0:s.insert(e)?!0:l.insert(e)?!0:!1):!1},query:function(e,n){if(n="undefined"==typeof n?[]:n,!t.intersects(e))return n;for(var r=0;r<c.length;r++)e.contains(c[r])&&n.push(c[r]);return void 0===a?n:(a.query(e,n),o.query(e,n),s.query(e,n),l.query(e,n),n)}};return u};return e}(),niclabs.insight.map.grid={},niclabs.insight.map.grid.Grid=function(){var e=function(e,t){if(!("layer"in t))throw new Error("The grid must be associated to a layer");var n;if(!(n=e.layer(t.layer)))throw new Error("The layer "+n+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Grids are only supported for Google Maps at the moment");var i={get map(){return r},get layer(){return n},clear:function(){}};return i};return e}(),niclabs.insight.map.grid.HexagonalGrid=function(){function e(e,t){return function(n){var r=0,a=0;for(i=0;i<n.length;i++)"weight"in n[i]&&(r+=n[i].weight,a++);return a>0?(r/=a,niclabs.insight.Color.rgbToHex(niclabs.insight.Interpolation.interpolateRgb(r,1,e,t))):"#ffffff"}}function t(e,t){function n(e,t,n){for(var r,i=Math.floor((t+n)/2);n>=t;){for(;e[t].weight<e[i].weight;)t++;for(;e[n].weight>e[i].weight;)n--;n>=t&&(r=e[t],e[t]=e[n],e[n]=r,t++,n--)}return i}return e=niclabs.insight.Color.hexToRgb(e),t=niclabs.insight.Color.hexToRgb(t),function(r){var i=0,a=0,o=r.length>0?r.length-1:0,s=Math.floor((a+o)/2);for(i=n(r,a,o);i!==s;)i=s>i?n(r,s,o):n(r,a,s);return niclabs.insight.Color.rgbToHex(niclabs.insight.Interpolation.interpolateRgb(r[i].weight,1,e,t))}}var n=function(e){function t(t){t.lat&&(t=niclabs.insight.map.GoogleMercator.cartesian(t));var i=[];return i[0]={x:t.x,y:t.y},i[1]={x:t.x+n,y:t.y+r},i[2]={x:t.x+n,y:t.y+e+r},i[3]={x:t.x,y:t.y+e+r+r},i[4]={x:t.x-n,y:t.y+e+r},i[5]={x:t.x-n,y:t.y+r},i}var n=Math.cos(Math.PI/6)*e,r=Math.sin(Math.PI/6)*e,i={get s(){return e},get r(){return n},get h(){return r},coordinates:function(){var t,i;1==arguments.length?(t=arguments[0][0],i=arguments[0][1]):(t=arguments[0],i=arguments[1]);var a=2*t*n+(1&i)*n+n,o=i*(r+e);return{x:a,y:o}},tile:function(t){t.lat&&(t=niclabs.insight.map.GoogleMercator.cartesian(t));var i=Math.floor(t.x/(2*n)),a=Math.floor(t.y/(r+e)),o=t.x-2*i*n,s=t.y-a*(r+e),l=0===(1&a),c=i,u=a;return l?n>=o&&-r/n*o+r>s?(c=i-1,u=a-1):o>n&&r/n*o-r>s&&(c=i,u=a-1):n>=o?r/n*o>s?(c=i,u=a-1):(c=i-1,u=a):o>n&&-r/n*o+2*r>s&&(c=i,u=a-1),[c,u]},draw:function(e,n,r){if(!("googlemap"in n))throw new Error("Sorry, I only know how to draw on Google Maps at the moment");for(var i,a=t(e),o=[],s=0;s<a.length;s++)o.push(niclabs.insight.map.GoogleMercator.geographic(a[s]));return r=r||{strokeColor:"#000000",strokeOpacity:.6,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.6},r.paths=o,r.geodesic=!0,i=new google.maps.Polygon(r),i.setMap(n.googlemap()),i}};return i},r=function(r,i){function a(){return"#ffffff"}function o(e){return function(){niclabs.insight.event.trigger("map_element_selected",e)}}function s(e){if(e){for(var t,r,a=n(niclabs.insight.map.GoogleMercator.distance(i.size,l.map.zoom())),s=g.query(niclabs.insight.quadtree.Bounds(niclabs.insight.map.GoogleMercator.cartesian({lat:e.getNorthEast().lat(),lng:e.getSouthWest().lng()}),niclabs.insight.map.GoogleMercator.cartesian({lat:e.getSouthWest().lat(),lng:e.getNorthEast().lng()}))),d=[],h=0;h<s.length;h++){var p=a.tile(s[h]);t=p[0],r=p[1],d[t]||(d[t]=[]),d[t][r]||(d[t][r]=[]),d[t][r].push(s[h])}c=[];for(t in d)for(r in d[t]){u.fillColor=f(d[t][r]);var b=a.draw(a.coordinates(t,r),l.map,u);google.maps.event.addListener(b,"click",o(d[t][r])),c.push(b)}}}var l=niclabs.insight.map.grid.Grid(r,i),c=[],u={strokeColor:"strokeColor"in i?i.strokeColor:"#000000",strokeOpacity:"strokeOpacity"in i?i.strokeOpacity:.6,strokeWeight:"strokeWeight"in i?i.strokeWeight:2,fillOpacity:"fillOpacity"in i?i.fillOpacity:.6},f=i.fill||a;"string"==typeof f&&(f="#"===i.fill.charAt(0)?function(){return i.fill}:"average"===i.fill?e(i.fillStart||"#ff0000",i.fillEnd||"#00ff00"):"median"===i.fill?t(i.fillStart||"#ff0000",i.fillEnd||"#00ff00"):a);for(var d=niclabs.insight.quadtree.Bounds(niclabs.insight.map.GoogleMercator.cartesian({lat:90,lng:-180}),niclabs.insight.map.GoogleMercator.cartesian({lat:-90,lng:180})),g=niclabs.insight.quadtree.PointQuadTree(d),h=0;h<i.data.length;h++){var p=niclabs.insight.map.GoogleMercator.cartesian(i.data[h]);i.data[h].x=p.x,i.data[h].y=p.y,g.insert(i.data[h])}return l.clear=function(){for(var e=0;e<c.length;e++)c[e].setMap(null)},google.maps.event.addListener(l.map.googlemap(),"bounds_changed",function(){var e=this.getBounds();window.setTimeout(function(){l.clear(),s(e)},50)}),s(l.map.googlemap().getBounds()),l};return niclabs.insight.handler("hexagon","grid",r),r}(),niclabs.insight.map.marker={},niclabs.insight.map.marker.CircleMarker=function(){var e=function(e,t){var n=niclabs.insight.map.marker.Marker(e,t),r=new google.maps.LatLng(parseFloat(t.lat),parseFloat(t.lng)),i=new google.maps.Circle({center:r,map:n.map.googlemap(),radius:t.radius||400,strokeColor:t.strokeColor||"#FF0000",strokeOpacity:t.strokeOpacity||.8,strokeWeight:t.strokeWeight||2,fillColor:t.fillColor||"#FF0000",fillOpacity:t.fillOpacity||.35,title:t.landmark||""});return n.marker=function(){return i},n};return niclabs.insight.handler("circle-marker","marker",e),e}(jQuery),niclabs.insight.map.marker.ImageMarker=function(){var e=function(e,t){var n=niclabs.insight.map.marker.Marker(e,t),r=new google.maps.LatLng(parseFloat(t.lat),parseFloat(t.lng));if(!("src"in t))throw new Error("An image source must be provided for using image markers");var i={url:t.src,scaledSize:new google.maps.Size(30,50)},a=new google.maps.Marker({position:r,map:n.map.googlemap(),icon:i,title:t.landmark||""});return n.marker=function(){return a},n};return niclabs.insight.handler("image-marker","marker",e),e}(jQuery),niclabs.insight.map.marker.Marker=function(){var e=function(e,t){if(!("layer"in t))throw new Error("The marker must be associated to a layer");var n;if(!(n=e.layer(t.layer)))throw new Error("The layer "+n+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Markers are only supported for Google Maps at the moment");var i,a={get map(){return r},get layer(){return n},marker:function(){return void 0},clickable:function(e){if(e){var n=a.marker();i=google.maps.event.addListener(n,"click",function(){niclabs.insight.event.trigger("map_element_selected",t),"setAnimation"in n&&n.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){n.setAnimation(null)},3e3)})}else"undefined"!=typeof i&&(google.maps.event.removeListener(i),i=void 0);return void 0!==i},clear:function(){var e=a.marker();e.setMap(null)},visible:function(e){return"undefined"==typeof e?a.marker().getVisible():(a.marker().setVisible(e),e)}};return a};return e}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(){var e=function(e,t){var n=niclabs.insight.map.marker.Marker(e,t),r=new google.maps.LatLng(parseFloat(t.lat),parseFloat(t.lng)),i=new google.maps.Marker({position:r,map:n.map.googlemap(),title:t.landmark||""});return n.marker=function(){return i},n};return niclabs.insight.handler("simple-marker","marker",e),e}(jQuery),niclabs.insight.map.heatmap={},niclabs.insight.map.heatmap.Heatmap=function(){var e=function(e,t){if(!("layer"in t))throw new Error("The heatmap must be associated to a layer");var n;if(!(n=e.layer(t.layer)))throw new Error("The layer "+n+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Heatmaps are only supported for Google Maps at the moment");var i={get map(){return r},get layer(){return n},clear:function(){}};return i};return e}(jQuery),niclabs.insight.map.heatmap.PointHeatmap=function(){var e=function(e,t){function n(e){for(var n=new google.maps.MVCArray,r=0;r<e.length;r++)n.push("weight"in e[r]?{location:new google.maps.LatLng(e[r].lat,e[r].lng),weight:e[r].weight}:new google.maps.LatLng(e[r].lat,e[r].lng));return new google.maps.visualization.HeatmapLayer({data:n,radius:t.radius||10})}if(!("data"in t))throw Error("No data provided for the heatmap");var r=niclabs.insight.map.heatmap.Heatmap(e,t),i=n(t.data);"undefined"!=typeof t.dissipating&&i.set("dissipating",t.dissipating),"undefined"!=typeof t.gradient&&i.set("gradient",t.gradient),"undefined"!=typeof t.opacity&&i.set("opacity",t.opacity),i.setMap(r.map.googlemap());var a=r.clear;return r.clear=function(){a(),i.setMap(null)},r};return niclabs.insight.handler("point-heatmap","heatmap",e),e}(jQuery),niclabs.insight.map.heatmap.SegmentHeatmap=function(){var e=function(e,t){function n(e){var n=new google.maps.MVCArray;for(i=0;i<e.length;i++){if(segment_size=e[i].lat.length,e[i].lng.length!=segment_size)throw new Error("Data Error. Latitude and longitude arrays size mismatch");for(var r=0;r<segment_size-1;r++)for(var a=Math.sqrt(Math.pow(e[i].lat[r+1]-e[i].lat[r],2)+Math.pow(e[i].lng[r+1]-e[i].lng[r],2)),o=Math.floor(a/1e-5),s={lat:(e[i].lat[r+1]-e[i].lat[r])/o,lng:(e[i].lng[r+1]-e[i].lng[r])/o},l=0;o>l;l++)n.push("weight"in e[i]?{location:new google.maps.LatLng(e[i].lat[r]+s.lat*l,e[i].lng[r]+s.lng*l),weight:e[i].weight}:new google.maps.LatLng(e[i].lat[r]+s.lat*l,e[i].lng[r]+s.lng*l))}return new google.maps.visualization.HeatmapLayer({data:n,radius:t.radius||10})}if(!("data"in t))throw Error("No data provided for the heatmap");var r=niclabs.insight.map.heatmap.Heatmap(e,t),a=n(t.data);"undefined"!=typeof t.dissipating&&a.set("dissipating",t.dissipating),"undefined"!=typeof t.gradient&&a.set("gradient",t.gradient),"undefined"!=typeof t.opacity&&a.set("opacity",t.opacity),a.setMap(r.map.googlemap());var o=r.clear;return r.clear=function(){o(),a.setMap(null)},r};return niclabs.insight.handler("segment-heatmap","heatmap",e),e}(jQuery);