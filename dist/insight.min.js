var niclabs={};niclabs.insight=function(e){"use strict";e.fn.template=function(n){"undefined"==typeof n?n=this.html():"string"==typeof n&&"#"===n.charAt(0)&&(n=e(n).html());var t=this;return this.bind("render",function(r,a){t.empty().append(n),t.find("[data-bind],[data-if]").each(function(){var n=e(this).attr("data-bind")||e(this).attr("data-if"),t=e(this).prop("tagName");n in a?e(this).attr("data-bind")&&("img"===t?e(this).attr("src",a[n]):"input"===t?e(this).val(a[n]):e(this).text(a[n])):e(this).detach()})}),this},e.fn.resizable=function(n){function t(n){o=n.clientX,s=n.clientY,l=p.outerWidth(),c=p.outerHeight(),e(document).on("mousemove",r),e(document).on("mouseup",a)}function r(e){u&&p.css("height",c+e.clientY-s+"px"),d&&p.css("width",l+e.clientX-o+"px"),f&&p.css("top",e.clientY+"px").css("height",c+s-e.clientY+"px"),h&&p.css("left",e.clientX+"px").css("width",l-e.clientX+"px")}function a(){e(document).off("mousemove",r),e(document).off("mouseup",a),p.trigger("resize")}var i=e("<div>").addClass("resizer").addClass(n+"-resize");this.append(i).addClass("resizable"),i.on("mousedown",t);var o,s,l,c,d,u,f,h,p=this;return u=n.search("s")>=0,d=n.search("e")>=0,f=n.search("n")>=0,h=n.search("w")>=0,this.scroll(function(){i.css("top",p.scrollTop())}),this},e.fn.setID=function(e){return"#"===e.charAt(0)&&(e=e.slice(1)),this.attr("id",e),this},e.fn.movable=function(){var n=this.children(".header");0===n.length&&(n=e("<div>").addClass("header"),this.prepend(n));var t=e("<span>").addClass("button").attr("data-icon","up-arrow"),r=e("<span>").addClass("button").attr("data-icon","down-arrow");n.append(t),n.append(r);var a=this;return t.on("click",function(){a.insertBefore(a.prev())}),r.on("click",function(){a.insertAfter(a.next())}),this},e.fn.closable=function(n){n||(n=function(){});var t=this.children(".header");t.length||(t=e("<span>").addClass("header"),this.prepend(t));var r=e("<span>").addClass("button").attr("data-icon","close");t.prepend(r);var a=this;return r.on("click",function(){a.remove(),n()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(n,t){return e.inArray(n,this,t)},Object.size=function(e){var n,t=0;for(n in e)e.hasOwnProperty(n)&&t++;return t},Object.prototype.watch||Object.defineProperty(Object.prototype,"watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,n){var t=this[e],r=function(){return t},a=function(r){return t===r?!1:(n.call(this,e,t,r),void(t=r))};delete this[e]&&Object.defineProperty(this,e,{get:r,set:a,enumerable:!0,configurable:!0})}}),Object.prototype.unwatch||Object.defineProperty(Object.prototype,"unwatch",{enumerable:!1,configurable:!0,writable:!1,value:function(e){var n=this[e];delete this[e],this[e]=n}}),Object.prototype.spy||Object.defineProperty(Object.prototype,"spy",{enumerable:!1,configurable:!0,writable:!1,value:function(e){for(var n in this)this.hasOwnProperty(n)&&this.watch(n,e)}}),Object.prototype.unspy||Object.defineProperty(Object.prototype,"unspy",{enumerable:!1,configurable:!0,writable:!1,value:function(){for(var e in this)this.hasOwnProperty(e)&&this.unwatch(e)}});var n,t={};return{handler:function(e,n,r){if(e in t){if(n="undefined"==typeof n?t[e].kind:n,r="undefined"==typeof r?t[e].handler:r,n!==t[e].kind)throw new Error("There already exists a handler with name "+e+" for kind "+t[e].kind)}else if("undefined"==typeof n&&"undefined"==typeof r)throw new Error("Handler "+e+" does not exist");return t[e]={kind:n,handler:r},r},dashboard:function(e){return"undefined"==typeof e?n:n=niclabs.insight.Dashboard(e)}}}(jQuery),niclabs.insight.Dashboard=function(e){"use strict";return function(n){function t(e){return e="undefined"==typeof e?d++:e,"layer"+e}var r=["left","right","none"],a="#insight-dashboard";if(!("anchor"in n))throw new Error("Anchor id is required for creating a dashboard");var i=n.anchor;if(n.layout=n.layout||"none",r.indexOf(n.layout)<0)throw new Error("Layout must be one of '"+r.join("','")+"'");var o=e("<div>").setID(a).addClass("insight").addClass(n.layout);e(i).append(o);var s=niclabs.insight.FilterBar();o.append(s.element);var l,c={},d=0,u={},f={};niclabs.insight.event.on("filter_changed",function(n){e.each(c,function(e,t){t.filter(n)})}),niclabs.insight.event.on("layer_data",function(e){l&&e.id===l.id&&niclabs.insight.event.trigger("active_layer_data",e)});var h={get element(){return e(a)[0]},get $(){return e(a)},config:function(e){return n[e]},info:function(n){return"undefined"!=typeof n&&(u="handler"in n?niclabs.insight.handler(n.handler)(h,n):n,e(a).append(u.element)),u},map:function(n){return"undefined"!=typeof n&&(f="handler"in n?niclabs.insight.handler(n.handler)(h,n):n,e(a).append(f.element)),f},layer:function(e,n){if("string"==typeof e)return c[e];if("number"==typeof e)return c[t(e)];var r,a;return"handler"in e?(a=e.id=e.id||t(),r=niclabs.insight.handler(e.handler)(h,e)):(r=e,a=r.id),c[a]=r,(n||1===Object.size(c))&&h.active(a),r},data:function(e){return l?l.data(e):[]},active:function(e){if("undefined"==typeof e)return"undefined"!=typeof l?l.id:void 0;if("undefined"!=typeof l&&l.clear(),"number"==typeof e&&(e=t(e)),!(e in c))throw new Error("Layer with id "+e+" does not exist");return l=c[e],l.load(),l},filter:function(e){return s.filter(e)},clear:function(){l&&l.clear()}};return h}}(jQuery),niclabs.insight.FilterBar=function(e){"use strict";return function(){function n(){for(var e=[],n=0;n<a.length;n++)a[n].element.prop("selectedIndex")>0&&e.push(a[n].options[a[n].element.prop("selectedIndex")-1].filter);return function(n){for(var t=0;t<e.length;t++)if(!e[t](n))return!1;return!0}}var t="#insight-filters",r=e("<div>").setID(t).addClass("filters"),a=[],i=new google.maps.Geocoder,o=e("<input>").addClass("search").attr("type","search").attr("placeholder","Enter location");r.append(e("<div>").addClass("filter").append(o));var s=function(){var e=CityDashboard.container("main")[0].data,n=o.val();i.geocode({address:n},function(t,r){r==google.maps.GeocoderStatus.OK?(e.setCenter(t[0].geometry.location),e.fitBounds(t[0].geometry.bounds)):o.val("not found: "+n)})};return o.on("change",s),{get element(){var n=e(t);return r=0===n.length?r:n,r[0]},$:function(){var n=e(t);return r=0===n.length?r:n},filter:function(t){if("number"==typeof t)return a[t];var i=e("<select>"),o=t.description||"",s=e("<option>").text(o);i.append(s);var l;for(l=0;l<t.options.length;l++)s=e("<option>").text(t.options[l].name),i.append(s);return i.on("change",function(){niclabs.insight.event.trigger("filter_changed",n())}),r.append(e("<div>").addClass("filter").append(i)),t.element=i,a.push(t),i}}}}(jQuery),niclabs.insight.InfoView=function(e){"use strict";var n=function(n,t){function r(e){return e="undefined"==typeof e?c++:e,"block"+e}function a(e){if("string"==typeof e)return d[e];if("number"==typeof e)return d[r(e)];var n,t;return"handler"in e?(t=e.id=e.id||r(),n=niclabs.insight.handler(e.handler)(u,e)):(n=e,t=n.id),d[t]=n,o.append(n.element),n}t=t||{};var i="#insight-info-view",o=e("<div>").setID(i).addClass("info");if("none"!==n.config("layout")){var s;"left"===n.config("layout")?s="e":"right"===n.config("layout")&&(s="w"),o.resizable(s)}var l,c=0,d={};if(t.blocks)for(l=0;l<t.blocks.length;l++)a(t.blocks[l]);o.on("resize",function(){for(var e in d)d[e].refresh()}),niclabs.insight.event.on("remove-block",function(e){delete d[e.id]});var u={get element(){var n=e(i);return o=0===n.length?o:n,o[0]},$:function(){var n=e(i);return o=0===n.length?o:n},block:a};return u};return niclabs.insight.handler("basic-info-view","info-view",n),n}(jQuery),niclabs.insight.MapView=function(e){"use strict";return function(n){var t="#insight-map-view",r={lat:n.lat||0,lng:n.lng||0},a=n.zoom||12,i=e("<div>").setID(t).addClass("map");return{get element(){var n=e(t);return i=0===n.length?i:n,i[0]},$:function(){var n=e(t);return i=0===n.length?i:n},center:function(e,n){return r.lat=e="undefined"==typeof e?r.lat:e,r.lng=n="undefined"==typeof n?r.lng:n,r},lat:function(){return r.lat},lng:function(){return r.lng},zoom:function(e){return a=e="undefined"==typeof e?a:e}}}}(jQuery),niclabs.insight.event=function(){"use strict";function e(e,t){if(e in n)for(var r=0;r<n[e].length;r++)if(n[e][r]===t)return r;return-1}var n={};return{on:function(t,r){var a=e(t,r);return 0>a?(t in n||(n[t]=[]),n[t].push(r)-1):a},off:function(t,r){var a="number"==typeof r?r:e(t,r);return a>=0?(n[t].splice(a,1),!0):!1},trigger:function(e,t){if(e in n)for(var r=0;r<n[e].length;r++)n[e][r](t)}}}(),niclabs.insight.info=function(){var e=function(e){var n=niclabs.insight.dashboard();if("undefined"==typeof n)throw new Error("Dashboard has not been initialized");return n.info(e)};return e}(),niclabs.insight.info.Block=function(e){"use strict";var n=function(n,t){function r(){niclabs.insight.event.trigger("remove-block",{id:a})}if(!("id"in t))throw new Error("All information blocks must have an id");var a=t.id,i="#"===a.charAt(0)?a:"#"+a,o=t.title||"",s={closable:"undefined"==typeof t.closable?!0:t.closable,movable:"undefined"==typeof t.movable?!0:t.movable},l=t.preprocess||function(e){return e},c=e("<div>").addClass("header").append(e("<span>").attr("data-bind","title").addClass("title").append(o)),d=e("<div>").setID(i).addClass("block").append(c),u=e("<div>").addClass("content");d.append(u),s.closable&&d.closable(function(){r()}),s.movable&&d.movable(),d.css(s),niclabs.insight.event.on("map_element_selected",function(e){h.data(e),h.refresh()}),niclabs.insight.event.on("layer_summary",function(e){h.data(e.data),h.refresh()});var f=t.data||{},h={get id(){return a},get element(){var n=e(i);return d=0===n.length?d:n,d[0]},get $(){var n=e(i);return d=0===n.length?d:n},get content(){var n=e(i).find(".content");return u=0===n.length?u:n},title:function(e){return"undefined"!=typeof e&&(o=e,h.$.find(".title").text(e)),o},remove:r,data:function(e){return"undefined"==typeof e?f:f=0===Object.keys(e).length?{}:l(e)},refresh:function(){}};return h};return n}(jQuery),niclabs.insight.info.ChartistBlock=function(e){var n=function(n,t,r){var a=niclabs.insight.info.Block(n,r),i=r.chartist;a.content.addClass("chartist-viz").append(e("<div>").addClass(i["class"]));var o,s=i.options||{},l=i.responsiveOptions||{},c=i.labels,d=a.refresh;a.refresh=function(e){e="undefined"==typeof e?a.data():e,d(e),e=e.value||e;var n={series:e,labels:"function"==typeof c?c(e):c};o&&o.optionsProvider?o.update(n):o=new t(a.content.find("div")[0],n,s,l)},r.data&&a.refresh(r.data);var u=a.remove;return a.remove=function(){u(),o.detach()},a},t=function(e,t){var r=n(e,Chartist.Line,t);return r},r=function(e,t){var r=n(e,Chartist.Bar,t);return r},a=function(e,t){var r=n(e,Chartist.Pie,t);return r};return niclabs.insight.handler("chartist-linechart","info-block",t),niclabs.insight.handler("chartist-barchart","info-block",r),niclabs.insight.handler("chartist-piechart","info-block",a),n}(jQuery),niclabs.insight.info.SummaryBlock=function(){var e=function(e,n){var t=niclabs.insight.info.Block(e,n),r=n.template||'        <h6 class="latLngView" data-if="lat">             lat: <span data-bind="lat"> -- </span>             lng: <span data-bind="lng"> -- </span>         </h6>        <dl class="deflist">            <dt class="deflist-key" data-if="description">description</dt>             <dd class="deflist-value" data-bind="description">none</dd>             <dt class="deflist-key" data-if="landmark">landmark</dt>             <dd class="deflist-value" data-bind="landmark">none</dd>             <dt class="deflist-key" data-if="fun-fact">fun-fact</dt>             <dd class="deflist-value" data-bind="fun-fact">none</dd>         </dl>        ';t.content.template(r);var a=t.refresh;return t.refresh=function(e){e="undefined"!=typeof e?e:t.data(),a(e),t.content.trigger("render",e)},n.data&&t.refresh(n.data),t};return niclabs.insight.handler("summary-block","info-block",e),e}(jQuery),niclabs.insight.layer=function(){var e=function(e,n){var t=niclabs.insight.dashboard();if("undefined"==typeof t)throw new Error("Dashboard has not been initialized");return t.layer(e,n)};return e}(),niclabs.insight.layer.HeatmapLayer=function(e){var n=function(n,t){function r(t,r){var a;if("type"in r){var o={layer:i.id,data:t};e.extend(o,r),a=niclabs.insight.handler(r.type)(n,o)}else a=r;return a}var a,i=niclabs.insight.layer.Layer(n,t),o=t.heatmap||{type:"point-heatmap"};return i.draw=function(e){a=r(e,o)},i.clear=function(){a&&a.clear()},i.filter=function(){},i};return niclabs.insight.handler("heatmap-layer","layer",n),n}(jQuery),niclabs.insight.layer.Layer=function(e){"use strict";var n=function(n,t){if(!("id"in t))throw Error("All layers must have an id.");var r=t.id;if(!("data"in t))throw Error("All layers must provide a data source.");var a=!1,i=[];"string"==typeof t.data?a=t.data:i=t.data&&Array.isArray(t.data)?t.data:[t.data];var o=t.summary||!1,s=!1,l={get id(){return r},data:function(e){return"undefined"==typeof e?s||!a?i:a:"string"==typeof e?(a=e,s&&l.load(),a):i=e.length?e:[e]},load:function(){function n(e){if(i=e,niclabs.insight.event.trigger("layer_data",{id:r,data:i}),l.clear(),o){var n=o;"function"==typeof o&&(n=o(i)),niclabs.insight.event.trigger("layer_summary",{id:r,data:n})}l.draw(i)}a?e.getJSON(a,n):n(i)},draw:function(){},filter:function(){},clear:function(){}};return l};return n}(jQuery),niclabs.insight.layer.MarkerLayer=function(e){var n=function(n,t){function r(t,r,i){var o;if("type"in i){var s={layer:a.id};e.extend(s,i,t[r]),o=niclabs.insight.handler(i.type)(n,s)}else o=i;return o.clickable(!0),o}var a=niclabs.insight.layer.Layer(n,t),i=t.marker||{type:"simple-marker"},o=[];return a.draw=function(e){for(var n=0;n<e.length;n++)o.push(r(e,n,i))},a.clear=function(){for(var e=0;e<o.length;e++)o[e].clear()},a.filter=function(e){for(var n=a.data(),t=0;t<o.length;t++)o[t].visible(e(n[t]))},a};return niclabs.insight.handler("marker-layer","layer",n),n}(jQuery),niclabs.insight.map=function(){var e=function(e){var n=niclabs.insight.dashboard();if("undefined"==typeof n)throw new Error("Dashboard has not been initialized");return n.map(e)};return e}(),niclabs.insight.map.GoogleMap=function(){"use strict";var e=function(e,n){var t=niclabs.insight.MapView(n),r=new google.maps.Map(t.element,{zoom:t.zoom(),center:new google.maps.LatLng(t.lat(),t.lng()),disableDefaultUI:!0}),a=t.zoom;google.maps.event.addListener(r,"zoom_changed",function(){a(r.getZoom())}),t.zoom=function(e){return e=a(e),r.setZoom(e),e};var i=t.center;return google.maps.event.addListener(r,"center_changed",function(){var e=r.getCenter();i(e.lat(),e.lng())}),t.center=function(e,n){var t=i(e,n);return r.setCenter({lat:t.lat,lng:t.lng}),t},t.googlemap=function(){return r},t};return niclabs.insight.handler("google-map","map-view",e),e}(jQuery),niclabs.insight.map.heatmap={},niclabs.insight.map.heatmap.Heatmap=function(){var e=function(e,n){if(!("layer"in n))throw new Error("The heatmap must be associated to a layer");var t;if(!(t=e.layer(n.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Heatmaps are only supported for Google Maps at the moment");var a={get map(){return r},get layer(){return t},clear:function(){}};return a};return e}(jQuery),niclabs.insight.map.heatmap.PointHeatmap=function(){var e=function(e,n){function t(e){for(var t=new google.maps.MVCArray,r=0;r<e.length;r++)t.push("weight"in e[r]?{location:new google.maps.LatLng(e[r].lat,e[r].lng),weight:e[r].weight}:new google.maps.LatLng(e[r].lat,e[r].lng));return new google.maps.visualization.HeatmapLayer({data:t,radius:n.radius||10})}if(!("data"in n))throw Error("No data provided for the heatmap");var r=niclabs.insight.map.heatmap.Heatmap(e,n),a=t(n.data);"undefined"!=typeof n.dissipating&&a.set("dissipating",n.dissipating),"undefined"!=typeof n.gradient&&a.set("gradient",n.gradient),"undefined"!=typeof n.opacity&&a.set("opacity",n.opacity),a.setMap(r.map.googlemap());var i=r.clear;return r.clear=function(){i(),a.setMap(null)},r};return niclabs.insight.handler("point-heatmap","heatmap",e),e}(jQuery),niclabs.insight.map.marker={},niclabs.insight.map.marker.CircleMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),a=new google.maps.Circle({center:r,map:t.map.googlemap(),radius:n.radius||400,strokeColor:n.strokeColor||"#FF0000",strokeOpacity:n.strokeOpacity||.8,strokeWeight:n.strokeWeight||2,fillColor:n.fillColor||"#FF0000",fillOpacity:n.fillOpacity||.35,title:n.landmark||""});return t.marker=function(){return a},t};return niclabs.insight.handler("circle-marker","marker",e),e}(jQuery),niclabs.insight.map.marker.ImageMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng));if(!("src"in n))throw new Error("An image source must be provided for using image markers");var a={url:n.src,scaledSize:new google.maps.Size(30,50)},i=new google.maps.Marker({position:r,map:t.map.googlemap(),icon:a,title:n.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("image-marker","marker",e),e}(jQuery),niclabs.insight.map.marker.Marker=function(){var e=function(e,n){if(!("layer"in n))throw new Error("The marker must be associated to a layer");var t;if(!(t=e.layer(n.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Markers are only supported for Google Maps at the moment");var a,i={get map(){return r},get layer(){return t},marker:function(){return void 0},clickable:function(e){if(e){var t=i.marker();a=google.maps.event.addListener(t,"click",function(){niclabs.insight.event.trigger("map_element_selected",n),"setAnimation"in t&&t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)},3e3)})}else"undefined"!=typeof a&&(google.maps.event.removeListener(a),a=void 0);return void 0!==a},clear:function(){var e=i.marker();e.setMap(null)},visible:function(e){return"undefined"==typeof e?i.marker().getVisible():(i.marker().setVisible(e),e)}};return i};return e}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),a=new google.maps.Marker({position:r,map:t.map.googlemap(),title:n.landmark||""});return t.marker=function(){return a},t};return niclabs.insight.handler("simple-marker","marker",e),e}(jQuery);