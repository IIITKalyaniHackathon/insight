var niclabs={};niclabs.insight=function(e){"use strict";e.fn.template=function(n){"undefined"==typeof n?n=this.html():"string"==typeof n&&"#"===n.charAt(0)&&(n=e(n).html());var t=this;return this.bind("render",function(r,i){t.empty().append(n),t.find("[data-bind],[data-if]").each(function(){var n=e(this).attr("data-bind")||e(this).attr("data-if"),t=e(this).prop("tagName");n in i?e(this).attr("data-bind")&&("img"===t?e(this).attr("src",i[n]):"input"===t?e(this).val(i[n]):e(this).text(i[n])):e(this).detach()})}),this},e.fn.resizable=function(n){function t(n){o=n.clientX,s=n.clientY,l=g.outerWidth(),c=g.outerHeight(),e(document).on("mousemove",r),e(document).on("mouseup",i)}function r(e){f&&g.css("height",c+e.clientY-s+"px"),u&&g.css("width",l+e.clientX-o+"px"),d&&g.css("top",e.clientY+"px").css("height",c+s-e.clientY+"px"),h&&g.css("left",e.clientX+"px").css("width",l-e.clientX+"px")}function i(){e(document).off("mousemove",r),e(document).off("mouseup",i),g.trigger("resize")}var a=e("<div>").addClass("resizer").addClass(n+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",t);var o,s,l,c,u,f,d,h,g=this;return f=n.search("s")>=0,u=n.search("e")>=0,d=n.search("n")>=0,h=n.search("w")>=0,this.scroll(function(){a.css("top",g.scrollTop())}),this},e.fn.setID=function(e){return"#"===e.charAt(0)&&(e=e.slice(1)),this.attr("id",e),this},e.fn.movable=function(){var n=this.children(".header");0===n.length&&(n=e("<div>").addClass("header"),this.prepend(n));var t=e("<span>").addClass("button").attr("data-icon","up-arrow"),r=e("<span>").addClass("button").attr("data-icon","down-arrow");n.append(t),n.append(r);var i=this;return t.on("click",function(){i.insertBefore(i.prev())}),r.on("click",function(){i.insertAfter(i.next())}),this},e.fn.closable=function(n){n||(n=function(){});var t=this.children(".header");t.length||(t=e("<span>").addClass("header"),this.prepend(t));var r=e("<span>").addClass("button").attr("data-icon","close");t.prepend(r);var i=this;return r.on("click",function(){i.remove(),n()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(n,t){return e.inArray(n,this,t)},Object.size=function(e){var n,t=0;for(n in e)e.hasOwnProperty(n)&&t++;return t},Object.prototype.watch||Object.defineProperty(Object.prototype,"watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,n){var t=this[e],r=function(){return t},i=function(r){return t===r?!1:(n.call(this,e,t,r),void(t=r))};delete this[e]&&Object.defineProperty(this,e,{get:r,set:i,enumerable:!0,configurable:!0})}}),Object.prototype.unwatch||Object.defineProperty(Object.prototype,"unwatch",{enumerable:!1,configurable:!0,writable:!1,value:function(e){var n=this[e];delete this[e],this[e]=n}}),Object.prototype.spy||Object.defineProperty(Object.prototype,"spy",{enumerable:!1,configurable:!0,writable:!1,value:function(e){for(var n in this)this.hasOwnProperty(n)&&this.watch(n,e)}}),Object.prototype.unspy||Object.defineProperty(Object.prototype,"unspy",{enumerable:!1,configurable:!0,writable:!1,value:function(){for(var e in this)this.hasOwnProperty(e)&&this.unwatch(e)}});var n,t={};return{handler:function(e,n,r){if(e in t){if(n="undefined"==typeof n?t[e].kind:n,r="undefined"==typeof r?t[e].handler:r,n!==t[e].kind)throw new Error("There already exists a handler with name "+e+" for kind "+t[e].kind)}else if("undefined"==typeof n&&"undefined"==typeof r)throw new Error("Handler "+e+" does not exist");return t[e]={kind:n,handler:r},r},dashboard:function(e){return"undefined"==typeof e?n:n=niclabs.insight.Dashboard(e)}}}(jQuery),niclabs.insight.Color=function(){function e(e,n,t){e/=255,n/=255,t/=255;var r,i,a=Math.max(e,n,t),o=Math.min(e,n,t),s=a,l=a-o;if(i=0===a?0:l/a,a==o)r=0;else{switch(a){case e:r=(n-t)/l+(t>n?6:0);break;case n:r=(t-e)/l+2;break;case t:r=(e-n)/l+4}r/=6}return[r,i,s]}function n(e,n,t){var r,i,a,o=Math.floor(6*e),s=6*e-o,l=t*(1-n),c=t*(1-s*n),u=t*(1-(1-s)*n);switch(o%6){case 0:r=t,i=u,a=l;break;case 1:r=c,i=t,a=l;break;case 2:r=l,i=t,a=u;break;case 3:r=l,i=c,a=t;break;case 4:r=u,i=l,a=t;break;case 5:r=t,i=l,a=c}return[255*r,255*i,255*a]}function t(e){e=Math.floor(e);var n=e.toString(16);return 1==n.length?"0"+n:n}function r(e){return"#"+t(e[0])+t(e[1])+t(e[2])}function i(e){var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return n?[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16)]:null}return{rgbToHsv:e,hsvToRgb:n,rgbToHex:r,hexToRgb:i}}(),niclabs.insight.Dashboard=function(e){"use strict";return function(n){function t(e){return e="undefined"==typeof e?c++:e,"layer"+e}var r=["left","right","none"],i="#insight-dashboard";if(!("anchor"in n))throw new Error("Anchor id is required for creating a dashboard");var a=n.anchor;if(n.layout=n.layout||"none",r.indexOf(n.layout)<0)throw new Error("Layout must be one of '"+r.join("','")+"'");var o=e("<div>").setID(i).addClass("insight").addClass(n.layout);e(a).append(o);var s,l={},c=0,u={},f={};niclabs.insight.event.on("layer_data",function(e){s&&e.id===s.id&&niclabs.insight.event.trigger("active_layer_data",e)});var d={get element(){return e(i)[0]},get $(){return e(i)},config:function(e){return n[e]},info:function(n){return"undefined"!=typeof n&&(u="handler"in n?niclabs.insight.handler(n.handler)(d,n):n,e(i).append(u.element)),u},map:function(n){return"undefined"!=typeof n&&(f="handler"in n?niclabs.insight.handler(n.handler)(d,n):n,e(i).append(f.element)),f},layer:function(e,n){if("string"==typeof e)return l[e];if("number"==typeof e)return l[t(e)];var r,i;return"handler"in e?(i=e.id=e.id||t(),r=niclabs.insight.handler(e.handler)(d,e)):(r=e,i=r.id),l[i]=r,(n||1===Object.size(l))&&d.active(i),r},data:function(e){return s?s.data(e):[]},active:function(e){if("undefined"==typeof e)return"undefined"!=typeof s?s.id:void 0;if("undefined"!=typeof s&&s.clear(),"number"==typeof e&&(e=t(e)),!(e in l))throw new Error("Layer with id "+e+" does not exist");return s=l[e],s.load(),s},filter:function(e){return h.filter(e)},clear:function(){s&&s.clear()}},h=niclabs.insight.FilterBar(d);return o.append(h.element),niclabs.insight.event.on("filter_changed",function(n){e.each(l,function(e,t){t.filter(n)})}),d}}(jQuery),niclabs.insight.ElementList=function(){var e=function(e){function n(e){return e="undefined"==typeof e?i++:e,"__"+e}var t={},r={},i=0;return t.element=function(t){if("string"==typeof t)return r[t];if("number"==typeof t)return r[n(t)];var i,a;return"handler"in t?(a=t.id=t.id||n(),i=niclabs.insight.handler(t.handler)(e,t)):(i=t,a=i.id),r[a]=i,i},t.each=function(e){for(var n in r)e(n,r[n])},t.remove=function(e){if("number"==typeof obj&&(e=n(e)),e in r){var t=r[e];return delete r[e],t}},t};return e}(),niclabs.insight.Element=function(){var e=function(e){if(!("id"in e))throw Error("All UI elements must define an identifier");var n=e.id;if(!/^[^#. '"]+$/.test(n))throw Error("The UI element id must be at least 1 character long and cannot contain the following characters ['#','.',' ', ''', '\"'])");return{get id(){return n}}};return e}(jQuery),niclabs.insight.FilterBar=function(e){"use strict";return function(n){function t(){for(var e=[],n=0;n<a.length;n++)a[n].element.prop("selectedIndex")>0&&e.push(a[n].options[a[n].element.prop("selectedIndex")-1].filter);return function(n){for(var t=0;t<e.length;t++)if(!e[t](n))return!1;return!0}}var r="#insight-filters",i=e("<div>").setID(r).addClass("filters"),a=[],o=new google.maps.Geocoder,s=e("<input>").addClass("search").attr("type","search").attr("placeholder","Enter location");i.append(e("<div>").addClass("filter").append(s));var l=function(){var e=n.map().googlemap(),t=s.val();o.geocode({address:t},function(n,r){r==google.maps.GeocoderStatus.OK?(e.setCenter(n[0].geometry.location),e.fitBounds(n[0].geometry.bounds)):s.val("not found: "+t)})};return s.on("change",l),{get element(){var n=e(r);return i=0===n.length?i:n,i[0]},$:function(){var n=e(r);return i=0===n.length?i:n},filter:function(n){if("number"==typeof n)return a[n];var r=e("<select>"),o=n.description||"",s=e("<option>").text(o);r.append(s);var l;for(l=0;l<n.options.length;l++)s=e("<option>").text(n.options[l].name),r.append(s);return r.on("change",function(){niclabs.insight.event.trigger("filter_changed",t())}),i.append(e("<div>").addClass("filter").append(r)),n.element=r,a.push(n),r}}}}(jQuery),niclabs.insight.InfoView=function(){"use strict";var e=function(e,n){n=n||{};var t=n.id||"insight-info-view",r=niclabs.insight.UiElement({id:t});if(r.$.addClass("info"),"none"!==e.config("layout")){var i;"left"===e.config("layout")?i="e":"right"===e.config("layout")&&(i="w"),r.$.resizable(i)}var a=niclabs.insight.ElementList(e);r.block=function(e){var n=a.element(e);return r.$.append(n.element),n};var o;if(n.blocks)for(o=0;o<n.blocks.length;o++)r.block(n.blocks[o]);return r.$.on("resize",function(){a.each(function(e,n){n.refresh()})}),niclabs.insight.event.on("remove-block",function(e){a.remove(e.id)}),r};return niclabs.insight.handler("basic-info-view","info-view",e),e}(jQuery),niclabs.insight.Interpolation=function(){function e(e,n,t,r){return t+(r-t)*e/n}function n(n,t,r,i){var a=e(n,t,r[0],i[0]),o=e(n,t,r[1],i[1]),s=e(n,t,r[2],i[2]);return[a,o,s]}function t(e,t,r,i){var a=niclabs.insight.Color.rgbToHsv(r[0],r[1],r[2]),o=niclabs.insight.Color.rgbToHsv(i[0],i[1],i[2]),s=n(e,t,a,o);return niclabs.insight.Color.hsvToRgb(s[0],s[1],s[2])}return{interpolate:e,interpolate3d:n,interpolateRgb:t}}(),niclabs.insight.MapView=function(e){"use strict";return function(n){var t="#insight-map-view",r={lat:n.lat||0,lng:n.lng||0},i=n.zoom||12,a=e("<div>").setID(t).addClass("map"),o={get element(){var n=e(t);return a=0===n.length?a:n,a[0]},get $(){var n=e(t);return a=0===n.length?a:n},center:function(e,n){return r.lat=e="undefined"==typeof e?r.lat:e,r.lng=n="undefined"==typeof n?r.lng:n,r},get lat(){return r.lat},get lng(){return r.lng},get width(){return o.$.width()},get height(){return o.$.height()},zoom:function(e){return i=e="undefined"==typeof e?i:e}};return o}}(jQuery),niclabs.insight.UiElement=function(e){var n=function(n){var t=niclabs.insight.Element(n),r=e("<div>").attr("id",t.id);return Object.defineProperty(t,"$",{get:function(){var n=e("#"+t.id);return r=0===n.length?r:n}}),Object.defineProperty(t,"element",{get:function(){return t.$[0]}}),t.append=function(e){return t.$.append(e.$),t},t};return n}(jQuery),niclabs.insight.event=function(){"use strict";function e(e,t){if(e in n)for(var r=0;r<n[e].length;r++)if(n[e][r]===t)return r;return-1}var n={};return{on:function(t,r){var i=e(t,r);return 0>i?(t in n||(n[t]=[]),n[t].push(r)-1):i},off:function(t,r){var i="number"==typeof r?r:e(t,r);return i>=0?(n[t].splice(i,1),!0):!1},trigger:function(e,t){if(e in n)for(var r=0;r<n[e].length;r++)n[e][r](t)}}}(),niclabs.insight.info=function(){var e=function(e){var n=niclabs.insight.dashboard();if("undefined"==typeof n)throw new Error("Dashboard has not been initialized");return n.info(e)};return e}(),niclabs.insight.info.Block=function(e){"use strict";var n=function(n,t){function r(){niclabs.insight.event.trigger("remove-block",{id:o})}function i(e,n){g=niclabs.insight.event.on("map_element_selected",function(t){n&&t.layer!==n||e.refresh(e.__data__(t))}),p=niclabs.insight.event.on("layer_summary",function(t){n&&t.id!==n||e.refresh(e.__data__(t.data))})}function a(){niclabs.insight.event.off("map_element_selected",g),niclabs.insight.event.off("layer_summary",p)}if(!("id"in t))throw new Error("All information blocks must have an id");var o=t.id,s="#"===o.charAt(0)?o:"#"+o,l=t.title||"",c={closable:"undefined"==typeof t.closable?!0:t.closable,movable:"undefined"==typeof t.movable?!0:t.movable},u=t.preprocess||function(e){return e},f=e("<div>").addClass("header").append(e("<span>").attr("data-bind","title").addClass("title").append(l)),d=e("<div>").setID(s).addClass("block").append(f),h=e("<div>").addClass("content");d.append(h),c.closable&&d.closable(function(){r()}),c.movable&&d.movable(),d.css(c);var g,p,b,m={},y={get id(){return o},get element(){var n=e(s);return d=0===n.length?d:n,d[0]},get $(){var n=e(s);return d=0===n.length?d:n},get layer(){return b},get content(){var n=e(s).find(".content");return h=0===n.length?h:n},title:function(e){return"undefined"!=typeof e&&(l=e,y.$.find(".title").text(e)),l},__data__:function(e){return"undefined"==typeof e?m:m=0===Object.keys(e).length?{}:u(e)},remove:r,data:function(n){return"undefined"==typeof n?m:(b=void 0,a(y),"string"==typeof n?"#"===n.charAt(0)?(b=n.substring(1),m=t.defaults||{},i(y,b),m):(e.getJSON(n,y.__data__),n):y.__data__("function"==typeof n?n.call(y):n))},refresh:function(){}};return"data"in t?y.data(t.data):(i(y),m=t.defaults||{}),y};return n}(jQuery),niclabs.insight.info.ChartistBlock=function(e){var n=function(n,t,r){var i=niclabs.insight.info.Block(n,r),a=r.chartist;i.content.addClass("chartist-viz").append(e("<div>").addClass(a["class"]));var o,s=a.options||{},l=a.responsiveOptions||{},c=a.labels,u=i.refresh;i.refresh=function(e){e="undefined"==typeof e?i.data():e,u(e),e=e.value||e;var n={series:e,labels:"function"==typeof c?c(e):c};o&&o.optionsProvider?o.update(n):o=new t(i.content.find("div")[0],n,s,l)};var f=i.remove;return i.remove=function(){f(),o.detach()},i.refresh(),i},t=function(e,t){var r=n(e,Chartist.Line,t);return r},r=function(e,t){var r=n(e,Chartist.Bar,t);return r},i=function(e,t){var r=n(e,Chartist.Pie,t);return r};return niclabs.insight.handler("chartist-linechart","info-block",t),niclabs.insight.handler("chartist-barchart","info-block",r),niclabs.insight.handler("chartist-piechart","info-block",i),n}(jQuery),niclabs.insight.info.SummaryBlock=function(){var e=function(e,n){var t=niclabs.insight.info.Block(e,n),r=n.template||'        <h6 class="latLngView" data-if="lat">             lat: <span data-bind="lat"> -- </span>             lng: <span data-bind="lng"> -- </span>         </h6>        <dl class="deflist">            <dt class="deflist-key" data-if="description">description</dt>             <dd class="deflist-value" data-bind="description">none</dd>             <dt class="deflist-key" data-if="landmark">landmark</dt>             <dd class="deflist-value" data-bind="landmark">none</dd>             <dt class="deflist-key" data-if="fun-fact">fun-fact</dt>             <dd class="deflist-value" data-bind="fun-fact">none</dd>         </dl>        ';t.content.template(r);var i=t.refresh;return t.refresh=function(e){e="undefined"!=typeof e?e:t.data(),i(e),t.content.trigger("render",e)},t.refresh(),t};return niclabs.insight.handler("summary-block","info-block",e),e}(jQuery),niclabs.insight.layer=function(){var e=function(e,n){var t=niclabs.insight.dashboard();if("undefined"==typeof t)throw new Error("Dashboard has not been initialized");return t.layer(e,n)};return e}(),niclabs.insight.layer.GridLayer=function(){var e=function(e,n){function t(n,t){var r;if("type"in t){var a={layer:i.id,data:n};$.extend(a,t),r=niclabs.insight.handler(t.type)(e,a)}else r=t;return r}var r,i=niclabs.insight.layer.Layer(e,n),a=n.grid||{type:"hexagon"};return i.draw=function(e){r=t(e,a)},i.clear=function(){r&&r.clear()},i.filter=function(){},i};return niclabs.insight.handler("grid-layer","layer",e),e}(),niclabs.insight.layer.HeatmapLayer=function(e){var n=function(n,t){function r(t,r){var i;if("type"in r){var o={layer:a.id,data:t};e.extend(o,r),i=niclabs.insight.handler(r.type)(n,o)}else i=r;return i}var i,a=niclabs.insight.layer.Layer(n,t),o=t.heatmap||{type:"point-heatmap"};return a.draw=function(e){i=r(e,o)},a.clear=function(){i&&i.clear()},a.filter=function(){},a};return niclabs.insight.handler("heatmap-layer","layer",n),n}(jQuery),niclabs.insight.layer.Layer=function(e){"use strict";var n=function(n,t){if(!("id"in t))throw Error("All layers must have an id.");var r=t.id;if(!("data"in t))throw Error("All layers must provide a data source.");var i=!1,a=[];"string"==typeof t.data?i=t.data:a=t.data&&Array.isArray(t.data)?t.data:[t.data];var o=t.summary||!1,s=!1,l={get id(){return r},data:function(e){return"undefined"==typeof e?s||!i?a:i:"string"==typeof e?(i=e,s&&l.load(),i):a=e.length?e:[e]},load:function(){function n(e){if(a=e,niclabs.insight.event.trigger("layer_data",{id:r,data:a}),l.clear(),o){var n=o;"function"==typeof o&&(n=o(a)),niclabs.insight.event.trigger("layer_summary",{id:r,data:n})}l.draw(a)}i?e.getJSON(i,n):n(a)},draw:function(){},filter:function(){},clear:function(){}};return l};return n}(jQuery),niclabs.insight.layer.MarkerLayer=function(e){var n=function(n,t){function r(t,r,a){var o;if("type"in a){var s={layer:i.id};e.extend(s,a,t[r]),o=niclabs.insight.handler(a.type)(n,s)}else o=a;return o.clickable(!0),o}var i=niclabs.insight.layer.Layer(n,t),a=t.marker||{type:"simple-marker"},o=[];return i.draw=function(e){for(var n=0;n<e.length;n++)o.push(r(e,n,a))},i.clear=function(){for(var e=0;e<o.length;e++)o[e].clear()},i.filter=function(e){for(var n=i.data(),t=0;t<o.length;t++)o[t].visible(e(n[t]))},i};return niclabs.insight.handler("marker-layer","layer",n),n}(jQuery),niclabs.insight.map=function(){"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),"undefined"==typeof Number.prototype.toDeg&&(Number.prototype.toDeg=function(){return 180*this/Math.PI});var e=function(e){var n=niclabs.insight.dashboard();if("undefined"==typeof n)throw new Error("Dashboard has not been initialized");return n.map(e)};return e}(),niclabs.insight.map.GoogleMercator=function(){function e(e,n,t){return null!==n&&(e=Math.max(e,n)),null!==t&&(e=Math.min(e,t)),e}var n=256,t={x:n/2,y:n/2},r=n/360,i=n/(2*Math.PI);return{geographic:function(e){var n=(e.x-t.x)/r,a=(e.y-t.y)/-i,o=(2*Math.atan(Math.exp(a))-Math.PI/2).toDeg();return{lat:o,lng:n}},cartesian:function(n){"function"==typeof n.lat&&"function"==typeof n.lng&&(n={lat:n.lat(),lng:n.lng()});var a=t.x+n.lng*r,o=e(Math.sin(n.lat.toRad()),-.9999,.9999),s=t.y+.5*Math.log((1+o)/(1-o))*-i;return{x:a,y:s}},distance:function(e,n){return n="undefined"!=typeof n?n:12,e/(1<<n)}}}(),niclabs.insight.map.GoogleMap=function(){"use strict";var e=function(e,n){var t=niclabs.insight.MapView(n),r=new google.maps.Map(t.element,{zoom:t.zoom(),center:new google.maps.LatLng(t.lat,t.lng),disableDefaultUI:!0}),i=t.zoom;google.maps.event.addListener(r,"zoom_changed",function(){i(r.getZoom())}),t.zoom=function(e){return e=i(e),r.setZoom(e),e};var a=t.center;return google.maps.event.addListener(r,"center_changed",function(){var e=r.getCenter();a(e.lat(),e.lng())}),t.center=function(e,n){var t=a(e,n);return r.setCenter({lat:t.lat,lng:t.lng}),t},t.googlemap=function(){return r},t};return niclabs.insight.handler("google-map","map-view",e),e}(jQuery),niclabs.insight.quadtree={},niclabs.insight.quadtree.Bounds=function(){var e=function(e,n){var t={x:(e.x+n.x)/2,y:(e.y+n.y)/2};return{get center(){return t},get min(){return e},get max(){return n},contains:function(t){return e.x<=t.x&&t.x<n.x&&e.y<=t.y&&t.y<n.y},intersects:function(t){return n.x<t.min.x?!1:e.x>t.max.x?!1:n.y<t.min.y?!1:e.y>t.max.y?!1:!0}}};return e}(),niclabs.insight.quadtree.PointQuadTree=function(){var e=function(n,t,r){function i(){a=e(niclabs.insight.quadtree.Bounds(n.min,n.center),t,r-1),o=e(niclabs.insight.quadtree.Bounds({x:n.center.x,y:n.min.y},{x:n.max.x,y:n.center.y}),t,r-1),s=e(niclabs.insight.quadtree.Bounds({x:n.min.x,y:n.center.y},{x:n.center.x,y:n.max.y}),t,r-1),l=e(niclabs.insight.quadtree.Bounds(n.center,n.max,t,r-1))}t=t||50,r=r||40;var a,o,s,l,c=[],u={get capacity(){return t},get bounds(){return n},insert:function(e){return n.contains(e)?c.length<t||0>=r?(c.push(e),!0):(void 0===a&&i(),a.insert(e)?!0:o.insert(e)?!0:s.insert(e)?!0:l.insert(e)?!0:!1):!1},query:function(e,t){if(t="undefined"==typeof t?[]:t,!n.intersects(e))return t;for(var r=0;r<c.length;r++)e.contains(c[r])&&t.push(c[r]);return void 0===a?t:(a.query(e,t),o.query(e,t),s.query(e,t),l.query(e,t),t)}};return u};return e}(),niclabs.insight.map.grid={},niclabs.insight.map.grid.Grid=function(){var e=function(e,n){if(!("layer"in n))throw new Error("The grid must be associated to a layer");var t;if(!(t=e.layer(n.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Grids are only supported for Google Maps at the moment");var i={get map(){return r},get layer(){return t},clear:function(){}};return i};return e}(),niclabs.insight.map.grid.HexagonalGrid=function(){function e(e,n){return e=niclabs.insight.Color.hexToRgb(e),n=niclabs.insight.Color.hexToRgb(n),function(t){var r=0,a=0;for(i=0;i<t.length;i++)"weight"in t[i]&&(r+=t[i].weight,a++);return a>0?(r/=a,niclabs.insight.Color.rgbToHex(niclabs.insight.Interpolation.interpolateRgb(r,1,e,n))):"#ffffff"}}function n(e,n){function t(e,n,t){for(var r,i=Math.floor((n+t)/2);t>=n;){for(;e[n].weight<e[i].weight;)n++;for(;e[t].weight>e[i].weight;)t--;t>=n&&(r=e[n],e[n]=e[t],e[t]=r,n++,t--)}return i}return e=niclabs.insight.Color.hexToRgb(e),n=niclabs.insight.Color.hexToRgb(n),function(r){var i=0,a=0,o=r.length>0?r.length-1:0,s=Math.floor((a+o)/2);for(i=t(r,a,o);i!==s;)i=s>i?t(r,s,o):t(r,a,s);return niclabs.insight.Color.rgbToHex(niclabs.insight.Interpolation.interpolateRgb(r[i].weight,1,e,n))}}var t=function(e){function n(n){n.lat&&(n=niclabs.insight.map.GoogleMercator.cartesian(n));var i=[];return i[0]={x:n.x,y:n.y},i[1]={x:n.x+t,y:n.y+r},i[2]={x:n.x+t,y:n.y+e+r},i[3]={x:n.x,y:n.y+e+r+r},i[4]={x:n.x-t,y:n.y+e+r},i[5]={x:n.x-t,y:n.y+r},i}var t=Math.cos(Math.PI/6)*e,r=Math.sin(Math.PI/6)*e,i={get s(){return e},get r(){return t},get h(){return r},coordinates:function(){var n,i;1==arguments.length?(n=arguments[0][0],i=arguments[0][1]):(n=arguments[0],i=arguments[1]);var a=2*n*t+(1&i)*t+t,o=i*(r+e);return{x:a,y:o}},tile:function(n){n.lat&&(n=niclabs.insight.map.GoogleMercator.cartesian(n));var i=Math.floor(n.x/(2*t)),a=Math.floor(n.y/(r+e)),o=n.x-2*i*t,s=n.y-a*(r+e),l=0===(1&a),c=i,u=a;return l?t>=o&&-r/t*o+r>s?(c=i-1,u=a-1):o>t&&r/t*o-r>s&&(c=i,u=a-1):t>=o?r/t*o>s?(c=i,u=a-1):(c=i-1,u=a):o>t&&-r/t*o+2*r>s&&(c=i,u=a-1),[c,u]},draw:function(e,t,r){if(!("googlemap"in t))throw new Error("Sorry, I only know how to draw on Google Maps at the moment");for(var i,a=n(e),o=[],s=0;s<a.length;s++)o.push(niclabs.insight.map.GoogleMercator.geographic(a[s]));return r=r||{strokeColor:"#000000",strokeOpacity:.6,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.6},r.paths=o,r.geodesic=!0,i=new google.maps.Polygon(r),i.setMap(t.googlemap()),i}};return i},r=function(r,i){function a(){return"#ffffff"}function o(e){return function(){niclabs.insight.event.trigger("map_element_selected",e)}}function s(e){if(e){for(var n,r,a=t(niclabs.insight.map.GoogleMercator.distance(i.size,l.map.zoom())),s=h.query(niclabs.insight.quadtree.Bounds(niclabs.insight.map.GoogleMercator.cartesian({lat:e.getNorthEast().lat(),lng:e.getSouthWest().lng()}),niclabs.insight.map.GoogleMercator.cartesian({lat:e.getSouthWest().lat(),lng:e.getNorthEast().lng()}))),d=[],g=0;g<s.length;g++){var p=a.tile(s[g]);n=p[0],r=p[1],d[n]||(d[n]=[]),d[n][r]||(d[n][r]=[]),d[n][r].push(s[g])}c=[];for(n in d)for(r in d[n]){u.fillColor=f(d[n][r]);var b=a.draw(a.coordinates(n,r),l.map,u);google.maps.event.addListener(b,"click",o(d[n][r])),c.push(b)}}}var l=niclabs.insight.map.grid.Grid(r,i),c=[],u={strokeColor:"strokeColor"in i?i.strokeColor:"#000000",strokeOpacity:"strokeOpacity"in i?i.strokeOpacity:.6,strokeWeight:"strokeWeight"in i?i.strokeWeight:2,fillOpacity:"fillOpacity"in i?i.fillOpacity:.6},f=i.fill||a;"string"==typeof f&&(f="#"===i.fill.charAt(0)?function(){return i.fill}:"average"===i.fill?e(i.fillStart||"#ff0000",i.fillEnd||"#00ff00"):"median"===i.fill?n(i.fillStart||"#ff0000",i.fillEnd||"#00ff00"):a);for(var d=niclabs.insight.quadtree.Bounds(niclabs.insight.map.GoogleMercator.cartesian({lat:90,lng:-180}),niclabs.insight.map.GoogleMercator.cartesian({lat:-90,lng:180})),h=niclabs.insight.quadtree.PointQuadTree(d),g=0;g<i.data.length;g++){var p=niclabs.insight.map.GoogleMercator.cartesian(i.data[g]);i.data[g].x=p.x,i.data[g].y=p.y,h.insert(i.data[g])}return l.clear=function(){for(var e=0;e<c.length;e++)c[e].setMap(null)},google.maps.event.addListener(l.map.googlemap(),"bounds_changed",function(){var e=this.getBounds();window.setTimeout(function(){l.clear(),s(e)},50)}),s(l.map.googlemap().getBounds()),l};return niclabs.insight.handler("hexagon","grid",r),r}(),niclabs.insight.map.heatmap={},niclabs.insight.map.heatmap.Heatmap=function(){var e=function(e,n){if(!("layer"in n))throw new Error("The heatmap must be associated to a layer");var t;if(!(t=e.layer(n.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Heatmaps are only supported for Google Maps at the moment");var i={get map(){return r},get layer(){return t},clear:function(){}};return i};return e}(jQuery),niclabs.insight.map.heatmap.PointHeatmap=function(){var e=function(e,n){function t(e){for(var t=new google.maps.MVCArray,r=0;r<e.length;r++)t.push("weight"in e[r]?{location:new google.maps.LatLng(e[r].lat,e[r].lng),weight:e[r].weight}:new google.maps.LatLng(e[r].lat,e[r].lng));return new google.maps.visualization.HeatmapLayer({data:t,radius:n.radius||10})}if(!("data"in n))throw Error("No data provided for the heatmap");var r=niclabs.insight.map.heatmap.Heatmap(e,n),i=t(n.data);"undefined"!=typeof n.dissipating&&i.set("dissipating",n.dissipating),"undefined"!=typeof n.gradient&&i.set("gradient",n.gradient),"undefined"!=typeof n.opacity&&i.set("opacity",n.opacity),i.setMap(r.map.googlemap());var a=r.clear;return r.clear=function(){a(),i.setMap(null)},r};return niclabs.insight.handler("point-heatmap","heatmap",e),e}(jQuery),niclabs.insight.map.heatmap.SegmentHeatmap=function(){var e=function(e,n){function t(e){var t=new google.maps.MVCArray;for(i=0;i<e.length;i++){segment_size=e[i].coordinates.length;for(var r=0;r<segment_size-1;r++)for(var a=Math.sqrt(Math.pow(e[i].coordinates[r+1][0]-e[i].coordinates[r][0],2)+Math.pow(e[i].coordinates[r+1][1]-e[i].coordinates[r][1],2)),o=Math.floor(a/1e-5),s={lat:(e[i].coordinates[r+1][0]-e[i].coordinates[r][0])/o,lng:(e[i].coordinates[r+1][1]-e[i].coordinates[r][1])/o},l=0;o>l;l++)t.push("weight"in e[i]?{location:new google.maps.LatLng(e[i].coordinates[r][0]+s.lat*l,e[i].coordinates[r][1]+s.lng*l),weight:e[i].weight}:new google.maps.LatLng(e[i].coordinates[r][0]+s.lat*l,e[i].coordinates[r][1]+s.lng*l))}return new google.maps.visualization.HeatmapLayer({data:t,radius:n.radius||10})}if(!("data"in n))throw Error("No data provided for the heatmap");var r=niclabs.insight.map.heatmap.Heatmap(e,n),a=t(n.data);"undefined"!=typeof n.dissipating&&a.set("dissipating",n.dissipating),"undefined"!=typeof n.gradient&&a.set("gradient",n.gradient),"undefined"!=typeof n.opacity&&a.set("opacity",n.opacity),a.setMap(r.map.googlemap());var o=r.clear;return r.clear=function(){o(),a.setMap(null)},r};return niclabs.insight.handler("segment-heatmap","heatmap",e),e}(jQuery),niclabs.insight.map.marker={},niclabs.insight.map.marker.CircleMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),i=new google.maps.Circle({center:r,map:t.map.googlemap(),radius:n.radius||400,strokeColor:n.strokeColor||"#FF0000",strokeOpacity:n.strokeOpacity||.8,strokeWeight:n.strokeWeight||2,fillColor:n.fillColor||"#FF0000",fillOpacity:n.fillOpacity||.35,title:n.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("circle-marker","marker",e),e}(jQuery),niclabs.insight.map.marker.ImageMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng));if(!("src"in n))throw new Error("An image source must be provided for using image markers");var i={url:n.src,scaledSize:new google.maps.Size(30,50)},a=new google.maps.Marker({position:r,map:t.map.googlemap(),icon:i,title:n.landmark||""});return t.marker=function(){return a},t};return niclabs.insight.handler("image-marker","marker",e),e}(jQuery),niclabs.insight.map.marker.Marker=function(){var e=function(e,n){if(!("layer"in n))throw new Error("The marker must be associated to a layer");var t;if(!(t=e.layer(n.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Markers are only supported for Google Maps at the moment");var i,a={get map(){return r},get layer(){return t},marker:function(){return void 0},clickable:function(e){if(e){var t=a.marker();i=google.maps.event.addListener(t,"click",function(){niclabs.insight.event.trigger("map_element_selected",n),"setAnimation"in t&&t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)},3e3)})}else"undefined"!=typeof i&&(google.maps.event.removeListener(i),i=void 0);return void 0!==i},clear:function(){var e=a.marker();e.setMap(null)},visible:function(e){return"undefined"==typeof e?a.marker().getVisible():(a.marker().setVisible(e),e)}};return a};return e}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),i=new google.maps.Marker({position:r,map:t.map.googlemap(),title:n.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("simple-marker","marker",e),e}(jQuery);