function dotprd(e,r){for(var n=0,t=0;3>t;t++)n+=e[t]*r[t];return n}function crsprd(e,r){for(var n=new Array(3),t=0;3>t;t++){var i=t+1;i>=3&&(i-=3);var a=t+2;a>=3&&(a-=3),n[t]=e[i]*r[a]-e[a]*r[i]}return n}function triple_prd(e,r,n){return dotprd(crsprd(e,r),n)}function ptdist(e,r){for(var n=0,t=0,i=0;3>i;i++){var a=r[i]-e[i];n+=a*a;var o=r[i]+e[i];t+=o*o}return Math.sqrt(n)-Math.sqrt(t)}function Normalize(e){for(var r=new Array(3),n=0,t=0;3>t;t++){var i=e[t];n+=i*i}for(nrmult=n>0?1/Math.sqrt(n):0,t=0;3>t;t++)r[t]=nrmult*e[t];return r}function dotprd_ix(e,r,n){return dotprd(e[r],e[n])}function crsprd_ix(e,r,n){return crsprd(e[r],e[n])}function triple_prd_ix(e,r,n,t){return triple_prd(e[r],e[n],e[t])}function ptdist_ix(e,r,n){return ptdist(e[r],e[n])}function zerovec(){for(var e=new Array(3),r=0;3>r;r++)e[r]=0;return e}function vec_copy(e){for(var r=new Array(3),n=0;3>n;n++)r[n]=e[n];return r}function vec_add_to(e,r){for(var n=0;3>n;n++)e[n]+=r[n]}function vec_mult_scalar_to(e,r){for(var n=0;3>n;n++)e[n]*=r}function vec_difference(e,r){for(var n=zerovec(),t=0;3>t;t++)n[t]=e[t]-r[t];return n}function IsNull(e){return"undefined"==typeof e}function TrianglesEqual(e,r){if(IsNull(e))return!1;if(IsNull(r))return!1;for(var n=0;3>n;n++)if(e.verts[n]!=r.verts[n])return!1;return!0}function EdgesEqual(e,r){if(IsNull(e))return!1;if(IsNull(r))return!1;for(var n=0;2>n;n++)if(e.verts[n]!=r.verts[n])return!1;return!0}function min(e,r){return e>r?r:e}function max(e,r){return r>e?r:e}function TriangleObject(e,r){this.verts=r,this.edges=new Array(3),this.dirs=new Array(3);for(var n=0;3>n;n++){var t=n+1;t>=3&&(t-=3);var i=n+2;i>=3&&(i-=3),this.dirs[n]=crsprd_ix(e,r[t],r[i])}for(this.vol=triple_prd_ix(e,r[0],r[1],r[2]),n=0;3>n;n++)vec_mult_scalar_to(this.dirs[n],1/this.vol);var a=zerovec();for(n=0;3>n;n++)vec_add_to(a,this.dirs[n]);this.ccdir=Normalize(a);var o=0;for(n=0;3>n;n++)o+=ptdist(this.ccdir,e[r[n]]);o/=3,this.ccdsq=o}function EdgeObject(e){this.verts=e,this.polys=new Array(2)}function EdgeCheckObject(e,r){this.verts=r,this.pdst=ptdist_ix(e,r[0],r[1]),this.direc=Normalize(crsprd_ix(e,r[0],r[1]));var n=zerovec();vec_add_to(n,e[r[0]]),vec_add_to(n,e[r[1]]),this.midpnt=Normalize(n)}function AddUnique(e,r){for(var n=0;n<e.length;n++)if(r==e[n])return;e.push(r)}function AddUniqueEdge(e,r){for(var n=0;n<e.length;n++)if(EdgesEqual(e[n],r))return;e.push(r)}function FindShared(e,r){for(var n=[],t=0;t<e.length;t++)for(var i=e[t],a=0;a<r.length;a++){var o=r[a];if(i==o){n.push(i);break}}return n}function FindSharedEdges(e,r){for(var n=[],t=0;t<e.length;t++)for(var i=e[t],a=0;a<r.length;a++){var o=r[a];if(EdgesEqual(i,o)){n.push(i);break}}return n}function FindSetDifference(e,r){if(0!==r.length){for(var n=[],t=0;t<e.length;t++){for(var i=e[t],a=!0,o=0;o<r.length;o++){var s=r[o];if(s==i){a=!1;break}}a&&n.push(i)}e.splice(0,e.length);for(var l=0;l<n.length;l++)e.push(n[l])}}function FindSetDifferenceEdges(e,r){if(0!==r.length){for(var n=[],t=0;t<e.length;t++){for(var i=e[t],a=!0,o=0;o<r.length;o++){var s=r[o];if(EdgesEqual(i,s)){a=!1;break}}a&&n.push(i)}e.splice(0,e.length);for(var l=0;l<n.length;l++)e.push(n[l])}}function TestConsistency(e){for(var r,n,t,i,a,o=!0,s=0;s<e.triangles.length;s++)for(i=e.triangles[s],n=0;3>n;n++){for(r=i.edges[n],a=0,t=0;3>t;t++)r.IsVertex(i.verts[t])&&a++;2!=a&&(o=!1),r.PolyIndexIn(i)<0&&(o=!1)}for(s=0;s<e.edges.length;s++){r=e.edges[s];var l=0;for(n=0;2>n;n++)if(i=r.polys[n],IsNull(i))l++;else{for(a=0,t=0;2>t;t++)i.IsVertex(r.verts[t])&&a++;2!=a&&(o=!1),i.EdgeIndexIn(r)<0&&(o=!1)}l>1&&(o=!1)}return o}function AddPointInside(e,r){for(var n,t=e.positions,i=t[r],a=e.triangles.length,o=0;a>o;o++){var s=e.triangles[o];if(s.IsPointInside(i)){for(var l=s.edges,c=[],u=0;3>u;u++)c.push(l[u].PolyIndexIn(s));var d=Array(3),f=Array(3);for(u=0;3>u;u++)n=u+1,n>=3&&(n-=3),d[u]=new TriangleObject(t,[s.verts[u],s.verts[n],r]),f[u]=new EdgeObject([s.verts[u],r]);for(u=0;3>u;u++)n=u+1,n>=3&&(n-=3),d[u].edges[0]=f[n],d[u].edges[1]=f[u],f[u].polys[0]=d[u],f[n].polys[1]=d[u];for(u=0;3>u;u++)for(var g=l[u],h=c[u],p=0;3>p;p++){var v=d[p];numverts=0;for(var y=0;2>y;y++)if(v.IsVertex(g.verts[y])&&numverts++,2==numverts){g.polys[h]=v,v.edges[2]=g;break}}for(e.triangles[o]=d[0],u=1;3>u;u++)e.triangles.push(d[u]);for(u=0;3>u;u++)e.edges.push(f[u]);return!0}}return!1}function ImproveTriangulation(e){for(var r,n=e.positions,t=new Array(4),i=0;100>i;i++){for(var a=0,o=0;o<e.edges.length;o++){var s=e.edges[o],l=s.polys;if(!IsNull(l[0])&&!IsNull(l[1])){for(d=0;3>d&&(r=l[0].verts[d],s.IsVertex(r));d++);var c=d+1;c>=3&&(c-=3);var u=d+2;u>=3&&(u-=3),t[0]=r,t[1]=l[0].verts[c],t[3]=l[0].verts[u];for(var d=0;3>d&&(r=l[1].verts[d],s.IsVertex(r));d++);t[2]=r;var f=l[0].IsPointInCircumcircle(n[t[2]]),g=l[1].IsPointInCircumcircle(n[t[0]]);if(f||g){var h=new TriangleObject(n,[t[0],t[1],t[2]]);if(h.IsVertexOrderCorrect()){var p=new TriangleObject(n,[t[0],t[2],t[3]]);if(p.IsVertexOrderCorrect()){a++;var v,y,b,m,w;for(d=0;3>d;d++)if(v=l[0].edges[d],!EdgesEqual(v,s)&&v.IsVertex(t[3])){y=v,m=d;break}for(d=0;3>d;d++)if(v=l[1].edges[d],!EdgesEqual(v,s)&&v.IsVertex(t[1])){b=v,w=d;break}var _=y.PolyIndexIn(l[0]),x=b.PolyIndexIn(l[1]);y.polys[_]=l[1],b.polys[x]=l[0],l[0].edges[m]=b,l[1].edges[w]=y,l[0].copy_vert_info(h),l[1].copy_vert_info(p),s.verts=[t[0],t[2]]}}}}}if(0===a)break}}function FindConvexHull(e){for(var r,n=(e.positions,{}),t=-1,i=0;i<e.edges.length;i++){var a=e.edges[i];if(IsNull(a.polys[0])){if(IsNull(a.polys[1]))continue;r=a.polys[1]}else{if(!IsNull(a.polys[1]))continue;r=a.polys[0]}var o=a.verts[0],s=a.verts[1],l=r.VertexIndexIn(s)-r.VertexIndexIn(o);if(0>l&&(l+=3),1!=l){var c=o;o=s,s=c}n[o]=s,t=o}if(t>=0){for(var u=t,d=[u];;){var f=n[u];if(f==t)break;d.push(f),u=f}e.hull=d}}function FindVoronoiDiagram(e){var r,n,t,i,a,o,s,l,c,u,d,f,g,h,p,v,y,b,m,w,_,x,k;if(1!=e.triangles.length){if(0!==e.triangles.length){for(j=0;j<e.triangles.length;j++)l=e.triangles[j],l.index=j,e.vor_positions.push(l.ccdir);for(var j=0;j<e.edges.length;j++)if(r=e.edges[j],!IsNull(r.polys[0])&&!IsNull(r.polys[1])){var E=[r.polys[0].index,r.polys[1].index];e.vor_edges.push(E)}for(j=0;j<e.indices.length;j++)o=e.indices[j],e.vor_polygons[o]={},s=e.vor_polygons[o],s.edges=[],s.triangles=[],s.boundary=[];for(j=0;j<e.edges.length;j++)for(r=e.edges[j],c=0;2>c;c++)e.vor_polygons[r.verts[c]].edges.push(r);for(j=0;j<e.triangles.length;j++)for(l=e.triangles[j],c=0;3>c;c++)e.vor_polygons[l.verts[c]].triangles.push(l);for(j=0;j<e.indices.length;j++){o=e.indices[j],s=e.vor_polygons[o];var O=s.triangles[0];for(l=O,s.boundary.push(l.index),c=0;3>c&&(r=l.edges[c],!r.IsVertex(o));c++);for(var I=r,M=!1;;){if(u=r.PolyIndexIn(l),l=r.polys[1-u],IsNull(l))break;if(TrianglesEqual(l,O)){M=!0;break}for(s.boundary.push(l.index),c=0;3>c;c++)if(d=l.edges[c],!EdgesEqual(d,r)&&d.IsVertex(o)){r=d;break}}if(!M){for(s.boundary.reverse(),l=O,c=0;3>c&&(r=l.edges[c],EdgesEqual(r,I)||!r.IsVertex(o));c++);for(;;){if(u=r.PolyIndexIn(l),l=r.polys[1-u],IsNull(l))break;for(s.boundary.push(l.index),c=0;3>c;c++)if(d=l.edges[c],!EdgesEqual(d,r)&&d.IsVertex(o)){r=d;break}}}M||(s.boundary.reverse(),s.boundary.push(-1),s.boundary.reverse(),s.boundary.push(-1))}if(e.hull.length>=3){var C=[],T=e.positions,L=e.hull.length;for(c=0;L>c;c++){o=e.hull[c];var q=c+1;q>=L&&(q=0);var N=e.hull[q],A=e.vor_polygons[o].edges,P=e.vor_polygons[N].edges,z=FindSharedEdges(A,P);r=z[0];var F=r.polys[0].index;f=T[o],g=T[N],m=vec_difference(g,f),x=[F,e.vor_positions[F],o,f,N,g,m],C.push(x)}for(;C.length>3;){var V=C.length,G=[],S=[];for(a=0;V>a;a++)S.push([]);for(a=0;V>a;a++)h=a+1,h>=V&&(h=0),b=Normalize(crsprd(C[a][6],C[h][6])),vec_mult_scalar_to(b,-1),S[a].push(G.length),S[h].push(G.length),G.push(b);for(a=0;V>a;a++){if(y=S[a],y.length>=2){for(var D=[],Q=0;Q<y.length;Q++)D.push(ptdist(G[y[Q]],C[a][1]));for(var H=0,$=D[H],B=0;B<D.length;B++){var U=D[B];$>U&&(H=B,$=U)}v=y[H]}else v=1==y.length?y[0]:-1;S[a]=v}var W=[];for(a=0;V>a;a++){h=a+1,h>=V&&(h=0),p=a-1,0>p&&(p=V-1);var R=0;if(y=S[a],-1!=y){var X=S[p];y==X?R=2:(ptitsc_next=S[h],y==ptitsc_next&&(R=1))}if(0===R)W.push(C[a]);else if(1==R){var Y=C[a],J=C[h];b=G[a];var Z=Y[0],K=J[0],ee=K!=Z;if(ee){w=e.vor_positions.length,_=Y[2],f=Y[3],ix1=J[4],g=J[5];for(var re,ne,te=0;V>te;te++){for(var ie=ptdist(C[te][3],b),ae=te-a;0>ae;)ae+=V;for(;ae>=V;)ae-=V;2>=ae?void 0===re?re=ie:re>ie&&(re=ie):void 0===ne?ne=ie:ne>ie&&(ne=ie)}ee=ne>re}if(ee){m=vec_difference(g,f),x=[w,b,_,f,ix1,g,m],W.push(x),e.vor_positions.push(b);var oe=Y[4];e.vor_edges.push([Z,w]),e.vor_edges.push([K,w]),e.vor_polygons[oe].boundary.shift(),k=e.vor_polygons[oe].boundary.length,e.vor_polygons[oe].boundary[k-1]=w,e.vor_polygons[_].boundary[1]==Z?(e.vor_polygons[_].boundary.unshift(-1),e.vor_polygons[_].boundary[1]=w):(k=e.vor_polygons[_].boundary.length,e.vor_polygons[_].boundary[k-2]==Z&&(e.vor_polygons[_].boundary.push(-1),k=e.vor_polygons[_].boundary.length,e.vor_polygons[_].boundary[k-2]=w)),e.vor_polygons[ix1].boundary[1]==K?(e.vor_polygons[ix1].boundary.unshift(-1),e.vor_polygons[ix1].boundary[1]=w):(k=e.vor_polygons[ix1].boundary.length,e.vor_polygons[ix1].boundary[k-2]==K&&(e.vor_polygons[ix1].boundary.push(-1),k=e.vor_polygons[ix1].boundary.length,e.vor_polygons[ix1].boundary[k-2]=w))}else W.push(Y),W.push(J)}}if(W.length==C.length)break;C=W}if(2==C.length){if(C[0][0]!=C[1][0]){var se=[];for(a=0;2>a;a++)h=C[a][0],se.push(h),h=C[a][2],e.vor_polygons[h].boundary.shift(),e.vor_polygons[h].boundary.pop();e.vor_edges.push(se)}}else if(3==C.length){var le=C[0][0],ce=C[1][0],ue=C[2][0];if(le!=ce&&le!=ue&&ce!=ue)for(w=e.vor_positions.length,n=C[0][3],t=C[1][3],i=C[2][3],b=zerovec(),vec_add_to(b,crsprd(n,t)),vec_add_to(b,crsprd(t,i)),vec_add_to(b,crsprd(i,n)),b=Normalize(b),vec_mult_scalar_to(b,-1),e.vor_positions.push(b),a=0;3>a;a++)x=C[a],e.vor_edges.push([x[0],w]),o=x[2],e.vor_polygons[o].boundary.shift(),k=e.vor_polygons[o].boundary.length,e.vor_polygons[o].boundary[k-1]=w}}for(a=0;a<e.vor_polygons.length;a++)s=e.vor_polygons[a],s.boundary.length>=3&&s.boundary[0]>=0&&(l=new TriangleObject(e.vor_positions,s.boundary.slice(0,3)),l.IsVertexOrderCorrect()||s.boundary.reverse())}else if(2==e.hull.length){n=e.positions[e.hull[0]],t=e.positions[e.hull[1]],f=zerovec(),vec_add_to(f,n),vec_add_to(f,t),f=Normalize(f),e.vor_positions.push(f),g=Normalize(crsprd(n,t)),e.vor_positions.push(g),vt2=vec_copy(f),vec_mult_scalar_to(vt2,-1),e.vor_positions.push(vt2);var de=vec_copy(g);for(vec_mult_scalar_to(de,-1),e.vor_positions.push(de),e.vor_edges.push([0,1,2,3,0]),r=e.edges[0],a=0;2>a;a++)o=e.hull[a],e.vor_polygons[o]={},s=e.vor_polygons[o],s.edges=[r],s.triangles=[0],0===a?s.boundary=[0,1,2,3]:1==a&&(s.boundary=[0,3,2,1])}}else if(3==e.hull.length){for(l=e.triangles[0],e.vor_positions.push(l.ccdir),a=0;3>a;a++){h=a+1,h>=3&&(h=0),p=a-1,0>p&&(p=2),t=e.positions[e.hull[a]],i=e.positions[e.hull[h]];var fe=vec_difference(i,t);e.vor_positions.push(Normalize(crsprd(fe,l.ccdir))),e.vor_edges.push([0,a+1,4]),o=e.hull[a],e.vor_polygons[o]={},s=e.vor_polygons[o];for(var ge=e.hull[p],he=0;3>he;he++){r=e.edges[he];var pe=FindShared([ge,o],r.verts);if(2==pe.length)break}s.edges=[r],s.triangles=[l],s.boundary=[0,p+1,4,a+1]}var ve=vec_copy(l.ccdir);vec_mult_scalar_to(ve,-1),e.vor_positions.push(ve)}}function FindDelaunayTriangulationIndexed(e,r){var n,t,i,a,o={};if(o.positions=e,o.indices=r,o.triangles=[],o.edges=[],o.hull=[],o.vor_positions=[],o.vor_edges=[],o.vor_polygons={},r.length<3)return 2==r.length&&(o.edges.push(new EdgeObject(r)),o.hull=r),FindVoronoiDiagram(o),o;var s=new TriangleObject(e,r.slice(0,3));s.IsVertexOrderCorrect()||(s=new TriangleObject(e,[r[0],r[2],r[1]])),o.triangles.push(s);for(var l=new Array(3),c=0;3>c;c++){n=c+1,n>=3&&(n-=3),v=r[c],t=r[n];var u=[v,t];i=new EdgeObject(u);var d=new EdgeCheckObject(e,u);d.edge=i,l[c]=d,s.edges[c]=i,i.polys[0]=s,o.edges.push(i)}var f=r.slice(0,3),g=l,h=Object;for(c=0;3>c;c++)n=c+2,n>=3&&(n-=3),v=r[c],h[v]=[l[c],l[c+1]];for(var p=3;p<r.length;p++){var v=r[p];if(!AddPointInside(o,v)){h[v]=[];for(var y=[],b=[],m=[],w=0;w<f.length;w++){t=f[w],a=new EdgeCheckObject(e,[v,t]);for(var _=!1,x=0;x<g.length;x++){var k=g[x];if(_=a.intersects(e,k))break}_||(i=new EdgeObject(a.verts),a.edge=i,AddUniqueEdge(y,a),AddUniqueEdge(h[v],a),AddUnique(b,v),AddUniqueEdge(h[t],a),AddUnique(b,t))}for(AddUnique(f,v),w=0;w<g.length;w++){a=g[w];for(var j=[],E=0;2>E;E++){var O=FindSharedEdges(h[v],h[a.verts[E]]);0!==O.length&&j.push(O[0])}if(!(j.length<2)){var I=-1;for(E=0;2>E;E++)if(IsNull(a.edge.polys[E])){I=E;break}if(!(0>I)){var M,C=a.edge.polys[1-I],T=a.verts[0],L=C.VertexIndexIn(T),q=a.verts[1],N=C.VertexIndexIn(q),A=N-L;if(0>A&&(A+=3),1==A?M=[v,q,T]:2==A&&(M=[v,T,q]),s=new TriangleObject(e,M),s.IsVertexOrderCorrect())for(o.triangles.push(s),a.edge.polys[I]=s,s.edges[0]=a.edge,s.edges[1]=j[0].edge,s.edges[2]=j[1].edge,AddUniqueEdge(m,a),E=0;2>E;E++){var P=j[E];IsNull(P.edge.polys[0])?(P.edge.polys[0]=s,o.edges.push(P.edge)):(P.edge.polys[1]=s,AddUniqueEdge(m,P))}}}}for(w=0;w<y.length;w++)AddUniqueEdge(g,y[w]);FindSetDifferenceEdges(g,m);var z=[];for(w=0;w<b.length;w++){var F=b[w];FindSetDifferenceEdges(h[F],m),0===h[F].length&&z.push(F)}FindSetDifference(f,z)}}return ImproveTriangulation(o),FindConvexHull(o),FindVoronoiDiagram(o),o}function FindDelaunayTriangulation(e){for(var r=new Array(e.length),n=0;n<r.length;n++)r[n]=n;return FindDelaunayTriangulationIndexed(e,r)}var niclabs={};niclabs.insight=function(e){"use strict";Array.prototype.forEach||(Array.prototype.forEach=function(e,r){var n,t;if(null===this)throw new TypeError(" this is null or not defined");var i=Object(this),a=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=r),t=0;a>t;){var o;t in i&&(o=i[t],e.call(n,o,t,i)),t++}}),e.fn.template=function(r){"undefined"==typeof r?r=this.html():"string"==typeof r&&"#"===r.charAt(0)&&(r=e(r).html());var n=this;return this.bind("render",function(t,i){n.empty().append(r),n.find("[data-bind],[data-if]").each(function(){var r=e(this).attr("data-bind")||e(this).attr("data-if"),n=e(this).prop("tagName");r in i?e(this).attr("data-bind")&&("img"===n?e(this).attr("src",i[r]):"input"===n?e(this).val(i[r]):e(this).text(i[r])):e(this).detach()})}),this},e.fn.resizable=function(r){function n(r){o=r.clientX,s=r.clientY,l=h.outerWidth(),c=h.outerHeight(),e(document).on("mousemove",t),e(document).on("mouseup",i)}function t(e){d&&h.css("height",c+e.clientY-s+"px"),u&&h.css("width",l+e.clientX-o+"px"),f&&h.css("top",e.clientY+"px").css("height",c+s-e.clientY+"px"),g&&h.css("left",e.clientX+"px").css("width",l-e.clientX+"px")}function i(r){e(document).off("mousemove",t),e(document).off("mouseup",i),h.trigger("resize")}var a=e("<div>").addClass("resizer").addClass(r+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",n);var o,s,l,c,u,d,f,g,h=this;return d=r.search("s")>=0,u=r.search("e")>=0,f=r.search("n")>=0,g=r.search("w")>=0,this.scroll(function(e){a.css("top",h.scrollTop())}),this},e.fn.setID=function(e){return"#"===e.charAt(0)&&(e=e.slice(1)),this.attr("id",e),this},e.fn.movable=function(){var r=this.children(".header");0===r.length&&(r=e("<div>").addClass("header"),this.prepend(r));var n=e("<span>").addClass("button").attr("data-icon","up-arrow"),t=e("<span>").addClass("button").attr("data-icon","down-arrow");r.append(n),r.append(t);var i=this;return n.on("click",function(){i.insertBefore(i.prev())}),t.on("click",function(){i.insertAfter(i.next())}),this},e.fn.closable=function(r){r||(r=function(){});var n=this.children(".header");n.length||(n=e("<span>").addClass("header"),this.prepend(n));var t=e("<span>").addClass("button").attr("data-icon","close");n.prepend(t);var i=this;return t.on("click",function(){i.remove(),r()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(r,n){return e.inArray(r,this,n)},Object.size=function(e){var r,n=0;for(r in e)e.hasOwnProperty(r)&&n++;return n},Object.prototype.watch||Object.defineProperty(Object.prototype,"watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,r){var n=this[e],t=function(){return n},i=function(t){return n===t?!1:(r.call(this,e,n,t),void(n=t))};delete this[e]&&Object.defineProperty(this,e,{get:t,set:i,enumerable:!0,configurable:!0})}}),Object.prototype.unwatch||Object.defineProperty(Object.prototype,"unwatch",{enumerable:!1,configurable:!0,writable:!1,value:function(e){var r=this[e];delete this[e],this[e]=r}}),Object.prototype.spy||Object.defineProperty(Object.prototype,"spy",{enumerable:!1,configurable:!0,writable:!1,value:function(e){for(var r in this)this.hasOwnProperty(r)&&this.watch(r,e)}}),Object.prototype.unspy||Object.defineProperty(Object.prototype,"unspy",{enumerable:!1,configurable:!0,writable:!1,value:function(){for(var e in this)this.hasOwnProperty(e)&&this.unwatch(e)}});var r,n={};return{handler:function(e,r,t){if(e in n){if(r="undefined"==typeof r?n[e].kind:r,t="undefined"==typeof t?n[e].handler:t,r!==n[e].kind)throw new Error("There already exists a handler with name "+e+" for kind "+n[e].kind)}else if("undefined"==typeof r&&"undefined"==typeof t)throw new Error("Handler "+e+" does not exist");return n[e]={kind:r,handler:t},t},dashboard:function(e){return"undefined"==typeof e?r:r=niclabs.insight.Dashboard(e)}}}(jQuery),niclabs.insight.Color=function(){function e(e,r,n){e/=255,r/=255,n/=255;var t,i,a=Math.max(e,r,n),o=Math.min(e,r,n),s=a,l=a-o;if(i=0===a?0:l/a,a==o)t=0;else{switch(a){case e:t=(r-n)/l+(n>r?6:0);break;case r:t=(n-e)/l+2;break;case n:t=(e-r)/l+4}t/=6}return[t,i,s]}function r(e,r,n){var t,i,a,o=Math.floor(6*e),s=6*e-o,l=n*(1-r),c=n*(1-s*r),u=n*(1-(1-s)*r);switch(o%6){case 0:t=n,i=u,a=l;break;case 1:t=c,i=n,a=l;break;case 2:t=l,i=n,a=u;break;case 3:t=l,i=c,a=n;break;case 4:t=u,i=l,a=n;break;case 5:t=n,i=l,a=c}return[255*t,255*i,255*a]}function n(e){e=Math.floor(e);var r=e.toString(16);return 1==r.length?"0"+r:r}function t(e){return"#"+n(e[0])+n(e[1])+n(e[2])}function i(e){var r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return r?[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16)]:null}return{rgbToHsv:e,hsvToRgb:r,rgbToHex:t,hexToRgb:i}}(),niclabs.insight.Dashboard=function(e){"use strict";return function(r){function n(e){return e="undefined"==typeof e?c++:e,"layer"+e}var t=["left","right","none"],i="#insight-dashboard";if(!("anchor"in r))throw new Error("Anchor id is required for creating a dashboard");var a=r.anchor;if(r.layout=r.layout||"none",t.indexOf(r.layout)<0)throw new Error("Layout must be one of '"+t.join("','")+"'");var o=e("<div>").setID(i).addClass("insight").addClass(r.layout);e(a).append(o);var s,l={},c=0,u={},d={};niclabs.insight.event.on("layer_data",function(e){s&&e.id===s.id&&niclabs.insight.event.trigger("active_layer_data",e)});var f=niclabs.insight.Filters(h);o.append(f.element);var g=function(){return!0};niclabs.insight.event.on("filter_changed",function(e){g=e,s.filter(g)});var h={get element(){return e(i)[0]},get $(){return e(i)},config:function(e){return r[e]},info:function(r){return"undefined"!=typeof r&&(u="handler"in r?niclabs.insight.handler(r.handler)(h,r):r,e(i).prepend(u.element)),u},map:function(n){return"undefined"!=typeof n&&(d="handler"in n?niclabs.insight.handler(n.handler)(h,n):n,e(i).append(d.element),r.geocoding!==!1&&"googlemap"in d&&f.filter(niclabs.insight.filter.GoogleGeocodingFilter(h,{id:"geocoder"}))),d},layer:function(e,r){if("string"==typeof e)return l[e];if("number"==typeof e)return l[n(e)];var t,i;return"handler"in e?(i=e.id=e.id||n(),t=niclabs.insight.handler(e.handler)(h,e)):(t=e,i=t.id),l[i]=t,(r||1===Object.size(l))&&h.active(i),p.add(t.id,t.name),t},data:function(e){return s?s.data(e):[]},active:function(e){if("undefined"==typeof e)return"undefined"!=typeof s?s.id:void 0;if("undefined"!=typeof s&&s.clear(),"number"==typeof e&&(e=n(e)),!(e in l))throw new Error("Layer with id "+e+" does not exist");return s=l[e],s.load(),s.filter(g),s},filter:function(e){return f.filter(e)},clear:function(){s&&s.clear()}},p=niclabs.insight.filter.LayerSelector(h,{id:"layer-selector"});return f.filter(p),h}}(jQuery),niclabs.insight.ElementList=function(){var e=function(e){function r(e){return e="undefined"==typeof e?i++:e,"__"+e}var n={},t={},i=0;return n.element=function(n){if("string"==typeof n)return t[n];if("number"==typeof n)return t[r(n)];var i,a;return"handler"in n?(a=n.id=n.id||r(),i=niclabs.insight.handler(n.handler)(e,n)):(i=n,a=i.id),t[a]=i,i},n.each=function(e){for(var r in t)if(e(r,t[r])===!1)return!1},n.remove=function(e){if("number"==typeof obj&&(e=r(e)),e in t){var n=t[e];return delete t[e],n}},n};return e}(),niclabs.insight.Element=function(e){var r=function(e){if(!("id"in e))throw Error("All UI elements must define an identifier");var r=e.id;if(!/^[^#. '"]+$/.test(r))throw Error("The UI element id must be at least 1 character long and cannot contain the following characters ['#','.',' ', ''', '\"'])");return{get id(){return r}}};return r}(jQuery),niclabs.insight.Filters=function(e){"use strict";return function(e,r){function n(e){var r=!0;return a.each(function(n,t){return t.apply(e)?void 0:(r=!1,!1)}),r}r=r||{};var t=r.id||"insight-filters",i=niclabs.insight.View({id:t});i.$.addClass("filters");var a=niclabs.insight.ElementList(e);return niclabs.insight.event.on("filter_selected",function(e){niclabs.insight.event.trigger("filter_changed",n)}),i.filter=function(e){var r=a.element(e);return i.append(r),r},i}}(jQuery),niclabs.insight.InfoView=function(e){"use strict";var r=function(e,r){r=r||{};var n=r.id||"insight-info-view",t=niclabs.insight.View({id:n});if(t.$.addClass("info"),"none"!==e.config("layout")){var i;"left"===e.config("layout")?i="e":"right"===e.config("layout")&&(i="w"),t.$.resizable(i)}var a=niclabs.insight.ElementList(e);t.block=function(e){var r=a.element(e);return t.$.append(r.element),r};var o;if(r.blocks)for(o=0;o<r.blocks.length;o++)t.block(r.blocks[o]);return t.$.on("resize",function(e){a.each(function(e,r){r.refresh()})}),niclabs.insight.event.on("remove-block",function(e){a.remove(e.id)}),t};return niclabs.insight.handler("basic-info-view","info-view",r),r}(jQuery),niclabs.insight.Interpolation=function(){function e(e,r,n,t){return n+(t-n)*e/r}function r(r,n,t,i){var a=e(r,n,t[0],i[0]),o=e(r,n,t[1],i[1]),s=e(r,n,t[2],i[2]);return[a,o,s]}function n(e,n,t,i){var a=niclabs.insight.Color.rgbToHsv(t[0],t[1],t[2]),o=niclabs.insight.Color.rgbToHsv(i[0],i[1],i[2]),s=r(e,n,a,o);return niclabs.insight.Color.hsvToRgb(s[0],s[1],s[2])}return{interpolate:e,interpolate3d:r,interpolateRgb:n}}(),niclabs.insight.MapView=function(e){"use strict";return function(r){var n="#insight-map-view",t={lat:r.lat||0,lng:r.lng||0},i=r.zoom||12,a=e("<div>").setID(n).addClass("map"),o={get element(){var r=e(n);return a=0===r.length?a:r,a[0]},get $(){var r=e(n);return a=0===r.length?a:r},center:function(e,r){return t.lat=e="undefined"==typeof e?t.lat:e,t.lng=r="undefined"==typeof r?t.lng:r,t},get lat(){return t.lat},get lng(){return t.lng},get width(){return o.$.width()},get height(){return o.$.height()},zoom:function(e){return i=e="undefined"==typeof e?i:e}};return o}}(jQuery),niclabs.insight.View=function(e){var r=function(r){var n=niclabs.insight.Element(r),t=e("<div>").attr("id",n.id);return Object.defineProperty(n,"$",{get:function(){var r=e("#"+n.id);return t=0===r.length?t:r}}),Object.defineProperty(n,"element",{get:function(){return n.$[0]}}),n.append=function(e){return n.$.append(e.$),n},n};return r}(jQuery),niclabs.insight.event=function(){"use strict";function e(e,n){if(e in r)for(var t=0;t<r[e].length;t++)if(r[e][t]===n)return t;return-1}var r={};return{on:function(n,t){var i=e(n,t);return 0>i?(n in r||(r[n]=[]),r[n].push(t)-1):i},off:function(n,t){var i="number"==typeof t?t:e(n,t);return i>=0?(r[n].splice(i,1),!0):!1},trigger:function(e,n){if(e in r)for(var t=0;t<r[e].length;t++)r[e][t](n)}}}(),niclabs.insight.filter={},niclabs.insight.filter.Filter=function(){var e=function(e,r){var n=niclabs.insight.View(r);return n.$.addClass("filter"),n.apply=function(e){return!0},n};return e}(),niclabs.insight.filter.GoogleGeocodingFilter=function(e){var r=function(r,n){var t=niclabs.insight.filter.Filter(r,n);if(!("googlemap"in r.map()))throw new Error("Sorry, Google Geocoding can only be used with Google Maps");var i=new e.maps.Geocoder,a=$("<input>").addClass("search").attr("type","search").attr("placeholder","Enter location");t.$.append(a);var o=function(){var n=r.map().googlemap(),t=a.val();i.geocode({address:t},function(r,i){i==e.maps.GeocoderStatus.OK?(n.setCenter(r[0].geometry.location),n.fitBounds(r[0].geometry.bounds)):a.val("not found: "+t)})};return a.on("change",o),t};return niclabs.insight.handler("google-geocoder","filter",r),r}(google),niclabs.insight.filter.LayerSelector=function(e){var r=function(r,n){var t=niclabs.insight.filter.Filter(r,n),i={},a=e("<select>");return a.hide(),a.on("change",function(){r.active(e(this).val())}),t.$.append(a),t.add=function(r,n){i[r]=n,a.append(e("<option>").attr("value",r).text(n)),i.length>1&&a.show()},t};return niclabs.insight.handler("layer-selector","filter",r),r}(jQuery),niclabs.insight.filter.SelectionFilter=function(e){var r=function(r,n){function t(e){return!0}var i=niclabs.insight.filter.Filter(r,n),a=n.options||[],o=e("<select>");o.append(e("<option>").text(n.description||"")),a.forEach(function(r){o.append(e("<option>").text(r.name))});var s=t;return o.on("change",function(){s=t;var r=e(this).prop("selectedIndex");r>0&&(s=a[r-1].filter),niclabs.insight.event.trigger("filter_selected",i)}),i.$.append(o),i.apply=function(e){return s(e)},i};return niclabs.insight.handler("selection-filter","filter",r),r}(jQuery),niclabs.insight.info=function(){var e=function(e){var r=niclabs.insight.dashboard();if("undefined"==typeof r)throw new Error("Dashboard has not been initialized");return r.info(e)};return e}(),niclabs.insight.info.Block=function(e){"use strict";var r=function(r,n){function t(){niclabs.insight.event.trigger("remove-block",{id:o})}function i(e,r){h=niclabs.insight.event.on("map_element_selected",function(n){r&&n.layer!==r||e.refresh(e.__data__(n))}),p=niclabs.insight.event.on("layer_summary",function(n){r&&n.id!==r||e.refresh(e.__data__(n.data))})}function a(e){niclabs.insight.event.off("map_element_selected",h),niclabs.insight.event.off("layer_summary",p)}if(!("id"in n))throw new Error("All information blocks must have an id");var o=n.id,s="#"===o.charAt(0)?o:"#"+o,l=n.title||"",c={closable:"undefined"==typeof n.closable?!0:n.closable,movable:"undefined"==typeof n.movable?!0:n.movable},u=n.preprocess||function(e){return e},d=e("<div>").addClass("header").append(e("<span>").attr("data-bind","title").addClass("title").append(l)),f=e("<div>").setID(s).addClass("block").append(d),g=e("<div>").addClass("content");f.append(g),c.closable&&f.closable(function(){t()}),c.movable&&f.movable(),f.css(c);var h,p,v,y={},b={get id(){return o},get element(){var r=e(s);return f=0===r.length?f:r,f[0]},get $(){var r=e(s);return f=0===r.length?f:r},get layer(){return v},get content(){var r=e(s).find(".content");return g=0===r.length?g:r},title:function(e){return"undefined"!=typeof e&&(l=e,b.$.find(".title").text(e)),l},__data__:function(e){return"undefined"==typeof e?y:y=0===Object.keys(e).length?{}:u(e)},remove:t,data:function(r){return"undefined"==typeof r?y:(v=void 0,a(b),"string"==typeof r?"#"===r.charAt(0)?(v=r.substring(1),y=n.defaults||{},i(b,v),y):(e.getJSON(r,b.__data__),r):b.__data__("function"==typeof r?r.call(b):r))},refresh:function(e){}};return"data"in n?b.data(n.data):(i(b),y=n.defaults||{}),b};return r}(jQuery),niclabs.insight.info.ChartistBlock=function(e){var r=function(r,n,t){var i=niclabs.insight.info.Block(r,t),a=t.chartist;i.content.addClass("chartist-viz").append(e("<div>").addClass(a["class"]));var o,s=a.options||{},l=a.responsiveOptions||{},c=a.labels,u=i.refresh;i.refresh=function(e){e="undefined"==typeof e?i.data():e,u(e),e=e.value||e;var r={series:e,labels:"function"==typeof c?c(e):c};o&&o.optionsProvider?o.update(r):o=new n(i.content.find("div")[0],r,s,l)};var d=i.remove;return i.remove=function(){d(),o.detach()},i.refresh(),i},n=function(e,n){var t=r(e,Chartist.Line,n);return t},t=function(e,n){var t=r(e,Chartist.Bar,n);return t},i=function(e,n){var t=r(e,Chartist.Pie,n);return t};return niclabs.insight.handler("chartist-linechart","info-block",n),niclabs.insight.handler("chartist-barchart","info-block",t),niclabs.insight.handler("chartist-piechart","info-block",i),r}(jQuery),niclabs.insight.info.SummaryBlock=function(e){var r=function(e,r){var n=niclabs.insight.info.Block(e,r),t=r.template||'        <h6 class="latLngView" data-if="lat">             lat: <span data-bind="lat"> -- </span>             lng: <span data-bind="lng"> -- </span>         </h6>        <dl class="deflist">            <dt class="deflist-key" data-if="description">description</dt>             <dd class="deflist-value" data-bind="description">none</dd>             <dt class="deflist-key" data-if="landmark">landmark</dt>             <dd class="deflist-value" data-bind="landmark">none</dd>             <dt class="deflist-key" data-if="fun-fact">fun-fact</dt>             <dd class="deflist-value" data-bind="fun-fact">none</dd>         </dl>        ';n.content.template(t);var i=n.refresh;return n.refresh=function(e){e="undefined"!=typeof e?e:n.data(),i(e),n.content.trigger("render",e)},n.refresh(),n};return niclabs.insight.handler("summary-block","info-block",r),r}(jQuery),niclabs.insight.layer=function(){var e=function(e,r){var n=niclabs.insight.dashboard();if("undefined"==typeof n)throw new Error("Dashboard has not been initialized");return n.layer(e,r)};return e}(),niclabs.insight.layer.DiagramLayer=function(e){var r=function(r,n){function t(n,t){var i;if("type"in t){var o={layer:a.id,data:n};e.extend(o,t),i=niclabs.insight.handler(t.type)(r,o)}else i=t;return i}var i,a=niclabs.insight.layer.Layer(r,n),o=n.diagram||{type:"voronoi-diagram"};return a.draw=function(e){i=t(e,o)},a.clear=function(){i&&i.clear()},a.filter=function(e){},a};return niclabs.insight.handler("diagram-layer","layer",r),r}(jQuery),niclabs.insight.layer.GraphLayer=function(e){var r=function(r,n){function t(n,t,i){var o;if("type"in i){var s={layer:a.id};e.extend(s,i,n[t]),o=niclabs.insight.handler("node")(r,s)}else o=i;return o.clickable(!0),o}function i(n,t,i,o){var s;if("type"in o){var l={layer:a.id};e.extend(l,o,{startNode:n[t],endNode:n[i]}),s=niclabs.insight.handler("edge")(r,l)}else s=o;return s.clickable(!0),s}var a=niclabs.insight.layer.Layer(r,n),o=n.graph||{type:"simple-graph"},s=[],l=[];return a.draw=function(e){for(var r=0;r<e.length;r++)s.push(t(e,r,o));for(r=0;r<o.adj.length;r++)for(var n=0;r>n;n++)1==o.adj[r][n]&&l.push(i(e,r,n,o))},a.clear=function(){},a.filter=function(e){},a};return niclabs.insight.handler("graph-layer","layer",r),r}(jQuery),niclabs.insight.layer.GridLayer=function(){var e=function(e,r){function n(r,n){var t;if("type"in n){var a={layer:i.id,data:r};$.extend(a,n),t=niclabs.insight.handler(n.type)(e,a)}else t=n;return t}var t,i=niclabs.insight.layer.Layer(e,r),a=r.grid||{type:"hexagon"};return i.draw=function(e){t=n(e,a)},i.clear=function(){t&&t.clear()},i.filter=function(e){},i};return niclabs.insight.handler("grid-layer","layer",e),e}(),niclabs.insight.layer.HeatmapLayer=function(e){var r=function(r,n){function t(n,t){var i;if("type"in t){var o={layer:a.id,data:n};e.extend(o,t),i=niclabs.insight.handler(t.type)(r,o)}else i=t;return i}var i,a=niclabs.insight.layer.Layer(r,n),o=n.heatmap||{type:"point-heatmap"};return a.draw=function(e){i=t(e,o)},a.clear=function(){i&&i.clear()},a.filter=function(e){},a};return niclabs.insight.handler("heatmap-layer","layer",r),r}(jQuery),niclabs.insight.layer.Layer=function(e){"use strict";var r=function(r,n){if(!("id"in n))throw Error("All layers must have an id.");var t=n.id,i=n.name||n.id;if(!("data"in n))throw Error("All layers must provide a data source.");var a=!1,o=[];

"string"==typeof n.data?a=n.data:o=n.data&&Array.isArray(n.data)?n.data:[n.data];var s=n.summary||!1,l=!1,c={get id(){return t},get name(){return i},data:function(e){return"undefined"==typeof e?l||!a?o:a:"string"==typeof e?a=e:(o=e.length?e:[e],l&&c.load(),o)},load:function(){function r(e){if(o=e,niclabs.insight.event.trigger("layer_data",{id:t,data:o}),c.clear(),s){var r=s;"function"==typeof s&&(r=s(o)),niclabs.insight.event.trigger("layer_summary",{id:t,data:r})}c.draw(o),l=!0}a?e.getJSON(a,r):r(o)},draw:function(e){},filter:function(e){},clear:function(){}};return c};return r}(jQuery),niclabs.insight.layer.MarkerLayer=function(e){var r=function(r,n){function t(n,t,a){var o;if("type"in a){var s={layer:i.id};e.extend(s,a,n[t]),o=niclabs.insight.handler(s.type)(r,s)}else o=a;return o.clickable(!0),o}var i=niclabs.insight.layer.Layer(r,n),a=n.marker||{type:"simple-marker"},o=[];return i.draw=function(e){for(var r=0;r<e.length;r++)o.push(t(e,r,a))},i.clear=function(){for(var e=0;e<o.length;e++)o[e].clear();o=[]},i.filter=function(e){for(var r=i.data(),n=0;n<o.length;n++)o[n].visible(e(r[n]))},i};return niclabs.insight.handler("marker-layer","layer",r),r}(jQuery),niclabs.insight.map=function(){"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),"undefined"==typeof Number.prototype.toDeg&&(Number.prototype.toDeg=function(){return 180*this/Math.PI});var e=function(e){var r=niclabs.insight.dashboard();if("undefined"==typeof r)throw new Error("Dashboard has not been initialized");return r.map(e)};return e}(),niclabs.insight.map.GoogleMercator=function(){function e(e,r,n){return null!==r&&(e=Math.max(e,r)),null!==n&&(e=Math.min(e,n)),e}var r=256,n={x:r/2,y:r/2},t=r/360,i=r/(2*Math.PI);return{geographic:function(e){var r=(e.x-n.x)/t,a=(e.y-n.y)/-i,o=(2*Math.atan(Math.exp(a))-Math.PI/2).toDeg();return{lat:o,lng:r}},cartesian:function(r){"function"==typeof r.lat&&"function"==typeof r.lng&&(r={lat:r.lat(),lng:r.lng()});var a=n.x+r.lng*t,o=e(Math.sin(r.lat.toRad()),-.9999,.9999),s=n.y+.5*Math.log((1+o)/(1-o))*-i;return{x:a,y:s}},distance:function(e,r){return r="undefined"!=typeof r?r:12,e/(1<<r)}}}(),niclabs.insight.map.GoogleMap=function(e){"use strict";var r=function(e,r){var n=niclabs.insight.MapView(r),t=new google.maps.Map(n.element,{zoom:n.zoom(),center:new google.maps.LatLng(n.lat,n.lng),disableDefaultUI:!0}),i=n.zoom;google.maps.event.addListener(t,"zoom_changed",function(){i(t.getZoom())}),n.zoom=function(e){return e=i(e),t.setZoom(e),e};var a=n.center;return google.maps.event.addListener(t,"center_changed",function(){var e=t.getCenter();a(e.lat(),e.lng())}),n.center=function(e,r){var n=a(e,r);return t.setCenter({lat:n.lat,lng:n.lng}),n},n.googlemap=function(){return t},n};return niclabs.insight.handler("google-map","map-view",r),r}(jQuery),niclabs.insight.quadtree={},niclabs.insight.quadtree.Bounds=function(){var e=function(e,r){var n={x:(e.x+r.x)/2,y:(e.y+r.y)/2};return{get center(){return n},get min(){return e},get max(){return r},contains:function(n){return e.x<=n.x&&n.x<r.x&&e.y<=n.y&&n.y<r.y},intersects:function(n){return r.x<n.min.x?!1:e.x>n.max.x?!1:r.y<n.min.y?!1:e.y>n.max.y?!1:!0}}};return e}(),niclabs.insight.quadtree.PointQuadTree=function(){var e=function(r,n,t){function i(){a=e(niclabs.insight.quadtree.Bounds(r.min,r.center),n,t-1),o=e(niclabs.insight.quadtree.Bounds({x:r.center.x,y:r.min.y},{x:r.max.x,y:r.center.y}),n,t-1),s=e(niclabs.insight.quadtree.Bounds({x:r.min.x,y:r.center.y},{x:r.center.x,y:r.max.y}),n,t-1),l=e(niclabs.insight.quadtree.Bounds(r.center,r.max,n,t-1))}n=n||50,t=t||40;var a,o,s,l,c=[],u={get capacity(){return n},get bounds(){return r},insert:function(e){return r.contains(e)?c.length<n||0>=t?(c.push(e),!0):(void 0===a&&i(),a.insert(e)?!0:o.insert(e)?!0:s.insert(e)?!0:l.insert(e)?!0:!1):!1},query:function(e,n){if(n="undefined"==typeof n?[]:n,!r.intersects(e))return n;for(var t=0;t<c.length;t++)e.contains(c[t])&&n.push(c[t]);return void 0===a?n:(a.query(e,n),o.query(e,n),s.query(e,n),l.query(e,n),n)}};return u};return e}(),niclabs.insight.map.diagram=function(e){return{createLines:function(e,r){var n=180/Math.PI;if(!(r.length<2)){for(var t=e[r[0]],i=[t],a=0,o=1;o<r.length;o++)a=e[r[o]],i=i.concat(this.SplitSegment(t,a),[a]),t=a;for(var s=[],l=0;l<i.length;l++){a=i[l];var c=n*Math.atan2(a[2],Math.sqrt(a[0]*a[0]+a[1]*a[1])),u=n*Math.atan2(a[1],a[0]);s.push([c,u])}return s}},SplitSegment:function(e,r){for(var n=0,t=0;3>t;t++){var i=r[t]-e[t];n+=i*i}var a=[];if(.01>n)return a;var o=new Array(3);for(t=0;3>t;t++)o[t]=e[t]+r[t];var s=0;for(t=0;3>t;t++)pc=o[t],s+=pc*pc;var l=1/Math.sqrt(s);for(t=0;3>t;t++)o[t]*=l;return a.concat(this.SplitSegment(e,o),[o],this.SplitSegment(o,r))},transformMapPositions:function(e){var r=Math.PI/180,n=[];for(i=0;i<e.length;i++){for(var t=e[i],a=r*t.lat,o=r*t.lng,s=Math.cos(a),l=[s*Math.cos(o),s*Math.sin(o),Math.sin(a)],c=0;3>c;c++)l[c]+=1e-10*(2*Math.random()-1);var u=0;for(c=0;3>c;c++)u+=l[c]*l[c];var d=1/Math.sqrt(u);for(c=0;3>c;c++)l[c]*=d;n.push(l)}return n}}}(jQuery),niclabs.insight.map.diagram.DelaunayDiagram=function(e){var r=function(e,r){function n(e){for(var n=[],t=e.length,i=[],a=0;t>a;a++)i[a]=new google.maps.LatLng(e[a].lat,e[a].lng);var o=niclabs.insight.map.diagram.transformMapPositions(e),s=FindDelaunayTriangulation(o),l=[];for(a=0;a<s.edges.length;a++){var c=s.edges[a];n=niclabs.insight.map.diagram.createLines(s.positions,c.verts);for(var u=[],d=0;d<n.length;d++)u.push(new google.maps.LatLng(n[d][0],n[d][1]));var f=new google.maps.Polyline({path:u,strokeColor:r.strokeColor||"#FF0000",strokeWeight:r.strokeWeight||2,strokeOpacity:r.strokeOpacity||1,clickable:!1});l.push(f)}for(markers=[],a=0;a<i.length;a++){var g=new google.maps.Marker({position:i[a],title:e[a].landmark||""});markers[a]=g}return{Polylines:l,Markers:markers}}if(!("data"in r))throw Error("No data provided for the diagram");var t=niclabs.insight.map.diagram.Diagram(e,r),i=n(r.data);t.setMap(i,t.map.googlemap());var a=t.clear;return t.clear=function(){a(),t.setMap(i,null)},t};return niclabs.insight.handler("delaunay-diagram","diagram",r),r}(jQuery),niclabs.insight.map.diagram.Diagram=function(e){var r=function(e,r){if(!("layer"in r))throw new Error("The Diagram must be associated to a layer");var n;if(!(n=e.layer(r.layer)))throw new Error("The layer "+n+" does not exist in the dashboard");var t;if(!(t=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in t))throw new Error("Diagrams are only supported for Google Maps at the moment");var i={get map(){return t},get layer(){return n},clear:function(){},setMap:function(e,r){for(var n in e.Polylines)e.Polylines[n].setMap(r);for(var t in e.Markers)e.Markers[t].setMap(r)}};return i};return r}(jQuery),niclabs.insight.map.diagram.VoronoiDiagram=function(e){var r=function(e,r){function n(e){for(var n=[],t=e.length,i=[],a=0;t>a;a++)i[a]=new google.maps.LatLng(e[a].lat,e[a].lng);var o=niclabs.insight.map.diagram.transformMapPositions(e),s=FindDelaunayTriangulation(o),l=[];for(a=0;a<s.vor_edges.length;a++){var c=s.vor_edges[a];if(!(c[0]<0||c[1]<0)){n=niclabs.insight.map.diagram.createLines(s.vor_positions,c);for(var u=[],d=0;d<n.length;d++)u.push(new google.maps.LatLng(n[d][0],n[d][1]));var f=new google.maps.Polyline({path:u,strokeColor:r.strokeColor||"#FF0000",strokeWeight:r.strokeWeight||2,strokeOpacity:r.strokeOpacity||1,clickable:!1});l.push(f)}}for(markers=[],a=0;a<i.length;a++){var g=new google.maps.Marker({position:i[a],title:e[a].landmark||""});markers[a]=g}return{Polylines:l,Markers:markers}}if(!("data"in r))throw Error("No data provided for the diagram");var t=niclabs.insight.map.diagram.Diagram(e,r),i=n(r.data);t.setMap(i,t.map.googlemap());var a=t.clear;return t.clear=function(){a(),t.setMap(i,null)},t};return niclabs.insight.handler("voronoi-diagram","diagram",r),r}(jQuery),niclabs.insight.map.graph={},niclabs.insight.map.graph.Edge=function(e){var r=function(e,r){var n=niclabs.insight.map.graph.GraphElement(e,r),t=[];t[0]=new google.maps.LatLng(r.startNode.lat,r.startNode.lng),t[1]=new google.maps.LatLng(r.endNode.lat,r.endNode.lng);var i=new google.maps.Polyline({path:t,strokeColor:"#000000",strokeOpacity:1,strokeWeight:10});return i.setMap(n.map.googlemap()),n.graphElement=function(){return i},n.clickable=function(){var e=n.graphElement();return listener=google.maps.event.addListener(e,"click",function(){niclabs.insight.event.trigger("map_element_selected",r),"setOptions"in e&&(e.setOptions({strokeColor:"#FF0000"}),setTimeout(function(){e.setOptions({strokeColor:"#000000"})},1e3))}),listener},n};return niclabs.insight.handler("edge","graph",r),r}(jQuery),niclabs.insight.map.graph.GraphElement=function(e){var r=function(e,r){if(!("layer"in r))throw new Error("The marker must be associated to a layer");var n;if(!(n=e.layer(r.layer)))throw new Error("The layer "+n+" does not exist in the dashboard");var t;if(!(t=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in t))throw new Error("Markers are only supported for Google Maps at the moment");var i={get map(){return t},get layer(){return n},graphElement:function(){return void 0},clickable:function(e){},clear:function(){i.graphElement();graphElement.setMap(null)},visible:function(e){return"undefined"==typeof e?i.graphElement().getVisible():(i.graphElement().setVisible(e),e)}};return i};return r}(jQuery),niclabs.insight.map.graph.Node=function(e){var r=function(e,r){var n=niclabs.insight.map.graph.GraphElement(e,r),t=new google.maps.LatLng(parseFloat(r.lat),parseFloat(r.lng)),i=new google.maps.Marker({position:t,map:n.map.googlemap(),title:r.landmark||""});return n.graphElement=function(){return i},n.clickable=function(){var e=n.graphElement();return listener=google.maps.event.addListener(e,"click",function(){niclabs.insight.event.trigger("map_element_selected",r),"setAnimation"in e&&(e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},1e3))}),listener},n};return niclabs.insight.handler("node","graph",r),r}(jQuery),niclabs.insight.map.grid={},niclabs.insight.map.grid.Grid=function(){function e(e,r){return e=niclabs.insight.Color.hexToRgb(e),r=niclabs.insight.Color.hexToRgb(r),function(n){var t=0,a=0;for(i=0;i<n.length;i++)"weight"in n[i]&&(t+=n[i].weight,a++);return a>0?(t/=a,niclabs.insight.Color.rgbToHex(niclabs.insight.Interpolation.interpolateRgb(t,1,e,r))):"#ffffff"}}function r(e,r){function n(e,r,n){for(var t,i=Math.floor((r+n)/2);n>=r;){for(;e[r].weight<e[i].weight;)r++;for(;e[n].weight>e[i].weight;)n--;n>=r&&(t=e[r],e[r]=e[n],e[n]=t,r++,n--)}return i}return e=niclabs.insight.Color.hexToRgb(e),r=niclabs.insight.Color.hexToRgb(r),function(t){var i=0,a=0,o=t.length>0?t.length-1:0,s=Math.floor((a+o)/2);for(i=n(t,a,o);i!==s;)i=s>i?n(t,s,o):n(t,a,s);return niclabs.insight.Color.rgbToHex(niclabs.insight.Interpolation.interpolateRgb(t[i].weight,1,e,r))}}var n=function(n,t){function i(){return"#ffffff"}function a(e){return function(){niclabs.insight.event.trigger("map_element_selected",e)}}function o(){for(var e=0;e<d.length;e++)d[e].setMap(null)}function s(e){e="undefined"!=typeof e?e:u.googlemap().getBounds(),o(),l(e),b.toggle(!0)}function l(e){if(e){for(var r,n,t=m.tile(),i=p.query(niclabs.insight.quadtree.Bounds(niclabs.insight.map.GoogleMercator.cartesian({lat:e.getNorthEast().lat(),lng:e.getSouthWest().lng()}),niclabs.insight.map.GoogleMercator.cartesian({lat:e.getSouthWest().lat(),lng:e.getNorthEast().lng()}))),o=[],s=0;s<i.length;s++){var l=t.query(i[s]);r=l[0],n=l[1],o[r]||(o[r]=[]),o[r][n]||(o[r][n]=[]),o[r][n].push(i[s])}d=[];for(r in o)for(n in o[r]){f.fillColor=g(o[r][n]);var c=t.draw(t.origin(r,n),m.map,f);google.maps.event.addListener(c,"click",a(o[r][n])),d.push(c)}}}if(!("layer"in t))throw new Error("The grid must be associated to a layer");var c;if(!(c=n.layer(t.layer)))throw new Error("The layer "+c+" does not exist in the dashboard");var u;if(!(u=n.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in u))throw new Error("Grids are only supported for Google Maps at the moment");var d=[],f={strokeColor:"strokeColor"in t?t.strokeColor:"#000000",strokeOpacity:"strokeOpacity"in t?t.strokeOpacity:.6,strokeWeight:"strokeWeight"in t?t.strokeWeight:2,fillOpacity:"fillOpacity"in t?t.fillOpacity:.6},g=t.fill||i;"string"==typeof g&&(g="#"===t.fill.charAt(0)?function(){return t.fill}:"average"===t.fill?e(t.fillStart||"#ff0000",t.fillEnd||"#00ff00"):"median"===t.fill?r(t.fillStart||"#ff0000",t.fillEnd||"#00ff00"):i);for(var h=niclabs.insight.quadtree.Bounds(niclabs.insight.map.GoogleMercator.cartesian({lat:90,lng:-180}),niclabs.insight.map.GoogleMercator.cartesian({lat:-90,lng:180})),p=niclabs.insight.quadtree.PointQuadTree(h),v=0;v<t.data.length;v++){var y=niclabs.insight.map.GoogleMercator.cartesian(t.data[v]);t.data[v].x=y.x,t.data[v].y=y.y,p.insert(t.data[v])}var b=function(){var e;return{toggle:function(r){r&&"undefined"==typeof e?e=google.maps.event.addListener(m.map.googlemap(),"bounds_changed",function(){s(this.getBounds())}):r||"undefined"==typeof e||(google.maps.event.removeListener(e),e=void 0)}}}(),m={get map(){return u},get layer(){return c},refresh:s,tile:function(){throw new Error("Not implemented")},clear:function(){o(),b.toggle(!1)}};return m};return n}(),niclabs.insight.map.grid.HexagonTile=function(){var e=function(e){var r=Math.cos(Math.PI/6)*e,n=Math.sin(Math.PI/6)*e,t=niclabs.insight.map.grid.Tile();return Object.defineProperty(t,"s",{get:function(){return e}}),Object.defineProperty(t,"r",{get:function(){return r}}),Object.defineProperty(t,"h",{get:function(){return n}}),t.origin=function(){var t,i;1==arguments.length?(t=arguments[0][0],i=arguments[0][1]):(t=arguments[0],i=arguments[1]);var a=2*t*r+(1&i)*r+r,o=i*(n+e);return{x:a,y:o}},t.query=function(t){t.lat&&(t=niclabs.insight.map.GoogleMercator.cartesian(t));var i=Math.floor(t.x/(2*r)),a=Math.floor(t.y/(n+e)),o=t.x-2*i*r,s=t.y-a*(n+e),l=0===(1&a),c=i,u=a;return l?r>=o&&-n/r*o+n>s?(c=i-1,u=a-1):o>r&&n/r*o-n>s&&(c=i,u=a-1):r>=o?n/r*o>s?(c=i,u=a-1):(c=i-1,u=a):o>r&&-n/r*o+2*n>s&&(c=i,u=a-1),[c,u]},t.vertices=function(t){t.lat&&(t=niclabs.insight.map.GoogleMercator.cartesian(t));var i=[];return i[0]={x:t.x,y:t.y},i[1]={x:t.x+r,y:t.y+n},i[2]={x:t.x+r,y:t.y+e+n},i[3]={x:t.x,y:t.y+e+n+n},i[4]={x:t.x-r,y:t.y+e+n},i[5]={x:t.x-r,y:t.y+n},i},t};return e}(),niclabs.insight.map.grid.HexagonalGrid=function(){var e=function(e,r){var n=niclabs.insight.map.grid.Grid(e,r);return n.tile=function(){return niclabs.insight.map.grid.HexagonTile(niclabs.insight.map.GoogleMercator.distance(r.size,n.map.zoom()))},n.refresh(),n};return niclabs.insight.handler("hexagon","grid",e),e}(),niclabs.insight.map.grid.SquareGrid=function(){var e=function(e,r){var n=niclabs.insight.map.grid.Grid(e,r);return n.tile=function(){return niclabs.insight.map.grid.SquareTile(niclabs.insight.map.GoogleMercator.distance(r.size,n.map.zoom()))},n.refresh(),n};return niclabs.insight.handler("square","grid",e),e}(),niclabs.insight.map.grid.SquareTile=function(){var e=function(e){var r=niclabs.insight.map.grid.Tile();return Object.defineProperty(r,"s",{get:function(){return e}}),r.origin=function(){var r,n;1==arguments.length?(r=arguments[0][0],n=arguments[0][1]):(r=arguments[0],n=arguments[1]);var t=r*e,i=n*e;return{x:t,y:i}},r.query=function(r){r.lat&&(r=niclabs.insight.map.GoogleMercator.cartesian(r));var n=Math.floor(r.x/e),t=Math.floor(r.y/e);return[n,t]},r.vertices=function(r){r.lat&&(r=niclabs.insight.map.GoogleMercator.cartesian(r));var n=[];return n[0]={x:r.x,y:r.y},n[1]={x:r.x,y:r.y+e},n[2]={x:r.x+e,y:r.y+e},n[3]={x:r.x+e,y:r.y},n},r};return e}(),niclabs.insight.map.grid.Tile=function(){var e=function(){var e={origin:function(e,r){throw new Error("Not implemented")},query:function(e){throw new Error("Not implemented")},vertices:function(e){throw new Error("Not implemented")},draw:function(r,n,t){if(!("googlemap"in n))throw new Error("Sorry, I only know how to draw on Google Maps at the moment");for(var i=e.vertices(r),a=[],o=0;o<i.length;o++)a.push(niclabs.insight.map.GoogleMercator.geographic(i[o]));t=t||{strokeColor:"#000000",strokeOpacity:.6,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.6},t.paths=a,t.geodesic=!0;var s=new google.maps.Polygon(t);return s.setMap(n.googlemap()),s}};return e};return e}(),niclabs.insight.map.heatmap={},niclabs.insight.map.heatmap.Heatmap=function(e){var r=function(e,r){if(!("layer"in r))throw new Error("The heatmap must be associated to a layer");var n;if(!(n=e.layer(r.layer)))throw new Error("The layer "+n+" does not exist in the dashboard");var t;if(!(t=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in t))throw new Error("Heatmaps are only supported for Google Maps at the moment");var i={get map(){return t},get layer(){return n},clear:function(){}};return i};return r}(jQuery),niclabs.insight.map.heatmap.PointHeatmap=function(e){var r=function(e,r){function n(e){for(var n=new google.maps.MVCArray,t=0;t<e.length;t++)n.push("weight"in e[t]?{location:new google.maps.LatLng(e[t].lat,e[t].lng),weight:e[t].weight}:new google.maps.LatLng(e[t].lat,e[t].lng));return new google.maps.visualization.HeatmapLayer({data:n,radius:r.radius||10})}if(!("data"in r))throw Error("No data provided for the heatmap");var t=niclabs.insight.map.heatmap.Heatmap(e,r),i=n(r.data);"undefined"!=typeof r.dissipating&&i.set("dissipating",r.dissipating),"undefined"!=typeof r.gradient&&i.set("gradient",r.gradient),"undefined"!=typeof r.opacity&&i.set("opacity",r.opacity),i.setMap(t.map.googlemap());var a=t.clear;return t.clear=function(){a(),i.setMap(null)},t};return niclabs.insight.handler("point-heatmap","heatmap",r),r}(jQuery),niclabs.insight.map.heatmap.SegmentHeatmap=function(e){var r=function(e,r){function n(e){var n=new google.maps.MVCArray;for(i=0;i<e.length;i++){segment_size=e[i].coordinates.length;for(var t=0;t<segment_size-1;t++)for(var a=Math.sqrt(Math.pow(e[i].coordinates[t+1][0]-e[i].coordinates[t][0],2)+Math.pow(e[i].coordinates[t+1][1]-e[i].coordinates[t][1],2)),o=Math.floor(a/1e-5),s={lat:(e[i].coordinates[t+1][0]-e[i].coordinates[t][0])/o,lng:(e[i].coordinates[t+1][1]-e[i].coordinates[t][1])/o},l=0;o>l;l++)n.push("weight"in e[i]?{location:new google.maps.LatLng(e[i].coordinates[t][0]+s.lat*l,e[i].coordinates[t][1]+s.lng*l),weight:e[i].weight}:new google.maps.LatLng(e[i].coordinates[t][0]+s.lat*l,e[i].coordinates[t][1]+s.lng*l))}return new google.maps.visualization.HeatmapLayer({data:n,radius:r.radius||10})}if(!("data"in r))throw Error("No data provided for the heatmap");var t=niclabs.insight.map.heatmap.Heatmap(e,r),a=n(r.data);"undefined"!=typeof r.dissipating&&a.set("dissipating",r.dissipating),"undefined"!=typeof r.gradient&&a.set("gradient",r.gradient),"undefined"!=typeof r.opacity&&a.set("opacity",r.opacity),a.setMap(t.map.googlemap());var o=t.clear;return t.clear=function(){o(),a.setMap(null)},t};return niclabs.insight.handler("segment-heatmap","heatmap",r),r}(jQuery),niclabs.insight.map.marker={},niclabs.insight.map.marker.CircleMarker=function(e){var r=function(e,r){var n=niclabs.insight.map.marker.Marker(e,r),t=new google.maps.LatLng(parseFloat(r.lat),parseFloat(r.lng)),i=new google.maps.Circle({center:t,map:n.map.googlemap(),radius:r.radius||400,strokeColor:r.strokeColor||"#FF0000",strokeOpacity:r.strokeOpacity||.8,strokeWeight:r.strokeWeight||2,fillColor:r.fillColor||"#FF0000",fillOpacity:r.fillOpacity||.35,title:r.landmark||""});return n.marker=function(){return i},n};return niclabs.insight.handler("circle-marker","marker",r),r}(jQuery),niclabs.insight.map.marker.ImageMarker=function(e){var r=function(e,r){var n=niclabs.insight.map.marker.Marker(e,r),t=new google.maps.LatLng(parseFloat(r.lat),parseFloat(r.lng));if(!("src"in r))throw new Error("An image source must be provided for using image markers");var i={url:r.src,scaledSize:new google.maps.Size(30,50)},a=new google.maps.Marker({position:t,map:n.map.googlemap(),icon:i,title:r.landmark||""});return n.marker=function(){return a},n};return niclabs.insight.handler("image-marker","marker",r),r}(jQuery),niclabs.insight.map.marker.Marker=function(e){var r=function(e,r){if(!("layer"in r))throw new Error("The marker must be associated to a layer");var n;if(!(n=e.layer(r.layer)))throw new Error("The layer "+n+" does not exist in the dashboard");var t;if(!(t=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in t))throw new Error("Markers are only supported for Google Maps at the moment");var i,a={get map(){return t},get layer(){return n},marker:function(){return void 0},clickable:function(e){if(e){var n=a.marker();i=google.maps.event.addListener(n,"click",function(){niclabs.insight.event.trigger("map_element_selected",r),"setAnimation"in n&&(n.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){n.setAnimation(null)},3e3))})}else"undefined"!=typeof i&&(google.maps.event.removeListener(i),i=void 0);return void 0!==i},clear:function(){var e=a.marker();e.setMap(null)},visible:function(e){return"undefined"==typeof e?a.marker().getVisible():(a.marker().setVisible(e),e)}};return a};return r}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(e){var r=function(e,r){var n=niclabs.insight.map.marker.Marker(e,r),t=new google.maps.LatLng(parseFloat(r.lat),parseFloat(r.lng)),i=new google.maps.Marker({position:t,map:n.map.googlemap(),title:r.landmark||""});return n.marker=function(){return i},n};return niclabs.insight.handler("simple-marker","marker",r),r}(jQuery),TriangleObject.prototype.copy_vert_info=function(e){this.verts=e.verts,this.dirs=e.dirs,this.vol=e.vol,this.ccdir=e.ccdir,this.ccdsq=e.ccdsq},TriangleObject.prototype.IsVertexOrderCorrect=function(){return this.vol>=0},TriangleObject.prototype.IsPointInside=function(e){for(var r=0;3>r;r++)if(dotprd(e,this.dirs[r])<0)return!1;return!0},TriangleObject.prototype.IsPointInCircumcircle=function(e){return ptdist(this.ccdir,e)<this.ccdsq},TriangleObject.prototype.IsVertex=function(e){for(var r=0;3>r;r++)if(e==this.verts[r])return!0;return!1},TriangleObject.prototype.VertexIndexIn=function(e){for(var r=0;3>r;r++)if(e==this.verts[r])return r;return-1},TriangleObject.prototype.EdgeIndexIn=function(e){for(var r=0;3>r;r++)if(EdgesEqual(this.edges[r],e))return r;return-1},EdgeObject.prototype.IsVertex=function(e){for(var r=0;2>r;r++)if(e==this.verts[r])return!0;return!1},EdgeObject.prototype.VertexIndexIn=function(e){for(var r=0;2>r;r++)if(e==this.verts[r])return r;return-1},EdgeObject.prototype.PolyIndexIn=function(e){for(var r=0;2>r;r++)if(TrianglesEqual(this.polys[r],e))return r;return-1},EdgeCheckObject.prototype.intersects=function(e,r){for(var n=0;2>n;n++)for(var t=0;2>t;t++)if(this.verts[n]==r.verts[t])return!1;var i=Normalize(crsprd(this.direc,r.direc)),a=dotprd(i,this.midpnt)>0,o=dotprd(i,r.midpnt)>0;if(o!=a)return!1;var s,l=[];for(n=0;2>n;n++)s=ptdist(i,e[this.verts[n]]),l.push(s);var c=[];for(n=0;2>n;n++)s=ptdist(i,e[r.verts[n]]),c.push(s);var u=max(l[0],l[1]),d=max(c[0],c[1]);if(u<=this.pdst&&d<=r.pdst&&a)return!0;for(vec_mult_scalar_to(i,-1),a=!a,n=0;2>n;n++)l[n]=-l[n],c[n]=-c[n];return u=max(l[0],l[1]),d=max(c[0],c[1]),u<=this.pdst&&d<=r.pdst&&a?!0:!1};