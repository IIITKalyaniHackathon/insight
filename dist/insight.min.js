var niclabs={};niclabs.insight=function(n){"use strict";Array.prototype.forEach||(Array.prototype.forEach=function(n,e){var t,r;if(null===this)throw new TypeError(" this is null or not defined");var i=Object(this),a=i.length>>>0;if("function"!=typeof n)throw new TypeError(n+" is not a function");for(arguments.length>1&&(t=e),r=0;a>r;){var o;r in i&&(o=i[r],n.call(t,o,r,i)),r++}}),n.fn.template=function(e){"undefined"==typeof e?e=this.html():"string"==typeof e&&"#"===e.charAt(0)&&(e=n(e).html());var t=this;return this.bind("render",function(r,i){t.empty().append(e),t.find("[data-bind],[data-if]").each(function(){var e=n(this).attr("data-bind")||n(this).attr("data-if"),t=n(this).prop("tagName");e in i?n(this).attr("data-bind")&&("img"===t?n(this).attr("src",i[e]):"input"===t?n(this).val(i[e]):n(this).text(i[e])):n(this).detach()})}),this},n.fn.resizable=function(e){function t(e){o=e.clientX,s=e.clientY,l=h.outerWidth(),c=h.outerHeight(),n(document).on("mousemove",r),n(document).on("mouseup",i)}function r(n){f&&h.css("height",c+n.clientY-s+"px"),u&&h.css("width",l+n.clientX-o+"px"),d&&h.css("top",n.clientY+"px").css("height",c+s-n.clientY+"px"),g&&h.css("left",n.clientX+"px").css("width",l-n.clientX+"px")}function i(){n(document).off("mousemove",r),n(document).off("mouseup",i),h.trigger("resize")}var a=n("<div>").addClass("resizer").addClass(e+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",t);var o,s,l,c,u,f,d,g,h=this;return f=e.search("s")>=0,u=e.search("e")>=0,d=e.search("n")>=0,g=e.search("w")>=0,this.scroll(function(){a.css("top",h.scrollTop())}),this},n.fn.setID=function(n){return"#"===n.charAt(0)&&(n=n.slice(1)),this.attr("id",n),this},n.fn.movable=function(){var e=this.children(".header");0===e.length&&(e=n("<div>").addClass("header"),this.prepend(e));var t=n("<span>").addClass("button").attr("data-icon","up-arrow"),r=n("<span>").addClass("button").attr("data-icon","down-arrow");e.append(t),e.append(r);var i=this;return t.on("click",function(){i.insertBefore(i.prev())}),r.on("click",function(){i.insertAfter(i.next())}),this},n.fn.closable=function(e){e||(e=function(){});var t=this.children(".header");t.length||(t=n("<span>").addClass("header"),this.prepend(t));var r=n("<span>").addClass("button").attr("data-icon","close");t.prepend(r);var i=this;return r.on("click",function(){i.remove(),e()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(e,t){return n.inArray(e,this,t)},Object.size=function(n){var e,t=0;for(e in n)n.hasOwnProperty(e)&&t++;return t},Object.prototype.watch||Object.defineProperty(Object.prototype,"watch",{enumerable:!1,configurable:!0,writable:!1,value:function(n,e){var t=this[n],r=function(){return t},i=function(r){return t===r?!1:(e.call(this,n,t,r),void(t=r))};delete this[n]&&Object.defineProperty(this,n,{get:r,set:i,enumerable:!0,configurable:!0})}}),Object.prototype.unwatch||Object.defineProperty(Object.prototype,"unwatch",{enumerable:!1,configurable:!0,writable:!1,value:function(n){var e=this[n];delete this[n],this[n]=e}}),Object.prototype.spy||Object.defineProperty(Object.prototype,"spy",{enumerable:!1,configurable:!0,writable:!1,value:function(n){for(var e in this)this.hasOwnProperty(e)&&this.watch(e,n)}}),Object.prototype.unspy||Object.defineProperty(Object.prototype,"unspy",{enumerable:!1,configurable:!0,writable:!1,value:function(){for(var n in this)this.hasOwnProperty(n)&&this.unwatch(n)}});var e,t={};return{handler:function(n,e,r){if(n in t){if(e="undefined"==typeof e?t[n].kind:e,r="undefined"==typeof r?t[n].handler:r,e!==t[n].kind)throw new Error("There already exists a handler with name "+n+" for kind "+t[n].kind)}else if("undefined"==typeof e&&"undefined"==typeof r)throw new Error("Handler "+n+" does not exist");return t[n]={kind:e,handler:r},r},dashboard:function(n){return"undefined"==typeof n?e:e=niclabs.insight.Dashboard(n)}}}(jQuery),niclabs.insight.Color=function(){function n(n,e,t){n/=255,e/=255,t/=255;var r,i,a=Math.max(n,e,t),o=Math.min(n,e,t),s=a,l=a-o;if(i=0===a?0:l/a,a==o)r=0;else{switch(a){case n:r=(e-t)/l+(t>e?6:0);break;case e:r=(t-n)/l+2;break;case t:r=(n-e)/l+4}r/=6}return[r,i,s]}function e(n,e,t){var r,i,a,o=Math.floor(6*n),s=6*n-o,l=t*(1-e),c=t*(1-s*e),u=t*(1-(1-s)*e);switch(o%6){case 0:r=t,i=u,a=l;break;case 1:r=c,i=t,a=l;break;case 2:r=l,i=t,a=u;break;case 3:r=l,i=c,a=t;break;case 4:r=u,i=l,a=t;break;case 5:r=t,i=l,a=c}return[255*r,255*i,255*a]}function t(n){n=Math.floor(n);var e=n.toString(16);return 1==e.length?"0"+e:e}function r(n){return"#"+t(n[0])+t(n[1])+t(n[2])}function i(n){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return e?[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]:null}return{rgbToHsv:n,hsvToRgb:e,rgbToHex:r,hexToRgb:i}}(),niclabs.insight.Dashboard=function(n){"use strict";return function(e){function t(n){return n="undefined"==typeof n?c++:n,"layer"+n}var r=["left","right","none"],i="#insight-dashboard";if(!("anchor"in e))throw new Error("Anchor id is required for creating a dashboard");var a=e.anchor;if(e.layout=e.layout||"none",r.indexOf(e.layout)<0)throw new Error("Layout must be one of '"+r.join("','")+"'");var o=n("<div>").setID(i).addClass("insight").addClass(e.layout);n(a).append(o);var s,l={},c=0,u={},f={};niclabs.insight.event.on("layer_data",function(n){s&&n.id===s.id&&niclabs.insight.event.trigger("active_layer_data",n)});var d=niclabs.insight.Filters(g);o.append(d.element),niclabs.insight.event.on("filter_changed",function(e){n.each(l,function(n,t){t.filter(e)})});var g={get element(){return n(i)[0]},get $(){return n(i)},config:function(n){return e[n]},info:function(e){return"undefined"!=typeof e&&(u="handler"in e?niclabs.insight.handler(e.handler)(g,e):e,n(i).append(u.element)),u},map:function(t){return"undefined"!=typeof t&&(f="handler"in t?niclabs.insight.handler(t.handler)(g,t):t,n(i).append(f.element),e.geocoding!==!1&&"googlemap"in f&&d.filter(niclabs.insight.filter.GoogleGeocodingFilter(g,{id:"geocoder"}))),f},layer:function(n,e){if("string"==typeof n)return l[n];if("number"==typeof n)return l[t(n)];var r,i;return"handler"in n?(i=n.id=n.id||t(),r=niclabs.insight.handler(n.handler)(g,n)):(r=n,i=r.id),l[i]=r,(e||1===Object.size(l))&&g.active(i),h.add(r.id,r.name),r},data:function(n){return s?s.data(n):[]},active:function(n){if("undefined"==typeof n)return"undefined"!=typeof s?s.id:void 0;if("undefined"!=typeof s&&s.clear(),"number"==typeof n&&(n=t(n)),!(n in l))throw new Error("Layer with id "+n+" does not exist");return s=l[n],s.load(),s},filter:function(n){return d.filter(n)},clear:function(){s&&s.clear()}},h=niclabs.insight.filter.LayerSelector(g,{id:"layer-selector"});return d.filter(h),g}}(jQuery),niclabs.insight.ElementList=function(){var n=function(n){function e(n){return n="undefined"==typeof n?i++:n,"__"+n}var t={},r={},i=0;return t.element=function(t){if("string"==typeof t)return r[t];if("number"==typeof t)return r[e(t)];var i,a;return"handler"in t?(a=t.id=t.id||e(),i=niclabs.insight.handler(t.handler)(n,t)):(i=t,a=i.id),r[a]=i,i},t.each=function(n){for(var e in r)if(n(e,r[e])===!1)return!1},t.remove=function(n){if("number"==typeof obj&&(n=e(n)),n in r){var t=r[n];return delete r[n],t}},t};return n}(),niclabs.insight.Element=function(){var n=function(n){if(!("id"in n))throw Error("All UI elements must define an identifier");var e=n.id;if(!/^[^#. '"]+$/.test(e))throw Error("The UI element id must be at least 1 character long and cannot contain the following characters ['#','.',' ', ''', '\"'])");return{get id(){return e}}};return n}(jQuery),niclabs.insight.Filters=function(){"use strict";return function(n,e){function t(n){var e=!0;return a.each(function(t,r){return r.apply(n)?void 0:(e=!1,!1)}),e}e=e||{};var r=e.id||"insight-filters",i=niclabs.insight.View({id:r});i.$.addClass("filters");var a=niclabs.insight.ElementList(n);return niclabs.insight.event.on("filter_selected",function(){niclabs.insight.event.trigger("filter_changed",t)}),i.filter=function(n){var e=a.element(n);return i.append(e),e},i}}(jQuery),niclabs.insight.InfoView=function(){"use strict";var n=function(n,e){e=e||{};var t=e.id||"insight-info-view",r=niclabs.insight.View({id:t});if(r.$.addClass("info"),"none"!==n.config("layout")){var i;"left"===n.config("layout")?i="e":"right"===n.config("layout")&&(i="w"),r.$.resizable(i)}var a=niclabs.insight.ElementList(n);r.block=function(n){var e=a.element(n);return r.$.append(e.element),e};var o;if(e.blocks)for(o=0;o<e.blocks.length;o++)r.block(e.blocks[o]);return r.$.on("resize",function(){a.each(function(n,e){e.refresh()})}),niclabs.insight.event.on("remove-block",function(n){a.remove(n.id)}),r};return niclabs.insight.handler("basic-info-view","info-view",n),n}(jQuery),niclabs.insight.Interpolation=function(){function n(n,e,t,r){return t+(r-t)*n/e}function e(e,t,r,i){var a=n(e,t,r[0],i[0]),o=n(e,t,r[1],i[1]),s=n(e,t,r[2],i[2]);return[a,o,s]}function t(n,t,r,i){var a=niclabs.insight.Color.rgbToHsv(r[0],r[1],r[2]),o=niclabs.insight.Color.rgbToHsv(i[0],i[1],i[2]),s=e(n,t,a,o);return niclabs.insight.Color.hsvToRgb(s[0],s[1],s[2])}return{interpolate:n,interpolate3d:e,interpolateRgb:t}}(),niclabs.insight.MapView=function(n){"use strict";return function(e){var t="#insight-map-view",r={lat:e.lat||0,lng:e.lng||0},i=e.zoom||12,a=n("<div>").setID(t).addClass("map"),o={get element(){var e=n(t);return a=0===e.length?a:e,a[0]},get $(){var e=n(t);return a=0===e.length?a:e},center:function(n,e){return r.lat=n="undefined"==typeof n?r.lat:n,r.lng=e="undefined"==typeof e?r.lng:e,r},get lat(){return r.lat},get lng(){return r.lng},get width(){return o.$.width()},get height(){return o.$.height()},zoom:function(n){return i=n="undefined"==typeof n?i:n}};return o}}(jQuery),niclabs.insight.View=function(n){var e=function(e){var t=niclabs.insight.Element(e),r=n("<div>").attr("id",t.id);return Object.defineProperty(t,"$",{get:function(){var e=n("#"+t.id);return r=0===e.length?r:e}}),Object.defineProperty(t,"element",{get:function(){return t.$[0]}}),t.append=function(n){return t.$.append(n.$),t},t};return e}(jQuery),niclabs.insight.event=function(){"use strict";function n(n,t){if(n in e)for(var r=0;r<e[n].length;r++)if(e[n][r]===t)return r;return-1}var e={};return{on:function(t,r){var i=n(t,r);return 0>i?(t in e||(e[t]=[]),e[t].push(r)-1):i},off:function(t,r){var i="number"==typeof r?r:n(t,r);return i>=0?(e[t].splice(i,1),!0):!1},trigger:function(n,t){if(n in e)for(var r=0;r<e[n].length;r++)e[n][r](t)}}}(),niclabs.insight.filter={},niclabs.insight.filter.Filter=function(){var n=function(n,e){var t=niclabs.insight.View(e);return t.$.addClass("filter"),t.apply=function(){return!0},t};return n}(),niclabs.insight.filter.GoogleGeocodingFilter=function(n){var e=function(e,t){var r=niclabs.insight.filter.Filter(e,t);if(!("googlemap"in e.map()))throw new Error("Sorry, Google Geocoding can only be used with Google Maps");var i=new n.maps.Geocoder,a=$("<input>").addClass("search").attr("type","search").attr("placeholder","Enter location");r.$.append(a);var o=function(){var t=e.map().googlemap(),r=a.val();i.geocode({address:r},function(e,i){i==n.maps.GeocoderStatus.OK?(t.setCenter(e[0].geometry.location),t.fitBounds(e[0].geometry.bounds)):a.val("not found: "+r)})};return a.on("change",o),r};return niclabs.insight.handler("google-geocoder","filter",e),e}(google),niclabs.insight.filter.LayerSelector=function(n){var e=function(e,t){var r=niclabs.insight.filter.Filter(e,t),i={},a=n("<select>");return a.on("change",function(){e.active(n(this).val())}),r.$.append(a),r.add=function(e,t){i[e]=t,a.append(n("<option>").attr("value",e).text(t))},r};return niclabs.insight.handler("layer-selector","filter",e),e}(jQuery),niclabs.insight.filter.SelectionFilter=function(n){var e=function(e,t){function r(){return!0}var i=niclabs.insight.filter.Filter(e,t),a=t.options||[],o=n("<select>");o.append(n("<option>").text(t.description||"")),a.forEach(function(e){o.append(n("<option>").text(e.name))});var s=r;return o.on("change",function(){s=r;var e=n(this).prop("selectedIndex");e>0&&(s=a[e-1].filter),niclabs.insight.event.trigger("filter_selected",i)}),i.$.append(o),i.apply=function(n){return s(n)},i};return niclabs.insight.handler("selection-filter","filter",e),e}(jQuery),niclabs.insight.info=function(){var n=function(n){var e=niclabs.insight.dashboard();if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.info(n)};return n}(),niclabs.insight.info.Block=function(n){"use strict";var e=function(e,t){function r(){niclabs.insight.event.trigger("remove-block",{id:o})}function i(n,e){h=niclabs.insight.event.on("map_element_selected",function(t){e&&t.layer!==e||n.refresh(n.__data__(t))}),p=niclabs.insight.event.on("layer_summary",function(t){e&&t.id!==e||n.refresh(n.__data__(t.data))})}function a(){niclabs.insight.event.off("map_element_selected",h),niclabs.insight.event.off("layer_summary",p)}if(!("id"in t))throw new Error("All information blocks must have an id");var o=t.id,s="#"===o.charAt(0)?o:"#"+o,l=t.title||"",c={closable:"undefined"==typeof t.closable?!0:t.closable,movable:"undefined"==typeof t.movable?!0:t.movable},u=t.preprocess||function(n){return n},f=n("<div>").addClass("header").append(n("<span>").attr("data-bind","title").addClass("title").append(l)),d=n("<div>").setID(s).addClass("block").append(f),g=n("<div>").addClass("content");d.append(g),c.closable&&d.closable(function(){r()}),c.movable&&d.movable(),d.css(c);var h,p,b,m={},y={get id(){return o},get element(){var e=n(s);return d=0===e.length?d:e,d[0]},get $(){var e=n(s);return d=0===e.length?d:e},get layer(){return b},get content(){var e=n(s).find(".content");return g=0===e.length?g:e},title:function(n){return"undefined"!=typeof n&&(l=n,y.$.find(".title").text(n)),l},__data__:function(n){return"undefined"==typeof n?m:m=0===Object.keys(n).length?{}:u(n)},remove:r,data:function(e){return"undefined"==typeof e?m:(b=void 0,a(y),"string"==typeof e?"#"===e.charAt(0)?(b=e.substring(1),m=t.defaults||{},i(y,b),m):(n.getJSON(e,y.__data__),e):y.__data__("function"==typeof e?e.call(y):e))},refresh:function(){}};return"data"in t?y.data(t.data):(i(y),m=t.defaults||{}),y};return e}(jQuery),niclabs.insight.info.ChartistBlock=function(n){var e=function(e,t,r){var i=niclabs.insight.info.Block(e,r),a=r.chartist;i.content.addClass("chartist-viz").append(n("<div>").addClass(a["class"]));var o,s=a.options||{},l=a.responsiveOptions||{},c=a.labels,u=i.refresh;i.refresh=function(n){n="undefined"==typeof n?i.data():n,u(n),n=n.value||n;var e={series:n,labels:"function"==typeof c?c(n):c};o&&o.optionsProvider?o.update(e):o=new t(i.content.find("div")[0],e,s,l)};var f=i.remove;return i.remove=function(){f(),o.detach()},i.refresh(),i},t=function(n,t){var r=e(n,Chartist.Line,t);return r},r=function(n,t){var r=e(n,Chartist.Bar,t);return r},i=function(n,t){var r=e(n,Chartist.Pie,t);return r};return niclabs.insight.handler("chartist-linechart","info-block",t),niclabs.insight.handler("chartist-barchart","info-block",r),niclabs.insight.handler("chartist-piechart","info-block",i),e}(jQuery),niclabs.insight.info.SummaryBlock=function(){var n=function(n,e){var t=niclabs.insight.info.Block(n,e),r=e.template||'        <h6 class="latLngView" data-if="lat">             lat: <span data-bind="lat"> -- </span>             lng: <span data-bind="lng"> -- </span>         </h6>        <dl class="deflist">            <dt class="deflist-key" data-if="description">description</dt>             <dd class="deflist-value" data-bind="description">none</dd>             <dt class="deflist-key" data-if="landmark">landmark</dt>             <dd class="deflist-value" data-bind="landmark">none</dd>             <dt class="deflist-key" data-if="fun-fact">fun-fact</dt>             <dd class="deflist-value" data-bind="fun-fact">none</dd>         </dl>        ';t.content.template(r);var i=t.refresh;return t.refresh=function(n){n="undefined"!=typeof n?n:t.data(),i(n),t.content.trigger("render",n)},t.refresh(),t};return niclabs.insight.handler("summary-block","info-block",n),n}(jQuery),niclabs.insight.layer=function(){var n=function(n,e){var t=niclabs.insight.dashboard();if("undefined"==typeof t)throw new Error("Dashboard has not been initialized");return t.layer(n,e)};return n}(),niclabs.insight.layer.GridLayer=function(){var n=function(n,e){function t(e,t){var r;if("type"in t){var a={layer:i.id,data:e};$.extend(a,t),r=niclabs.insight.handler(t.type)(n,a)}else r=t;return r}var r,i=niclabs.insight.layer.Layer(n,e),a=e.grid||{type:"hexagon"};return i.draw=function(n){r=t(n,a)},i.clear=function(){r&&r.clear()},i.filter=function(){},i};return niclabs.insight.handler("grid-layer","layer",n),n}(),niclabs.insight.layer.HeatmapLayer=function(n){var e=function(e,t){function r(t,r){var i;if("type"in r){var o={layer:a.id,data:t};n.extend(o,r),i=niclabs.insight.handler(r.type)(e,o)}else i=r;return i}var i,a=niclabs.insight.layer.Layer(e,t),o=t.heatmap||{type:"point-heatmap"};return a.draw=function(n){i=r(n,o)},a.clear=function(){i&&i.clear()},a.filter=function(){},a};return niclabs.insight.handler("heatmap-layer","layer",e),e}(jQuery),niclabs.insight.layer.Layer=function(n){"use strict";var e=function(e,t){if(!("id"in t))throw Error("All layers must have an id.");var r=t.id,i=t.name||t.id;if(!("data"in t))throw Error("All layers must provide a data source.");var a=!1,o=[];"string"==typeof t.data?a=t.data:o=t.data&&Array.isArray(t.data)?t.data:[t.data];var s=t.summary||!1,l=!1,c={get id(){return r},get name(){return i},data:function(n){return"undefined"==typeof n?l||!a?o:a:"string"==typeof n?(a=n,l&&c.load(),a):o=n.length?n:[n]},load:function(){function e(n){if(o=n,niclabs.insight.event.trigger("layer_data",{id:r,data:o}),c.clear(),s){var e=s;"function"==typeof s&&(e=s(o)),niclabs.insight.event.trigger("layer_summary",{id:r,data:e})}c.draw(o)}a?n.getJSON(a,e):e(o)},draw:function(){},filter:function(){},clear:function(){}};return c};return e}(jQuery),niclabs.insight.layer.MarkerLayer=function(n){var e=function(e,t){function r(t,r,a){var o;if("type"in a){var s={layer:i.id};n.extend(s,a,t[r]),o=niclabs.insight.handler(a.type)(e,s)}else o=a;return o.clickable(!0),o}var i=niclabs.insight.layer.Layer(e,t),a=t.marker||{type:"simple-marker"},o=[];return i.draw=function(n){for(var e=0;e<n.length;e++)o.push(r(n,e,a))},i.clear=function(){for(var n=0;n<o.length;n++)o[n].clear()},i.filter=function(n){for(var e=i.data(),t=0;t<o.length;t++)o[t].visible(n(e[t]))},i};return niclabs.insight.handler("marker-layer","layer",e),e}(jQuery),niclabs.insight.map=function(){"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),"undefined"==typeof Number.prototype.toDeg&&(Number.prototype.toDeg=function(){return 180*this/Math.PI});var n=function(n){var e=niclabs.insight.dashboard();if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.map(n)};return n}(),niclabs.insight.map.GoogleMercator=function(){function n(n,e,t){return null!==e&&(n=Math.max(n,e)),null!==t&&(n=Math.min(n,t)),n}var e=256,t={x:e/2,y:e/2},r=e/360,i=e/(2*Math.PI);return{geographic:function(n){var e=(n.x-t.x)/r,a=(n.y-t.y)/-i,o=(2*Math.atan(Math.exp(a))-Math.PI/2).toDeg();return{lat:o,lng:e}},cartesian:function(e){"function"==typeof e.lat&&"function"==typeof e.lng&&(e={lat:e.lat(),lng:e.lng()});var a=t.x+e.lng*r,o=n(Math.sin(e.lat.toRad()),-.9999,.9999),s=t.y+.5*Math.log((1+o)/(1-o))*-i;return{x:a,y:s}},distance:function(n,e){return e="undefined"!=typeof e?e:12,n/(1<<e)}}}(),niclabs.insight.map.GoogleMap=function(){"use strict";var n=function(n,e){var t=niclabs.insight.MapView(e),r=new google.maps.Map(t.element,{zoom:t.zoom(),center:new google.maps.LatLng(t.lat,t.lng),disableDefaultUI:!0}),i=t.zoom;google.maps.event.addListener(r,"zoom_changed",function(){i(r.getZoom())}),t.zoom=function(n){return n=i(n),r.setZoom(n),n};var a=t.center;return google.maps.event.addListener(r,"center_changed",function(){var n=r.getCenter();a(n.lat(),n.lng())}),t.center=function(n,e){var t=a(n,e);return r.setCenter({lat:t.lat,lng:t.lng}),t},t.googlemap=function(){return r},t};return niclabs.insight.handler("google-map","map-view",n),n}(jQuery),niclabs.insight.quadtree={},niclabs.insight.quadtree.Bounds=function(){var n=function(n,e){var t={x:(n.x+e.x)/2,y:(n.y+e.y)/2};return{get center(){return t},get min(){return n},get max(){return e},contains:function(t){return n.x<=t.x&&t.x<e.x&&n.y<=t.y&&t.y<e.y},intersects:function(t){return e.x<t.min.x?!1:n.x>t.max.x?!1:e.y<t.min.y?!1:n.y>t.max.y?!1:!0}}};return n}(),niclabs.insight.quadtree.PointQuadTree=function(){var n=function(e,t,r){function i(){a=n(niclabs.insight.quadtree.Bounds(e.min,e.center),t,r-1),o=n(niclabs.insight.quadtree.Bounds({x:e.center.x,y:e.min.y},{x:e.max.x,y:e.center.y}),t,r-1),s=n(niclabs.insight.quadtree.Bounds({x:e.min.x,y:e.center.y},{x:e.center.x,y:e.max.y}),t,r-1),l=n(niclabs.insight.quadtree.Bounds(e.center,e.max,t,r-1))}t=t||50,r=r||40;var a,o,s,l,c=[],u={get capacity(){return t},get bounds(){return e},insert:function(n){return e.contains(n)?c.length<t||0>=r?(c.push(n),!0):(void 0===a&&i(),a.insert(n)?!0:o.insert(n)?!0:s.insert(n)?!0:l.insert(n)?!0:!1):!1},query:function(n,t){if(t="undefined"==typeof t?[]:t,!e.intersects(n))return t;for(var r=0;r<c.length;r++)n.contains(c[r])&&t.push(c[r]);return void 0===a?t:(a.query(n,t),o.query(n,t),s.query(n,t),l.query(n,t),t)}};return u};return n}(),niclabs.insight.map.grid={},niclabs.insight.map.grid.Grid=function(){function n(n,e){return n=niclabs.insight.Color.hexToRgb(n),e=niclabs.insight.Color.hexToRgb(e),function(t){var r=0,a=0;for(i=0;i<t.length;i++)"weight"in t[i]&&(r+=t[i].weight,a++);return a>0?(r/=a,niclabs.insight.Color.rgbToHex(niclabs.insight.Interpolation.interpolateRgb(r,1,n,e))):"#ffffff"}}function e(n,e){function t(n,e,t){for(var r,i=Math.floor((e+t)/2);t>=e;){for(;n[e].weight<n[i].weight;)e++;for(;n[t].weight>n[i].weight;)t--;t>=e&&(r=n[e],n[e]=n[t],n[t]=r,e++,t--)}return i}return n=niclabs.insight.Color.hexToRgb(n),e=niclabs.insight.Color.hexToRgb(e),function(r){var i=0,a=0,o=r.length>0?r.length-1:0,s=Math.floor((a+o)/2);for(i=t(r,a,o);i!==s;)i=s>i?t(r,s,o):t(r,a,s);return niclabs.insight.Color.rgbToHex(niclabs.insight.Interpolation.interpolateRgb(r[i].weight,1,n,e))}}var t=function(t,r){function i(){return"#ffffff"}function a(n){return function(){niclabs.insight.event.trigger("map_element_selected",n)}}function o(n){if(n){for(var e,t,r=b.tile(),i=g.query(niclabs.insight.quadtree.Bounds(niclabs.insight.map.GoogleMercator.cartesian({lat:n.getNorthEast().lat(),lng:n.getSouthWest().lng()}),niclabs.insight.map.GoogleMercator.cartesian({lat:n.getSouthWest().lat(),lng:n.getNorthEast().lng()}))),o=[],s=0;s<i.length;s++){var l=r.query(i[s]);e=l[0],t=l[1],o[e]||(o[e]=[]),o[e][t]||(o[e][t]=[]),o[e][t].push(i[s])}c=[];for(e in o)for(t in o[e]){u.fillColor=f(o[e][t]);var d=r.draw(r.origin(e,t),b.map,u);google.maps.event.addListener(d,"click",a(o[e][t])),c.push(d)}}}if(!("layer"in r))throw new Error("The grid must be associated to a layer");var s;if(!(s=t.layer(r.layer)))throw new Error("The layer "+s+" does not exist in the dashboard");var l;if(!(l=t.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in l))throw new Error("Grids are only supported for Google Maps at the moment");var c=[],u={strokeColor:"strokeColor"in r?r.strokeColor:"#000000",strokeOpacity:"strokeOpacity"in r?r.strokeOpacity:.6,strokeWeight:"strokeWeight"in r?r.strokeWeight:2,fillOpacity:"fillOpacity"in r?r.fillOpacity:.6},f=r.fill||i;"string"==typeof f&&(f="#"===r.fill.charAt(0)?function(){return r.fill}:"average"===r.fill?n(r.fillStart||"#ff0000",r.fillEnd||"#00ff00"):"median"===r.fill?e(r.fillStart||"#ff0000",r.fillEnd||"#00ff00"):i);for(var d=niclabs.insight.quadtree.Bounds(niclabs.insight.map.GoogleMercator.cartesian({lat:90,lng:-180}),niclabs.insight.map.GoogleMercator.cartesian({lat:-90,lng:180})),g=niclabs.insight.quadtree.PointQuadTree(d),h=0;h<r.data.length;h++){var p=niclabs.insight.map.GoogleMercator.cartesian(r.data[h]);r.data[h].x=p.x,r.data[h].y=p.y,g.insert(r.data[h])}var b={get map(){return l},get layer(){return s},refresh:function(){o(b.map.googlemap().getBounds())},tile:function(){throw new Error("Not implemented")},clear:function(){for(var n=0;n<c.length;n++)c[n].setMap(null)}};return google.maps.event.addListener(b.map.googlemap(),"bounds_changed",function(){var n=this.getBounds();window.setTimeout(function(){b.clear(),o(n)},50)}),b};return t}(),niclabs.insight.map.grid.HexagonTile=function(){var n=function(n){var e=Math.cos(Math.PI/6)*n,t=Math.sin(Math.PI/6)*n,r=niclabs.insight.map.grid.Tile();return Object.defineProperty(r,"s",{get:function(){return n}}),Object.defineProperty(r,"r",{get:function(){return e}}),Object.defineProperty(r,"h",{get:function(){return t}}),r.origin=function(){var r,i;1==arguments.length?(r=arguments[0][0],i=arguments[0][1]):(r=arguments[0],i=arguments[1]);var a=2*r*e+(1&i)*e+e,o=i*(t+n);return{x:a,y:o}},r.query=function(r){r.lat&&(r=niclabs.insight.map.GoogleMercator.cartesian(r));var i=Math.floor(r.x/(2*e)),a=Math.floor(r.y/(t+n)),o=r.x-2*i*e,s=r.y-a*(t+n),l=0===(1&a),c=i,u=a;return l?e>=o&&-t/e*o+t>s?(c=i-1,u=a-1):o>e&&t/e*o-t>s&&(c=i,u=a-1):e>=o?t/e*o>s?(c=i,u=a-1):(c=i-1,u=a):o>e&&-t/e*o+2*t>s&&(c=i,u=a-1),[c,u]},r.vertices=function(r){r.lat&&(r=niclabs.insight.map.GoogleMercator.cartesian(r));var i=[];return i[0]={x:r.x,y:r.y},i[1]={x:r.x+e,y:r.y+t},i[2]={x:r.x+e,y:r.y+n+t},i[3]={x:r.x,y:r.y+n+t+t},i[4]={x:r.x-e,y:r.y+n+t},i[5]={x:r.x-e,y:r.y+t},i},r};return n}(),niclabs.insight.map.grid.HexagonalGrid=function(){var n=function(n,e){var t=niclabs.insight.map.grid.Grid(n,e);return t.tile=function(){return niclabs.insight.map.grid.HexagonTile(niclabs.insight.map.GoogleMercator.distance(e.size,t.map.zoom()))},t.refresh(),t};return niclabs.insight.handler("hexagon","grid",n),n}(),niclabs.insight.map.grid.SquareGrid=function(){var n=function(n,e){var t=niclabs.insight.map.grid.Grid(n,e);return t.tile=function(){return niclabs.insight.map.grid.SquareTile(niclabs.insight.map.GoogleMercator.distance(e.size,t.map.zoom()))},t.refresh(),t};return niclabs.insight.handler("square","grid",n),n}(),niclabs.insight.map.grid.SquareTile=function(){var n=function(n){var e=niclabs.insight.map.grid.Tile();return Object.defineProperty(e,"s",{get:function(){return n}}),e.origin=function(){var e,t;1==arguments.length?(e=arguments[0][0],t=arguments[0][1]):(e=arguments[0],t=arguments[1]);var r=e*n,i=t*n;return{x:r,y:i}},e.query=function(e){e.lat&&(e=niclabs.insight.map.GoogleMercator.cartesian(e));var t=Math.floor(e.x/n),r=Math.floor(e.y/n);return[t,r]},e.vertices=function(e){e.lat&&(e=niclabs.insight.map.GoogleMercator.cartesian(e));var t=[];return t[0]={x:e.x,y:e.y},t[1]={x:e.x,y:e.y+n},t[2]={x:e.x+n,y:e.y+n},t[3]={x:e.x+n,y:e.y},t},e};return n}(),niclabs.insight.map.grid.Tile=function(){var n=function(){var n={origin:function(){throw new Error("Not implemented")},query:function(){throw new Error("Not implemented")},vertices:function(){throw new Error("Not implemented")},draw:function(e,t,r){if(!("googlemap"in t))throw new Error("Sorry, I only know how to draw on Google Maps at the moment");for(var i=n.vertices(e),a=[],o=0;o<i.length;o++)a.push(niclabs.insight.map.GoogleMercator.geographic(i[o]));r=r||{strokeColor:"#000000",strokeOpacity:.6,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.6},r.paths=a,r.geodesic=!0;var s=new google.maps.Polygon(r);return s.setMap(t.googlemap()),s}};return n};return n}(),niclabs.insight.map.heatmap={},niclabs.insight.map.heatmap.Heatmap=function(){var n=function(n,e){if(!("layer"in e))throw new Error("The heatmap must be associated to a layer");var t;if(!(t=n.layer(e.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=n.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Heatmaps are only supported for Google Maps at the moment");var i={get map(){return r},get layer(){return t},clear:function(){}};return i};return n}(jQuery),niclabs.insight.map.heatmap.PointHeatmap=function(){var n=function(n,e){function t(n){for(var t=new google.maps.MVCArray,r=0;r<n.length;r++)t.push("weight"in n[r]?{location:new google.maps.LatLng(n[r].lat,n[r].lng),weight:n[r].weight}:new google.maps.LatLng(n[r].lat,n[r].lng));return new google.maps.visualization.HeatmapLayer({data:t,radius:e.radius||10})}if(!("data"in e))throw Error("No data provided for the heatmap");var r=niclabs.insight.map.heatmap.Heatmap(n,e),i=t(e.data);"undefined"!=typeof e.dissipating&&i.set("dissipating",e.dissipating),"undefined"!=typeof e.gradient&&i.set("gradient",e.gradient),"undefined"!=typeof e.opacity&&i.set("opacity",e.opacity),i.setMap(r.map.googlemap());var a=r.clear;return r.clear=function(){a(),i.setMap(null)},r};return niclabs.insight.handler("point-heatmap","heatmap",n),n}(jQuery),niclabs.insight.map.heatmap.SegmentHeatmap=function(){var n=function(n,e){function t(n){var t=new google.maps.MVCArray;for(i=0;i<n.length;i++){segment_size=n[i].coordinates.length;for(var r=0;r<segment_size-1;r++)for(var a=Math.sqrt(Math.pow(n[i].coordinates[r+1][0]-n[i].coordinates[r][0],2)+Math.pow(n[i].coordinates[r+1][1]-n[i].coordinates[r][1],2)),o=Math.floor(a/1e-5),s={lat:(n[i].coordinates[r+1][0]-n[i].coordinates[r][0])/o,lng:(n[i].coordinates[r+1][1]-n[i].coordinates[r][1])/o},l=0;o>l;l++)t.push("weight"in n[i]?{location:new google.maps.LatLng(n[i].coordinates[r][0]+s.lat*l,n[i].coordinates[r][1]+s.lng*l),weight:n[i].weight}:new google.maps.LatLng(n[i].coordinates[r][0]+s.lat*l,n[i].coordinates[r][1]+s.lng*l))}return new google.maps.visualization.HeatmapLayer({data:t,radius:e.radius||10})}if(!("data"in e))throw Error("No data provided for the heatmap");var r=niclabs.insight.map.heatmap.Heatmap(n,e),a=t(e.data);"undefined"!=typeof e.dissipating&&a.set("dissipating",e.dissipating),"undefined"!=typeof e.gradient&&a.set("gradient",e.gradient),"undefined"!=typeof e.opacity&&a.set("opacity",e.opacity),a.setMap(r.map.googlemap());var o=r.clear;return r.clear=function(){o(),a.setMap(null)},r};return niclabs.insight.handler("segment-heatmap","heatmap",n),n}(jQuery),niclabs.insight.map.marker={},niclabs.insight.map.marker.CircleMarker=function(){var n=function(n,e){var t=niclabs.insight.map.marker.Marker(n,e),r=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i=new google.maps.Circle({center:r,map:t.map.googlemap(),radius:e.radius||400,strokeColor:e.strokeColor||"#FF0000",strokeOpacity:e.strokeOpacity||.8,strokeWeight:e.strokeWeight||2,fillColor:e.fillColor||"#FF0000",fillOpacity:e.fillOpacity||.35,title:e.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("circle-marker","marker",n),n}(jQuery),niclabs.insight.map.marker.ImageMarker=function(){var n=function(n,e){var t=niclabs.insight.map.marker.Marker(n,e),r=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng));if(!("src"in e))throw new Error("An image source must be provided for using image markers");var i={url:e.src,scaledSize:new google.maps.Size(30,50)},a=new google.maps.Marker({position:r,map:t.map.googlemap(),icon:i,title:e.landmark||""});return t.marker=function(){return a},t};return niclabs.insight.handler("image-marker","marker",n),n}(jQuery),niclabs.insight.map.marker.Marker=function(){var n=function(n,e){if(!("layer"in e))throw new Error("The marker must be associated to a layer");var t;if(!(t=n.layer(e.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=n.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Markers are only supported for Google Maps at the moment");var i,a={get map(){return r},get layer(){return t},marker:function(){return void 0},clickable:function(n){if(n){var t=a.marker();i=google.maps.event.addListener(t,"click",function(){niclabs.insight.event.trigger("map_element_selected",e),"setAnimation"in t&&t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)
},3e3)})}else"undefined"!=typeof i&&(google.maps.event.removeListener(i),i=void 0);return void 0!==i},clear:function(){var n=a.marker();n.setMap(null)},visible:function(n){return"undefined"==typeof n?a.marker().getVisible():(a.marker().setVisible(n),n)}};return a};return n}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(){var n=function(n,e){var t=niclabs.insight.map.marker.Marker(n,e),r=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i=new google.maps.Marker({position:r,map:t.map.googlemap(),title:e.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("simple-marker","marker",n),n}(jQuery);