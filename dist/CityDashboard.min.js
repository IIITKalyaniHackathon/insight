var niclabs={};niclabs.insight=function(n){"use strict";n.fn.resizable=function(e){function t(e){o=e.clientX,s=e.clientY,l=p.outerWidth(),c=p.outerHeight(),n(document).on("mousemove",i),n(document).on("mouseup",r)}function i(n){d&&p.css("height",c+n.clientY-s+"px"),u&&p.css("width",l+n.clientX-o+"px"),f&&p.css("top",n.clientY+"px").css("height",c+s-n.clientY+"px"),h&&p.css("left",n.clientX+"px").css("width",l-n.clientX+"px")}function r(){n(document).off("mousemove",i),n(document).off("mouseup",r),p.trigger("resize")}var a=n("<div>").addClass("resizer").addClass(e+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",t);var o,s,l,c,u,d,f,h,p=this;return d=e.search("s")>=0,u=e.search("e")>=0,f=e.search("n")>=0,h=e.search("w")>=0,this.scroll(function(){a.css("top",p.scrollTop())}),this},n.fn.setID=function(n){return"#"===n.charAt(0)&&(n=n.slice(1)),this.attr("id",n),this},n.fn.movable=function(){var e=this.children(".options-panel");e.length||(e=n("<span>").addClass("options-panel"),this.prepend(e));var t=n("<span>").addClass("up-button").append("&#x25B2;"),i=n("<span>").addClass("down-button").append("&#x25BC;");e.prepend(i),e.prepend(t);var r=this;return t.on("click",function(){r.insertBefore(r.prev())}),i.on("click",function(){r.insertAfter(r.next())}),this},n.fn.closable=function(e){e||(e=function(){});var t=this.children(".options-panel");t.length||(t=n("<span>").addClass("options-panel"),this.prepend(t));var i=n("<span>").addClass("close-button").text("X");t.append(i);var r=this;return i.on("click",function(){r.remove(),e()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(e,t){return n.inArray(e,this,t)};var e,t={};return{handler:function(n,e,i){if(n in t){if(e="undefined"==typeof e?t[n].kind:e,i="undefined"==typeof i?t[n].handler:i,e!==t[n].kind)throw new Error("There already exists a handler with name "+n+" for kind "+t[n].kind)}else if("undefined"==typeof e&&"undefined"==typeof i)throw new Error("Handler "+n+" does not exist");return t[n]={kind:e,handler:i},i},init:function(n){return e=niclabs.insight.Dashboard(n)},infoview:function(n){if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.infoview(n)},mapview:function(n){if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.mapview(n)}}}(jQuery),niclabs.insight.Dashboard=function(n){"use strict";return function(e){var t=[],i=["left","right","none"],r="#insight-dashboard";if(!("anchor"in e))throw new Error("Anchor id is required for creating a dashboard");var a=e.anchor;if(e.layout=e.layout||"none",i.indexOf(e.layout)<0)throw new Error("Layout must be one of '"+i.join("','")+"'");var o=n("<div>").setID(r).addClass("mainDashboard").addClass("layout-"+e.layout);n(a).append(o);var s={},l={},c={get element(){return n(r)[0]},get $(){return n(r)},config:function(n){return e[n]},infoview:function(e){return"undefined"!=typeof e&&(s="handler"in e?niclabs.insight.handler(e.handler)(c,e):e,n(r).append(s.element)),s},mapview:function(e){return"undefined"!=typeof e&&(l="handler"in e?niclabs.insight.handler(e.handler)(c,e):e,n(r).append(l.element)),l},addLayer:function(n){var e=function(n){t[t.length]=new LayerSelector(n,CityDashboard.container("main")[0].data)};return CityDashboard.getData(n["data-source"],e,n),c},addFilter:function(n){return filterBar.addFilter(n),c},clear:function(){for(var n=0;n<t.length;n++)t[n].clear();t=[]}};return c}}(jQuery),niclabs.insight.InfoView=function(n){"use strict";var e=function(e,t){function i(n){return n="undefined"==typeof n?c++:n,"block"+n}function r(n){if("string"==typeof n)return u[n];if("number"==typeof n)return u[i(n)];var e,t;return"handler"in n?(t=n.id=n.id||i(),e=niclabs.insight.handler(n.handler)(d,n)):(e=n,t=e.id),u[t]=e,o.append(e.element),e}t=t||{};var a="#insight-info-view",o=n("<div>").setID(a).addClass("infoWindow");if("none"!==e.config("layout")){var s;"left"===e.config("layout")?s="e":"right"===e.config("layout")&&(s="w"),o.resizable(s)}var l,c=0,u={};if(t.blocks)for(l=0;l<t.blocks.length;l++)r(t.blocks[l]);o.on("resize",function(){for(var n in u)u[n].refresh()}),niclabs.insight.event.on("remove-block",function(n){delete u[n.id]});var d={get element(){var e=n(a);return o=0===e.length?o:e,o[0]},$:function(){var e=n(a);return o=0===e.length?o:e},block:r};return d};return niclabs.insight.handler("basic-info-view","info-view",e),e}(jQuery),niclabs.insight.MapView=function(n){"use strict";return function(e){var t="#insight-map-view",i={lat:e.lat||0,lng:e.lng||0},r=e.zoom||12,a=n("<div>").setID(t).addClass("mapWindow");return{get element(){var e=n(t);return a=0===e.length?a:e,a[0]},$:function(){var e=n(t);return a=0===e.length?a:e},center:function(n,e){return i.lat=n="undefined"==typeof n?i.lat:n,i.lng=e="undefined"==typeof e?i.lng:e,i},lat:function(){return i.lat},lng:function(){return i.lng},zoom:function(n){return r=n="undefined"==typeof n?r:n},container:function(){return a}}}}(jQuery),niclabs.insight.event=function(){"use strict";function n(n,t){if(n in e)for(var i=0;i<e[n].length;i++)if(e[n][i]===t)return i;return-1}var e={};return{on:function(t,i){var r=n(t,i);return 0>r?("event"in e||(e[t]=[]),e[t].push(i)-1):r},off:function(t,i){var r="number"==typeof i?i:n(t,i);return r>=0?(e[t].splice(r,1),!0):!1},trigger:function(n,t){if(n in e)for(var i=0;i<e[n].length;i++)e[n][i](t)}}}(),niclabs.insight.info={},niclabs.insight.info.Block=function(n){"use strict";var e=function(e,t){function i(){niclabs.insight.event.trigger("remove-block",{id:r,datasource:s})}if(!("id"in t))throw new Error("All information blocks must have an id");var r=t.id,a=t.title||"",o=t.properties||{},s=t.datasource||r,l=t.preprocess||function(n){return n},c=n("<h4>").append(a).addClass("viz-title"),u=n("<div>").setID(r).addClass("visualization").append(c).append(n("<hr>").addClass("viz-bar"));(void 0===o.closable||o.closable)&&u.closable(function(){i()}),(void 0===o.movable||o.movable)&&u.movable(),u.append(n("<h6>").addClass("latlngView")),u.css(o);var d={},f={get id(){return r},get element(){var e=n(r);return u=0===e.length?u:e,u[0]},get $(){var e=n(r);return u=0===e.length?u:e},remove:i,data:function(n){return n="undefined"==typeof n?d:n,d=0===Object.keys(n).length?{}:l(n)},refresh:function(){var n=f.$.find(".latlngView").empty();f.$.find(".deflist").remove();var e=f.getData(),t=e.lat,i=e.lng;t&&i&&n.text("lat: "+t+", lng: "+i).insertAfter(f.$.find("hr"))},createDefList:function(e){n.each(e,function(e,t){"lat"!==e&&"lng"!==e&&"value"!==e&&f.$.find(".deflist").append(n("<dt>").text(e).addClass("deflist-key")).append(n("<dd>").text(t).addClass("deflist-value"))})}};return f};return e}(jQuery),niclabs.insight.info.SummaryBlock=function(n){var e=function(e,t){var i=niclabs.insight.info.Block(e,t);i.$.addClass("summary-viz");var r=i.refresh;return i.refresh=function(){r(),i.$.append(n("<dl>").addClass("deflist")),i.createDeflist(i.data())},i};return niclabs.insight.handler("summary-block","info-block",e),e}(jQuery),niclabs.insight.layer={},niclabs.insight.layer.Layer=function(){"use strict";var n=function(n,e){if(!("id"in e))throw Error("All layers must have an id.");e.id,e.datasource,e.data&&e.data.length?e.data:[e.data],e.attributes||{type:"simple",action:"update"},n.mapview();return{filter:function(){},clear:function(){}}};return n}(jQuery),niclabs.insight.map={},niclabs.insight.map.GoogleMap=function(){"use strict";var n=function(n,e){var t=niclabs.insight.MapView(e),i=new google.maps.Map(t.container()[0],{zoom:t.zoom(),center:new google.maps.LatLng(t.lat(),t.lng()),disableDefaultUI:!0}),r=t.zoom;google.maps.event.addListener(i,"zoom_changed",function(){r(i.getZoom())}),t.zoom=function(n){return n=r(n),i.setZoom(n),n};var a=t.center;return google.maps.event.addListener(i,"center_changed",function(){var n=i.getCenter();a(n.lat(),n.lng())}),t.center=function(n,e){var t=a(n,e);return i.setCenter({lat:t.lat,lng:t.lng}),t},t.googlemap=function(){return i},t};return niclabs.insight.handler("google-map","map-view",n),n}(jQuery);