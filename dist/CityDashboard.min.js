var niclabs={};niclabs.insight=function(n){"use strict";n.fn.resizable=function(e){function t(e){o=e.clientX,s=e.clientY,l=h.outerWidth(),c=h.outerHeight(),n(document).on("mousemove",r),n(document).on("mouseup",i)}function r(n){d&&h.css("height",c+n.clientY-s+"px"),u&&h.css("width",l+n.clientX-o+"px"),f&&h.css("top",n.clientY+"px").css("height",c+s-n.clientY+"px"),p&&h.css("left",n.clientX+"px").css("width",l-n.clientX+"px")}function i(){n(document).off("mousemove",r),n(document).off("mouseup",i),h.trigger("resize")}var a=n("<div>").addClass("resizer").addClass(e+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",t);var o,s,l,c,u,d,f,p,h=this;return d=e.search("s")>=0,u=e.search("e")>=0,f=e.search("n")>=0,p=e.search("w")>=0,this.scroll(function(){a.css("top",h.scrollTop())}),this},n.fn.setID=function(n){return"#"===n.charAt(0)&&(n=n.slice(1)),this.attr("id",n),this},n.fn.movable=function(){var e=this.children(".options-panel");e.length||(e=n("<span>").addClass("options-panel"),this.prepend(e));var t=n("<span>").addClass("up-button").append("&#x25B2;"),r=n("<span>").addClass("down-button").append("&#x25BC;");e.prepend(r),e.prepend(t);var i=this;return t.on("click",function(){i.insertBefore(i.prev())}),r.on("click",function(){i.insertAfter(i.next())}),this},n.fn.closable=function(e){e||(e=function(){});var t=this.children(".options-panel");t.length||(t=n("<span>").addClass("options-panel"),this.prepend(t));var r=n("<span>").addClass("close-button").text("X");t.append(r);var i=this;return r.on("click",function(){i.remove(),e()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(e,t){return n.inArray(e,this,t)},Object.size=function(n){var e,t=0;for(e in n)n.hasOwnProperty(e)&&t++;return t};var e,t={};return{handler:function(n,e,r){if(n in t){if(e="undefined"==typeof e?t[n].kind:e,r="undefined"==typeof r?t[n].handler:r,e!==t[n].kind)throw new Error("There already exists a handler with name "+n+" for kind "+t[n].kind)}else if("undefined"==typeof e&&"undefined"==typeof r)throw new Error("Handler "+n+" does not exist");return t[n]={kind:e,handler:r},r},dashboard:function(n){return"undefined"==typeof n?e:e=niclabs.insight.Dashboard(n)}}}(jQuery),niclabs.insight.Dashboard=function(n){"use strict";return function(e){function t(n){return n="undefined"==typeof n?u++:n,"layer"+n}var r=["left","right","none"],i="#insight-dashboard";if(!("anchor"in e))throw new Error("Anchor id is required for creating a dashboard");var a=e.anchor;if(e.layout=e.layout||"none",r.indexOf(e.layout)<0)throw new Error("Layout must be one of '"+r.join("','")+"'");var o=n("<div>").setID(i).addClass("mainDashboard").addClass("layout-"+e.layout);n(a).append(o);var s=niclabs.insight.FilterBar();o.append(s.element);var l,c={},u=0,d={},f={};niclabs.insight.event.on("filter_changed",function(e){n.each(c,function(n,t){t.filter(e)})}),niclabs.insight.event.on("layer_data",function(n){l&&n.id===l.id&&niclabs.insight.event.trigger("active_layer_data",n)});var p={get element(){return n(i)[0]},get $(){return n(i)},config:function(n){return e[n]},info:function(e){return"undefined"!=typeof e&&(d="handler"in e?niclabs.insight.handler(e.handler)(p,e):e,n(i).append(d.element)),d},map:function(e){return"undefined"!=typeof e&&(f="handler"in e?niclabs.insight.handler(e.handler)(p,e):e,n(i).append(f.element)),f},layer:function(n,e){if("string"==typeof n)return c[n];if("number"==typeof n)return c[t(n)];var r,i;return"handler"in n?(i=n.id=n.id||t(),r=niclabs.insight.handler(n.handler)(p,n)):(r=n,i=r.id),c[i]=r,(e||1===Object.size(c))&&p.active(i),r},data:function(n){return l?l.data(n):[]},active:function(n){if("undefined"==typeof n)return"undefined"!=typeof l?l.id:void 0;if("undefined"!=typeof l&&l.clear(),"number"==typeof n&&(n=t(n)),!(n in c))throw new Error("Layer with id "+n+" does not exist");return l=c[n],l.load(),l},filter:function(n){return s.filter(n)},clear:function(){l&&l.clear()}};return p}}(jQuery),niclabs.insight.FilterBar=function(n){"use strict";return function(){function e(){for(var n=[],e=0;e<i.length;e++)i[e].element.prop("selectedIndex")>0&&n.push(i[e].options[i[e].element.prop("selectedIndex")-1].filter);return function(e){for(var t=0;t<n.length;t++)if(!n[t](e))return!1;return!0}}var t="#insight-filter-bar",r=n("<div>").setID(t).addClass("filterBar"),i=[],a=new google.maps.Geocoder,o=n("<input>").addClass("search").attr("type","search").attr("placeholder","Enter location");r.append(o);var s=function(){var n=CityDashboard.container("main")[0].data,e=o.val();a.geocode({address:e},function(t,r){r==google.maps.GeocoderStatus.OK?(n.setCenter(t[0].geometry.location),n.fitBounds(t[0].geometry.bounds)):o.val("not found: "+e)})};return o.on("change",s),{get element(){var e=n(t);return r=0===e.length?r:e,r[0]},$:function(){var e=n(t);return r=0===e.length?r:e},filter:function(t){if("number"==typeof t)return i[t];var a=n("<select>"),o=t.description||"",s=n("<option>").text(o);a.append(s);var l;for(l=0;l<t.options.length;l++)s=n("<option>").text(t.options[l].name),a.append(s);return a.on("change",function(){niclabs.insight.event.trigger("filter_changed",e())}),r.append(a),t.element=a,i.push(t),a}}}}(jQuery),niclabs.insight.InfoView=function(n){"use strict";var e=function(e,t){function r(n){return n="undefined"==typeof n?c++:n,"block"+n}function i(n){if("string"==typeof n)return u[n];if("number"==typeof n)return u[r(n)];var e,t;return"handler"in n?(t=n.id=n.id||r(),e=niclabs.insight.handler(n.handler)(d,n)):(e=n,t=e.id),u[t]=e,o.append(e.element),e}t=t||{};var a="#insight-info-view",o=n("<div>").setID(a).addClass("infoWindow");if("none"!==e.config("layout")){var s;"left"===e.config("layout")?s="e":"right"===e.config("layout")&&(s="w"),o.resizable(s)}var l,c=0,u={};if(t.blocks)for(l=0;l<t.blocks.length;l++)i(t.blocks[l]);o.on("resize",function(){for(var n in u)u[n].refresh()}),niclabs.insight.event.on("remove-block",function(n){delete u[n.id]});var d={get element(){var e=n(a);return o=0===e.length?o:e,o[0]},$:function(){var e=n(a);return o=0===e.length?o:e},block:i};return d};return niclabs.insight.handler("basic-info-view","info-view",e),e}(jQuery),niclabs.insight.MapView=function(n){"use strict";return function(e){var t="#insight-map-view",r={lat:e.lat||0,lng:e.lng||0},i=e.zoom||12,a=n("<div>").setID(t).addClass("mapWindow");return{get element(){var e=n(t);return a=0===e.length?a:e,a[0]},$:function(){var e=n(t);return a=0===e.length?a:e},center:function(n,e){return r.lat=n="undefined"==typeof n?r.lat:n,r.lng=e="undefined"==typeof e?r.lng:e,r},lat:function(){return r.lat},lng:function(){return r.lng},zoom:function(n){return i=n="undefined"==typeof n?i:n},container:function(){return a}}}}(jQuery),niclabs.insight.event=function(){"use strict";function n(n,t){if(n in e)for(var r=0;r<e[n].length;r++)if(e[n][r]===t)return r;return-1}var e={};return{on:function(t,r){var i=n(t,r);return 0>i?("event"in e||(e[t]=[]),e[t].push(r)-1):i},off:function(t,r){var i="number"==typeof r?r:n(t,r);return i>=0?(e[t].splice(i,1),!0):!1},trigger:function(n,t){if(n in e)for(var r=0;r<e[n].length;r++)e[n][r](t)}}}(),niclabs.insight.info=function(){var n=function(n){var e=niclabs.insight.dashboard();if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.info(n)};return n}(),niclabs.insight.info.Block=function(n){"use strict";var e=function(e,t){function r(){niclabs.insight.event.trigger("remove-block",{id:i})}if(!("id"in t))throw new Error("All information blocks must have an id");var i=t.id,a="#"===i.charAt(0)?i:"#"+i,o=t.title||"",s=t.properties||{},l=t.preprocess||function(n){return n},c=n("<h4>").append(o).addClass("viz-title"),u=n("<div>").setID(a).addClass("visualization").append(c).append(n("<hr>").addClass("viz-bar"));(void 0===s.closable||s.closable)&&u.closable(function(){r()}),(void 0===s.movable||s.movable)&&u.movable(),u.css(s);var d=t.data||{},f={get id(){return i},get element(){var e=n(a);return u=0===e.length?u:e,u[0]},get $(){var e=n(a);return u=0===e.length?u:e},remove:r,data:function(n){return n="undefined"==typeof n?d:n,d=0===Object.keys(n).length?{}:l(n)},refresh:function(){var n=f.$.find(".latlngView").empty();f.$.find(".deflist").remove();var e=f.data(),t=e.lat,r=e.lng;t&&r&&n.text("lat: "+t+", lng: "+r).insertAfter(f.$.find("hr"))}};return f};return e}(jQuery),niclabs.insight.info.SummaryBlock=function(n){var e=function(e,t){var r=niclabs.insight.info.Block(e,t),i=["lat","lng","value"];i=i.concat(t.ignore||[]),r.$.addClass("summary-viz"),r.$.append(n("<h6>").addClass("latlngView")),r.$.append(n("<dl>").addClass("deflist"));var a=r.refresh;return r.refresh=function(){a(),r.$.append(n("<dl>").addClass("deflist")),r.summary(r.data())},r.summary=function(e){n.each(e,function(e,t){i.indexOf(e)<0&&r.$.find(".deflist").append(n("<dt>").text(e).addClass("deflist-key")).append(n("<dd>").text(t).addClass("deflist-value"))})},t.data&&r.summary(t.data),niclabs.insight.event.on("map_element_selected",function(n){r.data(n),r.refresh()}),r};return niclabs.insight.handler("summary-block","info-block",e),e}(jQuery),niclabs.insight.layer=function(){var n=function(n,e){var t=niclabs.insight.dashboard();if("undefined"==typeof t)throw new Error("Dashboard has not been initialized");return t.layer(n,e)};return n}(),niclabs.insight.layer.Layer=function(n){"use strict";var e=function(e,t){if(!("id"in t))throw Error("All layers must have an id.");var r=t.id;if(!("data"in t))throw Error("All layers must provide a data source.");var i=!1,a=[];"string"==typeof t.data?i=t.data:a=t.data&&t.data.length?t.data:[t.data];var o=!1,s={get id(){return r},data:function(n){return"undefined"==typeof n?o||!i?a:i:"string"==typeof n?(i=n,o&&s.load(),i):a=n.length?n:[n]},load:function(){function e(n){a=n,niclabs.insight.event.trigger("layer_data",{id:r,data:a}),s.clear(),s.draw(a)}i?n.getJSON(i,e):e(a)},draw:function(){},filter:function(){},clear:function(){}};return s};return e}(jQuery),niclabs.insight.layer.MarkerLayer=function(n){var e=function(e,t){function r(t,r,a){var o;if("type"in a){var s={layer:i.id};n.extend(s,a,t[r]),o=niclabs.insight.handler(a.type)(e,s)}else o=a;return o.clickable(!0),o}var i=niclabs.insight.layer.Layer(e,t),a=t.marker||{type:"simple-marker"},o=[];return i.draw=function(n){for(var e=0;e<n.length;e++)o.push(r(n,e,a))},i.clear=function(){for(var n=0;n<o.length;n++)o[n].clear()},i.filter=function(n){for(var e=i.data(),t=0;t<o.length;t++)o[t].visible(n(e[t]))},i};return niclabs.insight.handler("marker-layer","layer",e),e}(jQuery),niclabs.insight.map=function(){var n=function(n){var e=niclabs.insight.dashboard();if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.map(n)};return n}(),niclabs.insight.map.GoogleMap=function(){"use strict";var n=function(n,e){var t=niclabs.insight.MapView(e),r=new google.maps.Map(t.container()[0],{zoom:t.zoom(),center:new google.maps.LatLng(t.lat(),t.lng()),disableDefaultUI:!0}),i=t.zoom;google.maps.event.addListener(r,"zoom_changed",function(){i(r.getZoom())}),t.zoom=function(n){return n=i(n),r.setZoom(n),n};var a=t.center;return google.maps.event.addListener(r,"center_changed",function(){var n=r.getCenter();a(n.lat(),n.lng())}),t.center=function(n,e){var t=a(n,e);return r.setCenter({lat:t.lat,lng:t.lng}),t},t.googlemap=function(){return r},t};return niclabs.insight.handler("google-map","map-view",n),n}(jQuery),niclabs.insight.map.marker={},niclabs.insight.map.marker.CircleMarker=function(){var n=function(n,e){var t=niclabs.insight.map.marker.Marker(n,e),r=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i=new google.maps.Circle({center:r,map:t.map.googlemap(),radius:e.radius||400,strokeColor:e.strokeColor||"#FF0000",strokeOpacity:e.strokeOpacity||.8,strokeWeight:e.strokeWeight||2,fillColor:e.fillColor||"#FF0000",fillOpacity:e.fillOpacity||.35,title:e.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("circle-marker","marker",n),n}(jQuery),niclabs.insight.map.marker.ImageMarker=function(){var n=function(n,e){var t=niclabs.insight.map.marker.Marker(n,e),r=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i={url:e.src||"img/not-found.svg",scaledSize:new google.maps.Size(30,50)},a=new google.maps.Marker({position:r,map:t.map.googlemap(),icon:i,title:e.landmark||""});return t.marker=function(){return a},t};return niclabs.insight.handler("image-marker","marker",n),n}(jQuery),niclabs.insight.map.marker.Marker=function(){var n=function(n,e){if(!("layer"in e))throw new Error("The marker must be associated to a layer");var t;if(!(t=n.layer(e.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=n.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Markers are only supported for Google Maps at the moment");var i,a={get map(){return r},get layer(){return t},marker:function(){return void 0},clickable:function(n){if(n){var t=a.marker();i=google.maps.event.addListener(t,"click",function(){niclabs.insight.event.trigger("map_element_selected",e),"setAnimation"in t&&t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)},3e3)})}else"undefined"!=typeof i&&(google.maps.event.removeListener(i),i=void 0);return void 0!==i},clear:function(){var n=a.marker();n.setMap(null)},visible:function(n){return"undefined"==typeof n?a.marker().getVisible():(a.marker().setVisible(n),n)}};return a};return n}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(){var n=function(n,e){var t=niclabs.insight.map.marker.Marker(n,e),r=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i=new google.maps.Marker({position:r,map:t.map.googlemap(),title:e.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("simple-marker","marker",n),n}(jQuery);