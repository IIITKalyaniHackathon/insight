var niclabs={};niclabs.insight=function(n){"use strict";n.fn.resizable=function(e){function t(e){o=e.clientX,s=e.clientY,l=p.outerWidth(),u=p.outerHeight(),n(document).on("mousemove",r),n(document).on("mouseup",i)}function r(n){d&&p.css("height",u+n.clientY-s+"px"),c&&p.css("width",l+n.clientX-o+"px"),f&&p.css("top",n.clientY+"px").css("height",u+s-n.clientY+"px"),h&&p.css("left",n.clientX+"px").css("width",l-n.clientX+"px")}function i(){n(document).off("mousemove",r),n(document).off("mouseup",i),p.trigger("resize")}var a=n("<div>").addClass("resizer").addClass(e+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",t);var o,s,l,u,c,d,f,h,p=this;return d=e.search("s")>=0,c=e.search("e")>=0,f=e.search("n")>=0,h=e.search("w")>=0,this.scroll(function(){a.css("top",p.scrollTop())}),this},n.fn.setID=function(n){return"#"===n.charAt(0)&&(n=n.slice(1)),this.attr("id",n),this},n.fn.movable=function(){var e=this.children(".options-panel");e.length||(e=n("<span>").addClass("options-panel"),this.prepend(e));var t=n("<span>").addClass("up-button").append("&#x25B2;"),r=n("<span>").addClass("down-button").append("&#x25BC;");e.prepend(r),e.prepend(t);var i=this;return t.on("click",function(){i.insertBefore(i.prev())}),r.on("click",function(){i.insertAfter(i.next())}),this},n.fn.closable=function(e){e||(e=function(){});var t=this.children(".options-panel");t.length||(t=n("<span>").addClass("options-panel"),this.prepend(t));var r=n("<span>").addClass("close-button").text("X");t.append(r);var i=this;return r.on("click",function(){i.remove(),e()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(e,t){return n.inArray(e,this,t)},Object.size=function(n){var e,t=0;for(e in n)n.hasOwnProperty(e)&&t++;return t};var e,t={};return{handler:function(n,e,r){if(n in t){if(e="undefined"==typeof e?t[n].kind:e,r="undefined"==typeof r?t[n].handler:r,e!==t[n].kind)throw new Error("There already exists a handler with name "+n+" for kind "+t[n].kind)}else if("undefined"==typeof e&&"undefined"==typeof r)throw new Error("Handler "+n+" does not exist");return t[n]={kind:e,handler:r},r},init:function(n){return e=niclabs.insight.Dashboard(n)},infoview:function(n){if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.infoview(n)},mapview:function(n){if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.mapview(n)}}}(jQuery),niclabs.insight.Dashboard=function(n){"use strict";return function(e){function t(n){return n="undefined"==typeof n?u++:n,"layer"+n}var r=["left","right","none"],i="#insight-dashboard";if(!("anchor"in e))throw new Error("Anchor id is required for creating a dashboard");var a=e.anchor;if(e.layout=e.layout||"none",r.indexOf(e.layout)<0)throw new Error("Layout must be one of '"+r.join("','")+"'");var o=n("<div>").setID(i).addClass("mainDashboard").addClass("layout-"+e.layout);n(a).append(o);var s,l={},u=0,c={},d={};niclabs.insight.event.on("layer_data",function(n){s&&n.id===s.id&&niclabs.insight.event.trigger("active_layer_data",n)});var f={get element(){return n(i)[0]},get $(){return n(i)},config:function(n){return e[n]},infoview:function(e){return"undefined"!=typeof e&&(c="handler"in e?niclabs.insight.handler(e.handler)(f,e):e,n(i).append(c.element)),c},mapview:function(e){return"undefined"!=typeof e&&(d="handler"in e?niclabs.insight.handler(e.handler)(f,e):e,n(i).append(d.element)),d},layer:function(n,e){if("string"==typeof n)return l[n];if("number"==typeof n)return l[t(n)];var r,i;return"handler"in n?(i=n.id=n.id||t(),r=niclabs.insight.handler(n.handler)(f,n)):(r=n,i=r.id),l[i]=r,(e||1===Object.size(l))&&f.active(i),r},data:function(n){return s?s.data(n):[]},active:function(n){if("undefined"==typeof n)return"undefined"!=typeof s?s.id:void 0;if("undefined"!=typeof s&&s.clear(),"number"==typeof n&&(n=t(n)),!(n in l))throw new Error("Layer with id "+n+" does not exist");return s=l[n],s.load(),s},addFilter:function(n){return filterBar.addFilter(n),f},clear:function(){s&&s.clear()}};return f}}(jQuery),niclabs.insight.InfoView=function(n){"use strict";var e=function(e,t){function r(n){return n="undefined"==typeof n?u++:n,"block"+n}function i(n){if("string"==typeof n)return c[n];if("number"==typeof n)return c[r(n)];var e,t;return"handler"in n?(t=n.id=n.id||r(),e=niclabs.insight.handler(n.handler)(d,n)):(e=n,t=e.id),c[t]=e,o.append(e.element),e}t=t||{};var a="#insight-info-view",o=n("<div>").setID(a).addClass("infoWindow");if("none"!==e.config("layout")){var s;"left"===e.config("layout")?s="e":"right"===e.config("layout")&&(s="w"),o.resizable(s)}var l,u=0,c={};if(t.blocks)for(l=0;l<t.blocks.length;l++)i(t.blocks[l]);o.on("resize",function(){for(var n in c)c[n].refresh()}),niclabs.insight.event.on("remove-block",function(n){delete c[n.id]});var d={get element(){var e=n(a);return o=0===e.length?o:e,o[0]},$:function(){var e=n(a);return o=0===e.length?o:e},block:i};return d};return niclabs.insight.handler("basic-info-view","info-view",e),e}(jQuery),niclabs.insight.MapView=function(n){"use strict";return function(e){var t="#insight-map-view",r={lat:e.lat||0,lng:e.lng||0},i=e.zoom||12,a=n("<div>").setID(t).addClass("mapWindow");return{get element(){var e=n(t);return a=0===e.length?a:e,a[0]},$:function(){var e=n(t);return a=0===e.length?a:e},center:function(n,e){return r.lat=n="undefined"==typeof n?r.lat:n,r.lng=e="undefined"==typeof e?r.lng:e,r},lat:function(){return r.lat},lng:function(){return r.lng},zoom:function(n){return i=n="undefined"==typeof n?i:n},container:function(){return a}}}}(jQuery),niclabs.insight.event=function(){"use strict";function n(n,t){if(n in e)for(var r=0;r<e[n].length;r++)if(e[n][r]===t)return r;return-1}var e={};return{on:function(t,r){var i=n(t,r);return 0>i?("event"in e||(e[t]=[]),e[t].push(r)-1):i},off:function(t,r){var i="number"==typeof r?r:n(t,r);return i>=0?(e[t].splice(i,1),!0):!1},trigger:function(n,t){if(n in e)for(var r=0;r<e[n].length;r++)e[n][r](t)}}}(),niclabs.insight.info={},niclabs.insight.info.Block=function(n){"use strict";var e=function(e,t){function r(){niclabs.insight.event.trigger("remove-block",{id:i,datasource:l})}if(!("id"in t))throw new Error("All information blocks must have an id");var i=t.id,a="#"===i.charAt(0)?i:"#"+i,o=t.title||"",s=t.properties||{},l=t.datasource||i,u=t.preprocess||function(n){return n},c=n("<h4>").append(o).addClass("viz-title"),d=n("<div>").setID(a).addClass("visualization").append(c).append(n("<hr>").addClass("viz-bar"));(void 0===s.closable||s.closable)&&d.closable(function(){r()}),(void 0===s.movable||s.movable)&&d.movable(),d.append(n("<h6>").addClass("latlngView")),d.css(s);var f={},h={get id(){return i},get element(){var e=n(a);return d=0===e.length?d:e,d[0]},get $(){var e=n(a);return d=0===e.length?d:e},remove:r,data:function(n){return n="undefined"==typeof n?f:n,f=0===Object.keys(n).length?{}:u(n)},refresh:function(){var n=h.$.find(".latlngView").empty();h.$.find(".deflist").remove();var e=h.getData(),t=e.lat,r=e.lng;t&&r&&n.text("lat: "+t+", lng: "+r).insertAfter(h.$.find("hr"))},createDefList:function(e){n.each(e,function(e,t){"lat"!==e&&"lng"!==e&&"value"!==e&&h.$.find(".deflist").append(n("<dt>").text(e).addClass("deflist-key")).append(n("<dd>").text(t).addClass("deflist-value"))})}};return h};return e}(jQuery),niclabs.insight.info.SummaryBlock=function(n){var e=function(e,t){var r=niclabs.insight.info.Block(e,t);r.$.addClass("summary-viz");var i=r.refresh;return r.refresh=function(){i(),r.$.append(n("<dl>").addClass("deflist")),r.createDeflist(r.data())},r};return niclabs.insight.handler("summary-block","info-block",e),e}(jQuery),niclabs.insight.layer={},niclabs.insight.layer.Layer=function(n){"use strict";var e=function(e,t){if(!("id"in t))throw Error("All layers must have an id.");var r=t.id;if(!("data"in t))throw Error("All layers must provide a data source.");var i=!1,a=[];"string"==typeof t.data?i=t.data:a=t.data&&t.data.length?t.data:[t.data];var o=!1,s={get id(){return r},data:function(n){return"undefined"==typeof n?o?a:i:"string"==typeof n?(i=n,o&&s.load(),i):a=n.length?n:[n]},load:function(){function e(n){a=n,niclabs.insight.event.trigger("layer_data",{id:r,data:a}),s.clear(),s.draw(a)}i?n.getJSON(i,e):e(a)},draw:function(){},filter:function(){},clear:function(){}};return s};return e}(jQuery),niclabs.insight.layer.MarkerLayer=function(){var n=function(n,e){function t(e,t,i){var a;return"type"in i?(i.layer=r.id,i.lat=e[t].lat,i.lng=e[t].lng,a=niclabs.insight.handler(i.type)(n,i)):a=i,a.clickable(!0),a}var r=niclabs.insight.layer.Layer(n,e),i=e.marker||{type:"simple-marker"},a=[];return r.draw=function(n){for(var e=0;e<n.length;e++)a.push(t(n,e,i))},r.clear=function(){for(var n=0;n<a.length;n++)a[n].clear()},r.filter=function(n){for(var e=0;e<a.length;e++)a[e].visible(n(data[e]))},r};return niclabs.insight.handler("marker-layer","layer",n),n}(jQuery),niclabs.insight.map={},niclabs.insight.map.GoogleMap=function(){"use strict";var n=function(n,e){var t=niclabs.insight.MapView(e),r=new google.maps.Map(t.container()[0],{zoom:t.zoom(),center:new google.maps.LatLng(t.lat(),t.lng()),disableDefaultUI:!0}),i=t.zoom;google.maps.event.addListener(r,"zoom_changed",function(){i(r.getZoom())}),t.zoom=function(n){return n=i(n),r.setZoom(n),n};var a=t.center;return google.maps.event.addListener(r,"center_changed",function(){var n=r.getCenter();a(n.lat(),n.lng())}),t.center=function(n,e){var t=a(n,e);return r.setCenter({lat:t.lat,lng:t.lng}),t},t.googlemap=function(){return r},t};return niclabs.insight.handler("google-map","map-view",n),n}(jQuery),niclabs.insight.map.marker={},niclabs.insight.map.marker.Marker=function(){var n=function(n,e){if(!("layer"in e))throw new Error("The marker must be associated to a layer");var t;if(!(t=n.layer(e.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=n.mapview()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Markers are only supported for Google Maps at the moment");var i,a={get map(){return r},get layer(){return t},marker:function(){return void 0},clickable:function(n){if(n){var t=a.marker();i=google.maps.event.addListener(t,"click",function(){niclabs.insight.event.trigger("marker_pressed",e),t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)},3e3)})}else"undefined"!=typeof i&&(google.maps.event.removeListener(i),i=void 0);return void 0!==i},clear:function(){var n=a.marker();n.setMap(null)},visible:function(n){return"undefined"==typeof n?a.marker().getVisible():(a.marker().setVisible(n),n)}};return a};return n}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(){var n=function(n,e){var t=niclabs.insight.map.marker.Marker(n,e),r=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i=new google.maps.Marker({position:r,map:t.map.googlemap(),title:e.description||""});return t.marker=function(){return i},t};return niclabs.insight.handler("simple-marker","marker",n),n}(jQuery);