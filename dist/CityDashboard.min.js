var niclabs={};niclabs.insight=function(n){"use strict";n.fn.resizable=function(e){function r(e){o=e.clientX,s=e.clientY,l=p.outerWidth(),c=p.outerHeight(),n(document).on("mousemove",t),n(document).on("mouseup",i)}function t(n){d&&p.css("height",c+n.clientY-s+"px"),u&&p.css("width",l+n.clientX-o+"px"),f&&p.css("top",n.clientY+"px").css("height",c+s-n.clientY+"px"),h&&p.css("left",n.clientX+"px").css("width",l-n.clientX+"px")}function i(){n(document).off("mousemove",t),n(document).off("mouseup",i),p.trigger("resize")}var a=n("<div>").addClass("resizer").addClass(e+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",r);var o,s,l,c,u,d,f,h,p=this;return d=e.search("s")>=0,u=e.search("e")>=0,f=e.search("n")>=0,h=e.search("w")>=0,this.scroll(function(){a.css("top",p.scrollTop())}),this},n.fn.setID=function(n){return"#"===n.charAt(0)&&(n=n.slice(1)),this.attr("id",n),this},n.fn.movable=function(){var e=this.children(".options-panel");e.length||(e=n("<span>").addClass("options-panel"),this.prepend(e));var r=n("<span>").addClass("up-button").append("&#x25B2;"),t=n("<span>").addClass("down-button").append("&#x25BC;");e.prepend(t),e.prepend(r);var i=this;return r.on("click",function(){i.insertBefore(i.prev())}),t.on("click",function(){i.insertAfter(i.next())}),this},n.fn.closable=function(e){e||(e=function(){});var r=this.children(".options-panel");r.length||(r=n("<span>").addClass("options-panel"),this.prepend(r));var t=n("<span>").addClass("close-button").text("X");r.append(t);var i=this;return t.on("click",function(){i.remove(),e()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(e,r){return n.inArray(e,this,r)},Object.size=function(n){var e,r=0;for(e in n)n.hasOwnProperty(e)&&r++;return r};var e,r={};return{handler:function(n,e,t){if(n in r){if(e="undefined"==typeof e?r[n].kind:e,t="undefined"==typeof t?r[n].handler:t,e!==r[n].kind)throw new Error("There already exists a handler with name "+n+" for kind "+r[n].kind)}else if("undefined"==typeof e&&"undefined"==typeof t)throw new Error("Handler "+n+" does not exist");return r[n]={kind:e,handler:t},t},dashboard:function(n){return"undefined"==typeof n?e:e=niclabs.insight.Dashboard(n)}}}(jQuery),niclabs.insight.Dashboard=function(n){"use strict";return function(e){function r(n){return n="undefined"==typeof n?c++:n,"layer"+n}var t=["left","right","none"],i="#insight-dashboard";if(!("anchor"in e))throw new Error("Anchor id is required for creating a dashboard");var a=e.anchor;if(e.layout=e.layout||"none",t.indexOf(e.layout)<0)throw new Error("Layout must be one of '"+t.join("','")+"'");var o=n("<div>").setID(i).addClass("mainDashboard").addClass("layout-"+e.layout);n(a).append(o);var s,l={},c=0,u={},d={};niclabs.insight.event.on("layer_data",function(n){s&&n.id===s.id&&niclabs.insight.event.trigger("active_layer_data",n)});var f={get element(){return n(i)[0]},get $(){return n(i)},config:function(n){return e[n]},info:function(e){return"undefined"!=typeof e&&(u="handler"in e?niclabs.insight.handler(e.handler)(f,e):e,n(i).append(u.element)),u},map:function(e){return"undefined"!=typeof e&&(d="handler"in e?niclabs.insight.handler(e.handler)(f,e):e,n(i).append(d.element)),d},layer:function(n,e){if("string"==typeof n)return l[n];if("number"==typeof n)return l[r(n)];var t,i;return"handler"in n?(i=n.id=n.id||r(),t=niclabs.insight.handler(n.handler)(f,n)):(t=n,i=t.id),l[i]=t,(e||1===Object.size(l))&&f.active(i),t},data:function(n){return s?s.data(n):[]},active:function(n){if("undefined"==typeof n)return"undefined"!=typeof s?s.id:void 0;if("undefined"!=typeof s&&s.clear(),"number"==typeof n&&(n=r(n)),!(n in l))throw new Error("Layer with id "+n+" does not exist");return s=l[n],s.load(),s},addFilter:function(n){return filterBar.addFilter(n),f},clear:function(){s&&s.clear()}};return f}}(jQuery),niclabs.insight.InfoView=function(n){"use strict";var e=function(e,r){function t(n){return n="undefined"==typeof n?c++:n,"block"+n}function i(n){if("string"==typeof n)return u[n];if("number"==typeof n)return u[t(n)];var e,r;return"handler"in n?(r=n.id=n.id||t(),e=niclabs.insight.handler(n.handler)(d,n)):(e=n,r=e.id),u[r]=e,o.append(e.element),e}r=r||{};var a="#insight-info-view",o=n("<div>").setID(a).addClass("infoWindow");if("none"!==e.config("layout")){var s;"left"===e.config("layout")?s="e":"right"===e.config("layout")&&(s="w"),o.resizable(s)}var l,c=0,u={};if(r.blocks)for(l=0;l<r.blocks.length;l++)i(r.blocks[l]);o.on("resize",function(){for(var n in u)u[n].refresh()}),niclabs.insight.event.on("remove-block",function(n){delete u[n.id]});var d={get element(){var e=n(a);return o=0===e.length?o:e,o[0]},$:function(){var e=n(a);return o=0===e.length?o:e},block:i};return d};return niclabs.insight.handler("basic-info-view","info-view",e),e}(jQuery),niclabs.insight.MapView=function(n){"use strict";return function(e){var r="#insight-map-view",t={lat:e.lat||0,lng:e.lng||0},i=e.zoom||12,a=n("<div>").setID(r).addClass("mapWindow");return{get element(){var e=n(r);return a=0===e.length?a:e,a[0]},$:function(){var e=n(r);return a=0===e.length?a:e},center:function(n,e){return t.lat=n="undefined"==typeof n?t.lat:n,t.lng=e="undefined"==typeof e?t.lng:e,t},lat:function(){return t.lat},lng:function(){return t.lng},zoom:function(n){return i=n="undefined"==typeof n?i:n},container:function(){return a}}}}(jQuery),niclabs.insight.event=function(){"use strict";function n(n,r){if(n in e)for(var t=0;t<e[n].length;t++)if(e[n][t]===r)return t;return-1}var e={};return{on:function(r,t){var i=n(r,t);return 0>i?("event"in e||(e[r]=[]),e[r].push(t)-1):i},off:function(r,t){var i="number"==typeof t?t:n(r,t);return i>=0?(e[r].splice(i,1),!0):!1},trigger:function(n,r){if(n in e)for(var t=0;t<e[n].length;t++)e[n][t](r)}}}(),niclabs.insight.layer=function(){var n=function(n,e){var r=niclabs.insight.dashboard();if("undefined"==typeof r)throw new Error("Dashboard has not been initialized");return r.layer(n,e)};return n}(),niclabs.insight.layer.Layer=function(n){"use strict";var e=function(e,r){if(!("id"in r))throw Error("All layers must have an id.");var t=r.id;if(!("data"in r))throw Error("All layers must provide a data source.");var i=!1,a=[];"string"==typeof r.data?i=r.data:a=r.data&&r.data.length?r.data:[r.data];var o=!1,s={get id(){return t},data:function(n){return"undefined"==typeof n?o?a:i:"string"==typeof n?(i=n,o&&s.load(),i):a=n.length?n:[n]},load:function(){function e(n){a=n,niclabs.insight.event.trigger("layer_data",{id:t,data:a}),s.clear(),s.draw(a)}i?n.getJSON(i,e):e(a)},draw:function(){},filter:function(){},clear:function(){}};return s};return e}(jQuery),niclabs.insight.layer.MarkerLayer=function(n){var e=function(e,r){function t(r,t,a){var o;if("type"in a){var s={layer:i.id};n.extend(s,a,r[t]),o=niclabs.insight.handler(a.type)(e,s)}else o=a;return o.clickable(!0),o}var i=niclabs.insight.layer.Layer(e,r),a=r.marker||{type:"simple-marker"},o=[];return i.draw=function(n){for(var e=0;e<n.length;e++)o.push(t(n,e,a))},i.clear=function(){for(var n=0;n<o.length;n++)o[n].clear()},i.filter=function(n){for(var e=0;e<o.length;e++)o[e].visible(n(data[e]))},i};return niclabs.insight.handler("marker-layer","layer",e),e}(jQuery),niclabs.insight.map=function(){var n=function(n){var e=niclabs.insight.dashboard();if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.map(n)};return n}(),niclabs.insight.map.GoogleMap=function(){"use strict";var n=function(n,e){var r=niclabs.insight.MapView(e),t=new google.maps.Map(r.container()[0],{zoom:r.zoom(),center:new google.maps.LatLng(r.lat(),r.lng()),disableDefaultUI:!0}),i=r.zoom;google.maps.event.addListener(t,"zoom_changed",function(){i(t.getZoom())}),r.zoom=function(n){return n=i(n),t.setZoom(n),n};var a=r.center;return google.maps.event.addListener(t,"center_changed",function(){var n=t.getCenter();a(n.lat(),n.lng())}),r.center=function(n,e){var r=a(n,e);return t.setCenter({lat:r.lat,lng:r.lng}),r},r.googlemap=function(){return t},r};return niclabs.insight.handler("google-map","map-view",n),n}(jQuery),niclabs.insight.info=function(){var n=function(n){var e=niclabs.insight.dashboard();if("undefined"==typeof e)throw new Error("Dashboard has not been initialized");return e.info(n)};return n}(),niclabs.insight.info.Block=function(n){"use strict";var e=function(e,r){function t(){niclabs.insight.event.trigger("remove-block",{id:i,datasource:l})}if(!("id"in r))throw new Error("All information blocks must have an id");var i=r.id,a="#"===i.charAt(0)?i:"#"+i,o=r.title||"",s=r.properties||{},l=r.datasource||i,c=r.preprocess||function(n){return n},u=n("<h4>").append(o).addClass("viz-title"),d=n("<div>").setID(a).addClass("visualization").append(u).append(n("<hr>").addClass("viz-bar"));(void 0===s.closable||s.closable)&&d.closable(function(){t()}),(void 0===s.movable||s.movable)&&d.movable(),d.append(n("<h6>").addClass("latlngView")),d.css(s);var f={},h={get id(){return i},get element(){var e=n(a);return d=0===e.length?d:e,d[0]},get $(){var e=n(a);return d=0===e.length?d:e},remove:t,data:function(n){return n="undefined"==typeof n?f:n,f=0===Object.keys(n).length?{}:c(n)},refresh:function(){var n=h.$.find(".latlngView").empty();h.$.find(".deflist").remove();var e=h.getData(),r=e.lat,t=e.lng;r&&t&&n.text("lat: "+r+", lng: "+t).insertAfter(h.$.find("hr"))},createDefList:function(e){n.each(e,function(e,r){"lat"!==e&&"lng"!==e&&"value"!==e&&h.$.find(".deflist").append(n("<dt>").text(e).addClass("deflist-key")).append(n("<dd>").text(r).addClass("deflist-value"))})}};return h};return e}(jQuery),niclabs.insight.info.SummaryBlock=function(n){var e=function(e,r){var t=niclabs.insight.info.Block(e,r);t.$.addClass("summary-viz");var i=t.refresh;return t.refresh=function(){i(),t.$.append(n("<dl>").addClass("deflist")),t.createDeflist(t.data())},t};return niclabs.insight.handler("summary-block","info-block",e),e}(jQuery),niclabs.insight.map.marker={},niclabs.insight.map.marker.CircleMarker=function(){var n=function(n,e){var r=niclabs.insight.map.marker.Marker(n,e),t=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i=new google.maps.Circle({center:t,map:r.map.googlemap(),radius:e.radius||400,strokeColor:e.strokeColor||"#FF0000",strokeOpacity:e.strokeOpacity||.8,strokeWeight:e.strokeWeight||2,fillColor:e.fillColor||"#FF0000",fillOpacity:e.fillOpacity||.35,title:e.description||""});return r.marker=function(){return i},r};return niclabs.insight.handler("circle-marker","marker",n),n}(jQuery),niclabs.insight.map.marker.ImageMarker=function(){var n=function(n,e){var r=niclabs.insight.map.marker.Marker(n,e),t=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i={url:e.src||"img/not-found.svg",scaledSize:new google.maps.Size(30,50)},a=new google.maps.Marker({position:t,map:r.map.googlemap(),icon:i,title:e.description||""});return r.marker=function(){return a},r};return niclabs.insight.handler("image-marker","marker",n),n}(jQuery),niclabs.insight.map.marker.Marker=function(){var n=function(n,e){if(!("layer"in e))throw new Error("The marker must be associated to a layer");var r;if(!(r=n.layer(e.layer)))throw new Error("The layer "+r+" does not exist in the dashboard");var t;if(!(t=n.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in t))throw new Error("Markers are only supported for Google Maps at the moment");var i,a={get map(){return t},get layer(){return r},marker:function(){return void 0},clickable:function(n){if(n){var r=a.marker();i=google.maps.event.addListener(r,"click",function(){niclabs.insight.event.trigger("marker_pressed",e),"setAnimation"in r&&r.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){r.setAnimation(null)},3e3)})}else"undefined"!=typeof i&&(google.maps.event.removeListener(i),i=void 0);return void 0!==i},clear:function(){var n=a.marker();n.setMap(null)},visible:function(n){return"undefined"==typeof n?a.marker().getVisible():(a.marker().setVisible(n),n)}};return a};return n}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(){var n=function(n,e){var r=niclabs.insight.map.marker.Marker(n,e),t=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),i=new google.maps.Marker({position:t,map:r.map.googlemap(),title:e.description||""});return r.marker=function(){return i},r};return niclabs.insight.handler("simple-marker","marker",n),n}(jQuery);