var niclabs={};niclabs.insight=function(e){"use strict";e.fn.resizable=function(n){function t(n){o=n.clientX,s=n.clientY,l=p.outerWidth(),c=p.outerHeight(),e(document).on("mousemove",r),e(document).on("mouseup",i)}function r(e){d&&p.css("height",c+e.clientY-s+"px"),u&&p.css("width",l+e.clientX-o+"px"),f&&p.css("top",e.clientY+"px").css("height",c+s-e.clientY+"px"),h&&p.css("left",e.clientX+"px").css("width",l-e.clientX+"px")}function i(){e(document).off("mousemove",r),e(document).off("mouseup",i),p.trigger("resize")}var a=e("<div>").addClass("resizer").addClass(n+"-resize");this.append(a).addClass("resizable"),a.on("mousedown",t);var o,s,l,c,u,d,f,h,p=this;return d=n.search("s")>=0,u=n.search("e")>=0,f=n.search("n")>=0,h=n.search("w")>=0,this.scroll(function(){a.css("top",p.scrollTop())}),this},e.fn.setID=function(e){return"#"===e.charAt(0)&&(e=e.slice(1)),this.attr("id",e),this},e.fn.movable=function(){var n=this.children(".header");0===n.length&&(n=e("<div>").addClass("header"),this.prepend(n));var t=e("<span>").addClass("button").attr("data-icon","up-arrow"),r=e("<span>").addClass("button").attr("data-icon","down-arrow");n.append(t),n.append(r);var i=this;return t.on("click",function(){i.insertBefore(i.prev())}),r.on("click",function(){i.insertAfter(i.next())}),this},e.fn.closable=function(n){n||(n=function(){});var t=this.children(".header");t.length||(t=e("<span>").addClass("header"),this.prepend(t));var r=e("<span>").addClass("button").attr("data-icon","close");t.prepend(r);var i=this;return r.on("click",function(){i.remove(),n()}),this},Array.prototype.indexOf="indexOf"in Array.prototype?Array.prototype.indexOf:function(n,t){return e.inArray(n,this,t)},Object.size=function(e){var n,t=0;for(n in e)e.hasOwnProperty(n)&&t++;return t},Object.prototype.watch||Object.defineProperty(Object.prototype,"watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,n){var t=this[e],r=function(){return t},i=function(r){return t===r?!1:(n.call(this,e,t,r),void(t=r))};delete this[e]&&Object.defineProperty(this,e,{get:r,set:i,enumerable:!0,configurable:!0})}}),Object.prototype.unwatch||Object.defineProperty(Object.prototype,"unwatch",{enumerable:!1,configurable:!0,writable:!1,value:function(e){var n=this[e];delete this[e],this[e]=n}}),Object.prototype.spy||Object.defineProperty(Object.prototype,"spy",{enumerable:!1,configurable:!0,writable:!1,value:function(e){for(var n in this)this.hasOwnProperty(n)&&this.watch(n,e)}}),Object.prototype.unspy||Object.defineProperty(Object.prototype,"unspy",{enumerable:!1,configurable:!0,writable:!1,value:function(){for(var e in this)this.hasOwnProperty(e)&&this.unwatch(e)}});var n,t={};return{handler:function(e,n,r){if(e in t){if(n="undefined"==typeof n?t[e].kind:n,r="undefined"==typeof r?t[e].handler:r,n!==t[e].kind)throw new Error("There already exists a handler with name "+e+" for kind "+t[e].kind)}else if("undefined"==typeof n&&"undefined"==typeof r)throw new Error("Handler "+e+" does not exist");return t[e]={kind:n,handler:r},r},dashboard:function(e){return"undefined"==typeof e?n:n=niclabs.insight.Dashboard(e)}}}(jQuery),niclabs.insight.Dashboard=function(e){"use strict";return function(n){function t(e){return e="undefined"==typeof e?u++:e,"layer"+e}var r=["left","right","none"],i="#insight-dashboard";if(!("anchor"in n))throw new Error("Anchor id is required for creating a dashboard");var a=n.anchor;if(n.layout=n.layout||"none",r.indexOf(n.layout)<0)throw new Error("Layout must be one of '"+r.join("','")+"'");var o=e("<div>").setID(i).addClass("insight").addClass(n.layout);e(a).append(o);var s=niclabs.insight.FilterBar();o.append(s.element);var l,c={},u=0,d={},f={};niclabs.insight.event.on("filter_changed",function(n){e.each(c,function(e,t){t.filter(n)})}),niclabs.insight.event.on("layer_data",function(e){l&&e.id===l.id&&niclabs.insight.event.trigger("active_layer_data",e)});var h={get element(){return e(i)[0]},get $(){return e(i)},config:function(e){return n[e]},info:function(n){return"undefined"!=typeof n&&(d="handler"in n?niclabs.insight.handler(n.handler)(h,n):n,e(i).append(d.element)),d},map:function(n){return"undefined"!=typeof n&&(f="handler"in n?niclabs.insight.handler(n.handler)(h,n):n,e(i).append(f.element)),f},layer:function(e,n){if("string"==typeof e)return c[e];if("number"==typeof e)return c[t(e)];var r,i;return"handler"in e?(i=e.id=e.id||t(),r=niclabs.insight.handler(e.handler)(h,e)):(r=e,i=r.id),c[i]=r,(n||1===Object.size(c))&&h.active(i),r},data:function(e){return l?l.data(e):[]},active:function(e){if("undefined"==typeof e)return"undefined"!=typeof l?l.id:void 0;if("undefined"!=typeof l&&l.clear(),"number"==typeof e&&(e=t(e)),!(e in c))throw new Error("Layer with id "+e+" does not exist");return l=c[e],l.load(),l},filter:function(e){return s.filter(e)},clear:function(){l&&l.clear()}};return h}}(jQuery),niclabs.insight.FilterBar=function(e){"use strict";return function(){function n(){for(var e=[],n=0;n<i.length;n++)i[n].element.prop("selectedIndex")>0&&e.push(i[n].options[i[n].element.prop("selectedIndex")-1].filter);return function(n){for(var t=0;t<e.length;t++)if(!e[t](n))return!1;return!0}}var t="#insight-filter-bar",r=e("<div>").setID(t).addClass("filters"),i=[],a=new google.maps.Geocoder,o=e("<input>").addClass("search").attr("type","search").attr("placeholder","Enter location");r.append(o);var s=function(){var e=CityDashboard.container("main")[0].data,n=o.val();a.geocode({address:n},function(t,r){r==google.maps.GeocoderStatus.OK?(e.setCenter(t[0].geometry.location),e.fitBounds(t[0].geometry.bounds)):o.val("not found: "+n)})};return o.on("change",s),{get element(){var n=e(t);return r=0===n.length?r:n,r[0]},$:function(){var n=e(t);return r=0===n.length?r:n},filter:function(t){if("number"==typeof t)return i[t];var a=e("<select>"),o=t.description||"",s=e("<option>").text(o);a.append(s);var l;for(l=0;l<t.options.length;l++)s=e("<option>").text(t.options[l].name),a.append(s);return a.on("change",function(){niclabs.insight.event.trigger("filter_changed",n())}),r.append(a),t.element=a,i.push(t),a}}}}(jQuery),niclabs.insight.InfoView=function(e){"use strict";var n=function(n,t){function r(e){return e="undefined"==typeof e?c++:e,"block"+e}function i(e){if("string"==typeof e)return u[e];if("number"==typeof e)return u[r(e)];var n,t;return"handler"in e?(t=e.id=e.id||r(),n=niclabs.insight.handler(e.handler)(d,e)):(n=e,t=n.id),u[t]=n,o.append(n.element),n}t=t||{};var a="#insight-info-view",o=e("<div>").setID(a).addClass("info");if("none"!==n.config("layout")){var s;"left"===n.config("layout")?s="e":"right"===n.config("layout")&&(s="w"),o.resizable(s)}var l,c=0,u={};if(t.blocks)for(l=0;l<t.blocks.length;l++)i(t.blocks[l]);o.on("resize",function(){for(var e in u)u[e].refresh()}),niclabs.insight.event.on("remove-block",function(e){delete u[e.id]});var d={get element(){var n=e(a);return o=0===n.length?o:n,o[0]},$:function(){var n=e(a);return o=0===n.length?o:n},block:i};return d};return niclabs.insight.handler("basic-info-view","info-view",n),n}(jQuery),niclabs.insight.MapView=function(e){"use strict";return function(n){var t="#insight-map-view",r={lat:n.lat||0,lng:n.lng||0},i=n.zoom||12,a=e("<div>").setID(t).addClass("map");return{get element(){var n=e(t);return a=0===n.length?a:n,a[0]},$:function(){var n=e(t);return a=0===n.length?a:n},center:function(e,n){return r.lat=e="undefined"==typeof e?r.lat:e,r.lng=n="undefined"==typeof n?r.lng:n,r},lat:function(){return r.lat},lng:function(){return r.lng},zoom:function(e){return i=e="undefined"==typeof e?i:e}}}}(jQuery),niclabs.insight.info=function(){var e=function(e){var n=niclabs.insight.dashboard();if("undefined"==typeof n)throw new Error("Dashboard has not been initialized");return n.info(e)};return e}(),niclabs.insight.info.Block=function(e){"use strict";var n=function(n,t){function r(){niclabs.insight.event.trigger("remove-block",{id:i})}if(!("id"in t))throw new Error("All information blocks must have an id");var i=t.id,a="#"===i.charAt(0)?i:"#"+i,o=t.title||"",s=t.properties||{},l=t.preprocess||function(e){return e},c=e("<div>").addClass("header").append(e("<span>").append(o)),u=e("<div>").setID(a).addClass("block").append(c);(void 0===s.closable||s.closable)&&u.closable(function(){r()}),(void 0===s.movable||s.movable)&&u.movable(),u.css(s);var d=t.data||{},f={get id(){return i},get element(){var n=e(a);return u=0===n.length?u:n,u[0]},get $(){var n=e(a);return u=0===n.length?u:n},remove:r,data:function(e){return e="undefined"==typeof e?d:e,d=0===Object.keys(e).length?{}:l(e)},refresh:function(){var e=f.$.find(".latlngView").empty();f.$.find(".deflist").remove();var n=f.data(),t=n.lat,r=n.lng;t&&r&&e.text("lat: "+t+", lng: "+r).insertAfter(f.$.find("hr"))}};return f};return n}(jQuery),niclabs.insight.info.SummaryBlock=function(e){var n=function(n,t){var r=niclabs.insight.info.Block(n,t),i=["lat","lng","value"];i=i.concat(t.ignore||[]),r.$.addClass("summary-viz"),r.$.append(e("<h6>").addClass("latlngView")),r.$.append(e("<dl>").addClass("deflist"));var a=r.refresh;return r.refresh=function(){a(),r.$.append(e("<dl>").addClass("deflist")),r.summary(r.data())},r.summary=function(n){e.each(n,function(n,t){i.indexOf(n)<0&&r.$.find(".deflist").append(e("<dt>").text(n).addClass("deflist-key")).append(e("<dd>").text(t).addClass("deflist-value"))})},t.data&&r.summary(t.data),niclabs.insight.event.on("map_element_selected",function(e){r.data(e),r.refresh()}),r};return niclabs.insight.handler("summary-block","info-block",n),n}(jQuery),niclabs.insight.event=function(){"use strict";function e(e,t){if(e in n)for(var r=0;r<n[e].length;r++)if(n[e][r]===t)return r;return-1}var n={};return{on:function(t,r){var i=e(t,r);return 0>i?("event"in n||(n[t]=[]),n[t].push(r)-1):i},off:function(t,r){var i="number"==typeof r?r:e(t,r);return i>=0?(n[t].splice(i,1),!0):!1},trigger:function(e,t){if(e in n)for(var r=0;r<n[e].length;r++)n[e][r](t)}}}(),niclabs.insight.layer=function(){var e=function(e,n){var t=niclabs.insight.dashboard();if("undefined"==typeof t)throw new Error("Dashboard has not been initialized");return t.layer(e,n)};return e}(),niclabs.insight.layer.Layer=function(e){"use strict";var n=function(n,t){if(!("id"in t))throw Error("All layers must have an id.");var r=t.id;if(!("data"in t))throw Error("All layers must provide a data source.");var i=!1,a=[];"string"==typeof t.data?i=t.data:a=t.data&&Array.isArray(t.data)?t.data:[t.data];var o=!1,s={get id(){return r},data:function(e){return"undefined"==typeof e?o||!i?a:i:"string"==typeof e?(i=e,o&&s.load(),i):a=e.length?e:[e]},load:function(){function n(e){a=e,niclabs.insight.event.trigger("layer_data",{id:r,data:a}),s.clear(),s.draw(a)}i?e.getJSON(i,n):n(a)},draw:function(){},filter:function(){},clear:function(){}};return s};return n}(jQuery),niclabs.insight.layer.MarkerLayer=function(e){var n=function(n,t){function r(t,r,a){var o;if("type"in a){var s={layer:i.id};e.extend(s,a,t[r]),o=niclabs.insight.handler(a.type)(n,s)}else o=a;return o.clickable(!0),o}var i=niclabs.insight.layer.Layer(n,t),a=t.marker||{type:"simple-marker"},o=[];return i.draw=function(e){for(var n=0;n<e.length;n++)o.push(r(e,n,a))},i.clear=function(){for(var e=0;e<o.length;e++)o[e].clear()},i.filter=function(e){for(var n=i.data(),t=0;t<o.length;t++)o[t].visible(e(n[t]))},i};return niclabs.insight.handler("marker-layer","layer",n),n}(jQuery),niclabs.insight.map=function(){var e=function(e){var n=niclabs.insight.dashboard();if("undefined"==typeof n)throw new Error("Dashboard has not been initialized");return n.map(e)};return e}(),niclabs.insight.map.GoogleMap=function(){"use strict";var e=function(e,n){var t=niclabs.insight.MapView(n),r=new google.maps.Map(t.element,{zoom:t.zoom(),center:new google.maps.LatLng(t.lat(),t.lng()),disableDefaultUI:!0}),i=t.zoom;google.maps.event.addListener(r,"zoom_changed",function(){i(r.getZoom())}),t.zoom=function(e){return e=i(e),r.setZoom(e),e};var a=t.center;return google.maps.event.addListener(r,"center_changed",function(){var e=r.getCenter();a(e.lat(),e.lng())}),t.center=function(e,n){var t=a(e,n);return r.setCenter({lat:t.lat,lng:t.lng}),t},t.googlemap=function(){return r},t};return niclabs.insight.handler("google-map","map-view",e),e}(jQuery),niclabs.insight.map.marker={},niclabs.insight.map.marker.CircleMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),i=new google.maps.Circle({center:r,map:t.map.googlemap(),radius:n.radius||400,strokeColor:n.strokeColor||"#FF0000",strokeOpacity:n.strokeOpacity||.8,strokeWeight:n.strokeWeight||2,fillColor:n.fillColor||"#FF0000",fillOpacity:n.fillOpacity||.35,title:n.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("circle-marker","marker",e),e}(jQuery),niclabs.insight.map.marker.ImageMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),i={url:n.src||"img/not-found.svg",scaledSize:new google.maps.Size(30,50)},a=new google.maps.Marker({position:r,map:t.map.googlemap(),icon:i,title:n.landmark||""});return t.marker=function(){return a},t};return niclabs.insight.handler("image-marker","marker",e),e}(jQuery),niclabs.insight.map.marker.Marker=function(){var e=function(e,n){if(!("layer"in n))throw new Error("The marker must be associated to a layer");var t;if(!(t=e.layer(n.layer)))throw new Error("The layer "+t+" does not exist in the dashboard");var r;if(!(r=e.map()))throw new Error("No map has been initialized for the dashboard yet");if(!("googlemap"in r))throw new Error("Markers are only supported for Google Maps at the moment");var i,a={get map(){return r},get layer(){return t},marker:function(){return void 0},clickable:function(e){if(e){var t=a.marker();i=google.maps.event.addListener(t,"click",function(){niclabs.insight.event.trigger("map_element_selected",n),"setAnimation"in t&&t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)},3e3)})}else"undefined"!=typeof i&&(google.maps.event.removeListener(i),i=void 0);return void 0!==i},clear:function(){var e=a.marker();e.setMap(null)},visible:function(e){return"undefined"==typeof e?a.marker().getVisible():(a.marker().setVisible(e),e)}};return a};return e}(jQuery),niclabs.insight.map.marker.SimpleMarker=function(){var e=function(e,n){var t=niclabs.insight.map.marker.Marker(e,n),r=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),i=new google.maps.Marker({position:r,map:t.map.googlemap(),title:n.landmark||""});return t.marker=function(){return i},t};return niclabs.insight.handler("simple-marker","marker",e),e}(jQuery);