function MarkerSelector(t,a,e,r){return"circle"===a.type?new CityDashboard.CircleMarker(t,a,e,r):"image"===a.type?new CityDashboard.ImageMarker(t,a,e,r):"polyline"===a.type?new CityDashboard.PolylineMarker(t,a,e,r):"simple"===a.type?new CityDashboard.SimpleMarker(t,a,e,r):void 0}function isPointInPoly(t,a){for(var e=!1,r=-1,i=t.length,o=i-1;++r<i;o=r)(t[r].y<=a.y&&a.y<t[o].y||t[o].y<=a.y&&a.y<t[r].y)&&a.x<(t[o].x-t[r].x)*(a.y-t[r].y)/(t[o].y-t[r].y)+t[r].x&&(e=!e);return e}function GridSelector(t,a,e,r){return"square"===a.type?new CityDashboard.SquareGrid(t,a,e,r):"hexagonal"===a.type?new CityDashboard.HexagonalGrid(t,a,e,r):void 0}function HeatmapSelector(t,a,e,r){return"point-heatmap"===a.type?new CityDashboard.PointHeatmap(t,a,e,r):"segment-heatmap"===a.type?new CityDashboard.SegmentHeatmap(t,a,e,r):void 0}function DTesselationSelector(t,a,e,r){return"delaunay"===a.type?new CityDashboard.Delaunay(t,a,e,r):"voronoi"===a.type?new CityDashboard.Voronoi(t,a,e,r):void 0}function LayerSelector(t,a){return"grid-layer"===t.layer?new CityDashboard.GridLayer(t,a):"marker-layer"===t.layer?new CityDashboard.MarkerLayer(t,a):"heatmap-layer"===t.layer?new CityDashboard.HeatmapLayer(t,a):"delaunay-layer"===t.layer?new CityDashboard.DelaunayLayer(t,a):void 0}!function(t){t.fn.resizable=function(a){function e(a){s=a.clientX,n=a.clientY,l=u.outerWidth(),h=u.outerHeight(),t(document).on("mousemove",r),t(document).on("mouseup",i)}function r(t){d&&u.css("height",h+t.clientY-n+"px"),p&&u.css("width",l+t.clientX-s+"px"),c&&u.css("top",t.clientY+"px").css("height",h+n-t.clientY+"px"),y&&u.css("left",t.clientX+"px").css("width",l-t.clientX+"px")}function i(){t(document).off("mousemove",r),t(document).off("mouseup",i),u.trigger("resize")}var o=t("<div>").addClass("resizer").addClass(a+"-resize");this.append(o).addClass("resizable"),o.on("mousedown",e);var s,n,l,h,p,d,c,y,u=this;return d=a.search("s")>=0,p=a.search("e")>=0,c=a.search("n")>=0,y=a.search("w")>=0,this.scroll(function(){o.css("top",u.scrollTop())}),this},t.fn.setID=function(t){return"#"===t.charAt(0)&&(t=t.slice(1)),this.attr("id",t),this},t.fn.movable=function(){var a=this.children(".options-panel");a.length||(a=t("<span>").addClass("options-panel"),this.prepend(a));var e=t("<span>").addClass("up-button").append("&#x25B2;"),r=t("<span>").addClass("down-button").append("&#x25BC;");a.prepend(r),a.prepend(e);var i=this;return e.on("click",function(){i.insertBefore(i.prev())}),r.on("click",function(){i.insertAfter(i.next())}),this},t.fn.closable=function(a){a||(a=function(){});var e=this.children(".options-panel");e.length||(e=t("<span>").addClass("options-panel"),this.prepend(e));var r=t("<span>").addClass("close-button").text("X");e.append(r);var i=this;return r.on("click",function(){i.remove(),a()}),this}}(jQuery);var CityDashboard={mainContainerID:"#city-dashboard",mapWindowID:"#mapWindow",infoWindowID:"#infoWindow",filterBarID:"#filterBar",getData:function(t,a,e){return"#"===t.charAt(0)?a(e):void $.getJSON(t,function(t){return e.data=t,a(e)})}};CityDashboard.GoogleMap=function(t){this.center={lat:t.lat||0,lng:t.lng||0},this.zoom=t.zoom||12;var a=$(CityDashboard.mapWindowID)[0];this.googlemap=new google.maps.Map(a,{zoom:this.zoom,center:new google.maps.LatLng(this.center.lat,this.center.lng),disableDefaultUI:!0}),$(CityDashboard.mainContainerID)[0].data=this.googlemap},CityDashboard.GoogleMap.prototype={constructor:CityDashboard.Map},CityDashboard.Marker=function(t,a,e,r){this.layer_params=t,this.attr=a,this.map=e,this.marker=void 0,this.layer=r},CityDashboard.Marker.prototype={constructor:CityDashboard.Marker,addEvents:function(){function t(){$("#infoWindow").trigger("marker-pressed",{id:a.layer.id,value:a.layer_params,attr:a.attr});for(var t=0;t<a.layer.markers.length;t++){var e=a.layer.markers[t].marker;e.setAnimation(e==this?google.maps.Animation.BOUNCE:null)}}google.maps.event.addListener(this.marker,"click",t);var a=this},triggerInitialEvent:function(){}},CityDashboard.CircleMarker=function(t,a,e,r){CityDashboard.Marker.call(this,t,a,e,r);var i=new google.maps.LatLng(parseFloat(t.lat),parseFloat(t.lng)),o=new google.maps.Circle({center:i,map:e,radius:a.radius||400,strokeColor:a.strokeColor||"#FF0000",strokeOpacity:a.strokeOpacity||.8,strokeWeight:a.strokeWeight||2,fillColor:a.fillColor||"#FF0000",fillOpacity:a.fillOpacity||.35,title:t.landmark||""});this.marker=o},CityDashboard.CircleMarker.prototype=Object.create(CityDashboard.Marker.prototype),CityDashboard.CircleMarker.prototype={constructor:CityDashboard.CircleMarker,addEvents:function(){function t(){$("#infoWindow").trigger("marker-pressed",{id:a.layer.id,value:a.layer_params,attr:a.attr})}google.maps.event.addListener(this.marker,"click",t);var a=this},triggerInitialEvent:function(){$("#infoWindow").trigger("marker-pressed",{id:this.layer.id,value:this.layer_params,attr:this.attr})}},CityDashboard.ImageMarker=function(t,a,e,r){CityDashboard.Marker.call(this,t,a,e,r);var i=new google.maps.LatLng(parseFloat(t.lat),parseFloat(t.lng)),o={url:a.src||"../src/Layers/Markers/not_found.svg",scaledSize:new google.maps.Size(30,50)},s=new google.maps.Marker({position:i,map:e,icon:o,title:t.landmark||""});this.marker=s},CityDashboard.ImageMarker.prototype=Object.create(CityDashboard.Marker.prototype),CityDashboard.ImageMarker.prototype={constructor:CityDashboard.ImageMarker,addEvents:function(){function t(){$("#infoWindow").trigger("marker-pressed",{id:a.layer.id,value:a.layer_params,attr:a.attr});for(var t=0;t<a.layer.markers.length;t++){var e=a.layer.markers[t].marker;e.setAnimation(e==this?google.maps.Animation.BOUNCE:null)}}google.maps.event.addListener(this.marker,"click",t);var a=this},triggerInitialEvent:function(){for($("#infoWindow").trigger("marker-pressed",{id:this.layer.id,value:this.layer_params,attr:this.attr}),i=0;i<this.layer.markers.length;i++)this.layer.markers[i].marker.setAnimation(null);this.marker.setAnimation(google.maps.Animation.BOUNCE)}},CityDashboard.SimpleMarker=function(t,a,e,r){CityDashboard.Marker.call(this,t,a,e,r);var i=new google.maps.LatLng(parseFloat(t.lat),parseFloat(t.lng)),o=new google.maps.Marker({position:i,map:e,title:t.landmark||""});this.marker=o},CityDashboard.SimpleMarker.prototype=Object.create(CityDashboard.Marker.prototype),CityDashboard.SimpleMarker.prototype={constructor:CityDashboard.SimpleMarker,addEvents:function(){function t(){$("#infoWindow").trigger("marker-pressed",{id:a.layer.id,value:a.layer_params,attr:a.attr});for(var t=0;t<a.layer.markers.length;t++){var e=a.layer.markers[t].marker;e.setAnimation(e==this?google.maps.Animation.BOUNCE:null)}}google.maps.event.addListener(this.marker,"click",t);var a=this},triggerInitialEvent:function(){for($("#infoWindow").trigger("marker-pressed",{id:this.layer.id,value:this.layer_params,attr:this.attr}),i=0;i<this.layer.markers.length;i++)this.layer.markers[i].marker.setAnimation(null);this.marker.setAnimation(google.maps.Animation.BOUNCE)}},CityDashboard.PolylineMarker=function(t,a,e,r){CityDashboard.Marker.call(this,t,a,e,r);for(var i=[],o=t.points.length,s=0;o>s;s++)i[s]=new google.maps.LatLng(parseFloat(t.points[s].lat),parseFloat(t.points[s].lng));var n=new google.maps.Polyline({path:i,strokeColor:a.strokeColor||"#000000",strokeOpacity:a.strokeOpacity||1,strokeWeight:a.strokeWeight||2});n.setMap(e)},CityDashboard.PolylineMarker.prototype=Object.create(CityDashboard.Marker.prototype),CityDashboard.PolylineMarker.prototype={constructor:CityDashboard.PolylineMarker,addEvents:function(){},triggerInitialEvent:function(){}},CityDashboard.Grid=function(t,a,e,r){this.layer_params=t,this.attr=a,this.map=e,this.layer=r,this.tiles=[]},CityDashboard.Grid.prototype={constructor:CityDashboard.Grid,build:function(){},addEvents:function(){}},CityDashboard.HexagonalGrid=function(t,a,e,r){CityDashboard.Grid.call(this,t,a,e,r)},CityDashboard.HexagonalGrid.prototype=Object.create(CityDashboard.Grid.prototype),CityDashboard.HexagonalGrid.prototype={constructor:CityDashboard.HexagonalGrid,build:function(t){l=this.attr.size||.02;for(var a=this.tiles.length,e=0;a>e;e++)this.tiles[e].setMap(null);this.tiles=[];for(var r=this.map.getZoom(),i=l*Math.pow(2,12),o=[],e=0;22>e;e++)o.push(i),i/=2;for(var s=["transparent","blue","cyan","green","yellow","red"],n=o[r],h=t.getNorthEast(),p=t.getSouthWest(),d=Math.ceil(.75*Math.abs(p.lat()-h.lat())/n),c=Math.ceil(5/8*Math.abs(p.lng()-h.lng())/n),y=n*Math.sin(Math.PI/6),u=n*Math.cos(Math.PI/6),e=0;d>e;e++)for(var g=0;c>g;g++){var f,m=h.lat()-(n+y)*e;f=e%2==0?h.lng()-2*u*g+u:h.lng()-2*u*g,poly=[{x:m,y:f},{x:m-n,y:f},{x:m-n-y,y:f-u},{x:m-n,y:f-2*u},{x:m,y:f-2*u},{x:m+y,y:f-u},{x:m,y:f}];var v=[new google.maps.LatLng(poly[0].x,poly[0].y),new google.maps.LatLng(poly[1].x,poly[1].y),new google.maps.LatLng(poly[2].x,poly[2].y),new google.maps.LatLng(poly[3].x,poly[3].y),new google.maps.LatLng(poly[4].x,poly[4].y),new google.maps.LatLng(poly[5].x,poly[5].y),new google.maps.LatLng(poly[6].x,poly[6].y)];pointsInScreen=[],weightsInScreen=[];for(var b=0;b<this.layer_params.points.length;b++)t.contains(new google.maps.LatLng(this.layer_params.points[b].lat,this.layer_params.points[b].lng))&&(pointsInScreen.push(this.layer_params.points[b]),weightsInScreen.push(this.layer_params.weights[b]));for(var C=0,D=(1/weightsInScreen.length,0),b=0;b<weightsInScreen.length;b++)D+=weightsInScreen[b];for(var b=0;b<weightsInScreen.length;b++)weightsInScreen[b]=weightsInScreen[b]/D;for(var b=0;b<pointsInScreen.length;b++)isPointInPoly(poly,{x:pointsInScreen[b].lat,y:pointsInScreen[b].lng})&&(C+=weightsInScreen[b]);var k=new google.maps.Polygon({paths:v,strokeColor:this.attr.color||"#000000",strokeOpacity:.5,strokeWeight:2,fillColor:s[Math.floor(C*s.length+.5)]||"#000000",fillOpacity:.2,geodesic:!0});k.setMap(this.map),this.tiles.push(k)}},addEvents:function(){var t=this;google.maps.event.addListener(this.map,"bounds_changed",function(){window.setTimeout(t.build(this.getBounds()),50)})}},CityDashboard.SquareGrid=function(t,a,e,r){CityDashboard.Grid.call(this,t,a,e,r)},CityDashboard.SquareGrid.prototype=Object.create(CityDashboard.Grid.prototype),CityDashboard.SquareGrid.prototype={constructor:CityDashboard.SquareGrid,build:function(t){for(var a=this.attr.size||.03,e=this.tiles.length,r=0;e>r;r++)this.tiles[r].setMap(null);this.tiles=[];for(var i=this.map.getZoom(),o=a*Math.pow(2,12),s=[],r=0;22>r;r++)s.push(o),o/=2;for(var n=s[i],l=t.getNorthEast()||0,h=t.getSouthWest()||0,p=Math.ceil(Math.abs(h.lat()-l.lat())/n),d=Math.ceil(Math.abs(h.lng()-l.lng())/n),r=0;p>r;r++)for(var c=0;d>c;c++){var y=l.lat()-n*r,u=l.lng()-n*c,g=[new google.maps.LatLng(y,u),new google.maps.LatLng(y-n,u),new google.maps.LatLng(y-n,u-n),new google.maps.LatLng(y,u-n),new google.maps.LatLng(y,u)],f=new google.maps.Polygon({paths:g,strokeColor:this.attr.color||"#578b8b",strokeOpacity:.5,strokeWeight:2,fillColor:this.attr.color||"#578b8b",fillOpacity:0,geodesic:!0});f.setMap(this.map),this.tiles.push(f)}},addEvents:function(){var t=this;google.maps.event.addListener(this.map,"bounds_changed",function(){window.setTimeout(t.build(this.getBounds()),50)})}},CityDashboard.Heatmap=function(){},CityDashboard.Heatmap.prototype={constructor:CityDashboard.Heatmap},CityDashboard.PointHeatmap=function(t,a,e){var r,i=[],o=t.points.length;if(t.weights&&t.weights.length>=o)for(r=0;o>r;r++)i[r]={location:new google.maps.LatLng(parseFloat(t.points[r].lat),parseFloat(t.points[r].lng)),weight:t.weights[r]};else for(r=0;o>r;r++)i[r]=new google.maps.LatLng(parseFloat(t.points[r].lat),parseFloat(t.points[r].lng));var s=new google.maps.MVCArray(i);this.heatmap=new google.maps.visualization.HeatmapLayer({data:s,radius:a.radius||10}),this.heatmap.setMap(e)},CityDashboard.PointHeatmap.prototype=Object.create(CityDashboard.Heatmap.prototype),CityDashboard.PointHeatmap.prototype={constructor:CityDashboard.PointHeatmap},CityDashboard.SegmentHeatmap=function(t,a,e){var r,i,o=[],s=t.segments.length;for(r=0;s>r;r++)for(o[r]=[],i=0;i<t.segments[r].length;i++)o[r][i]={lat:parseFloat(t.segments[r][i].lat),lng:parseFloat(t.segments[r][i].lng)};var n=[];for(r=0;r<o.length;r++){var l=o[r].length;for(i=0;l-1>i;i++)for(var h=Math.sqrt(Math.pow(o[r][i+1].lat-o[r][i].lat,2)+Math.pow(o[r][i+1].lng-o[r][i].lng,2)),p=Math.floor(h/1e-5),d={lat:(o[r][i+1].lat-o[r][i].lat)/p,lng:(o[r][i+1].lng-o[r][i].lng)/p},c=0;p>c;c++){var y=o[r][i].lat,u=o[r][i].lng;n.push({location:new google.maps.LatLng(y+d.lat*c,u+d.lng*c),weight:t.weights[r]||1})}}this.heatmap=new google.maps.visualization.HeatmapLayer({data:n}),this.heatmap.setMap(e)},CityDashboard.SegmentHeatmap.prototype=Object.create(CityDashboard.Heatmap.prototype),CityDashboard.SegmentHeatmap.prototype={constructor:CityDashboard.SegmentHeatmap},CityDashboard.DTesselation=function(t,a,e,r){this.layer_params=t,this.attr=a,this.map=e,this.layer=r},CityDashboard.DTesselation.prototype={constructor:CityDashboard.DTesselation,build:function(){},addEvents:function(){},Add_GMapLine:function(t,a,e,r,i,o,s){var n=180/Math.PI;if(!(e.length<2)){for(var l=a[e[0]],h=[l],p=1;p<e.length;p++){var d=a[e[p]];h=h.concat(this.SplitSegment(l,d),[d]),l=d}for(var c=[],y=0;y<h.length;y++){var d=h[y],u=n*Math.atan2(d[2],Math.sqrt(d[0]*d[0]+d[1]*d[1])),g=n*Math.atan2(d[1],d[0]);c.push(new google.maps.LatLng(u,g))}var f=new google.maps.Polyline({path:c,strokeColor:r,strokeWeight:i,strokeOpacity:o,clickable:!1});f.setMap(s),t.push(f)}},SplitSegment:function(t,a){for(var e=0,r=0;3>r;r++){var i=a[r]-t[r];e+=i*i}var o=[];if(.01>e)return o;for(var s=new Array(3),r=0;3>r;r++)s[r]=t[r]+a[r];for(var n=0,r=0;3>r;r++)pc=s[r],n+=pc*pc;for(var l=1/Math.sqrt(n),r=0;3>r;r++)s[r]*=l;return o.concat(this.SplitSegment(t,s),[s],this.SplitSegment(s,a))},ClearOvlyArray:function(t){for(;t.length>0;){var a=t.pop();a.setMap(null)}}},CityDashboard.Voronoi=function(t,a,e,r){CityDashboard.DTesselation.call(this,t,a,e,r);for(var i=[],o=Math.PI/180,s=(180/Math.PI,[]),n=t.points.length,l=0;n>l;l++)i[l]=new google.maps.LatLng(parseFloat(t.points[l].lat),parseFloat(t.points[l].lng));var h=this,p=function(){h.ClearOvlyArray(s);for(var t=[],r=0;r<i.length;r++){for(var n=i[r],l=o*n.lat(),p=o*n.lng(),d=Math.cos(l),c=[d*Math.cos(p),d*Math.sin(p),Math.sin(l)],y=0;3>y;y++)c[y]+=1e-10*(2*Math.random()-1);for(var u=0,y=0;3>y;y++)u+=c[y]*c[y];for(var g=1/Math.sqrt(u),y=0;3>y;y++)c[y]*=g;t.push(c)}for(var f=FindDelaunayTriangulation(t),r=0;r<f.vor_edges.length;r++){var m=f.vor_edges[r];m[0]<0||m[1]<0||h.Add_GMapLine(s,f.vor_positions,m,a.color||"#578b8b",2,1,e)}};p(),markers=[];for(var l=0;l<i.length;l++){var d=new google.maps.Marker({position:i[l],map:e,draggable:!0});markers[l]=d}for(var c=function(){for(var t=0;t<i.length;t++)if(markers[t].position!=i[t]){i[t]=this.position;break}p()},l=0;l<i.length;l++)google.maps.event.addListener(markers[l],"drag",c)},CityDashboard.Voronoi.prototype=Object.create(CityDashboard.DTesselation.prototype),CityDashboard.Voronoi.prototype={constructor:CityDashboard.Voronoi,build:function(){},addEvents:function(){},Add_GMapLine:function(t,a,e,r,i,o,s){var n=180/Math.PI;if(!(e.length<2)){for(var l=a[e[0]],h=[l],p=1;p<e.length;p++){var d=a[e[p]];h=h.concat(this.SplitSegment(l,d),[d]),l=d}for(var c=[],y=0;y<h.length;y++){var d=h[y],u=n*Math.atan2(d[2],Math.sqrt(d[0]*d[0]+d[1]*d[1])),g=n*Math.atan2(d[1],d[0]);c.push(new google.maps.LatLng(u,g))}var f=new google.maps.Polyline({path:c,strokeColor:r,strokeWeight:i,strokeOpacity:o,clickable:!1});f.setMap(s),t.push(f)}},SplitSegment:function(t,a){for(var e=0,r=0;3>r;r++){var i=a[r]-t[r];e+=i*i}var o=[];if(.01>e)return o;for(var s=new Array(3),r=0;3>r;r++)s[r]=t[r]+a[r];for(var n=0,r=0;3>r;r++)pc=s[r],n+=pc*pc;for(var l=1/Math.sqrt(n),r=0;3>r;r++)s[r]*=l;return o.concat(this.SplitSegment(t,s),[s],this.SplitSegment(s,a))},ClearOvlyArray:function(t){for(;t.length>0;){var a=t.pop();a.setMap(null)}}},CityDashboard.Delaunay=function(t,a,e,r){CityDashboard.DTesselation.call(this,t,a,e,r);for(var i=[],o=Math.PI/180,s=(180/Math.PI,[]),n=t.points.length,l=0;n>l;l++)i[l]=new google.maps.LatLng(parseFloat(t.points[l].lat),parseFloat(t.points[l].lng));var h=this,p=function(){h.ClearOvlyArray(s);for(var t=[],r=0;r<i.length;r++){for(var n=i[r],l=o*n.lat(),p=o*n.lng(),d=Math.cos(l),c=[d*Math.cos(p),d*Math.sin(p),Math.sin(l)],y=0;3>y;y++)c[y]+=1e-10*(2*Math.random()-1);for(var u=0,y=0;3>y;y++)u+=c[y]*c[y];for(var g=1/Math.sqrt(u),y=0;3>y;y++)c[y]*=g;t.push(c)}for(var f=FindDelaunayTriangulation(t),r=0;r<f.edges.length;r++){var m=f.edges[r];h.Add_GMapLine(s,f.positions,m.verts,a.color||"#578b8b",2,1,e)}};p(),markers=[];for(var l=0;l<i.length;l++){var d=new google.maps.Marker({position:i[l],map:e,draggable:!0});markers[l]=d}for(var c=function(){for(var t=0;t<i.length;t++)if(markers[t].position!=i[t]){i[t]=this.position;break}p()},l=0;l<i.length;l++)google.maps.event.addListener(markers[l],"drag",c)},CityDashboard.Delaunay.prototype=Object.create(CityDashboard.DTesselation.prototype),CityDashboard.Delaunay.prototype={constructor:CityDashboard.Delaunay,build:function(){},addEvents:function(){},Add_GMapLine:function(t,a,e,r,i,o,s){var n=180/Math.PI;if(!(e.length<2)){for(var l=a[e[0]],h=[l],p=1;p<e.length;p++){var d=a[e[p]];h=h.concat(this.SplitSegment(l,d),[d]),l=d}for(var c=[],y=0;y<h.length;y++){var d=h[y],u=n*Math.atan2(d[2],Math.sqrt(d[0]*d[0]+d[1]*d[1])),g=n*Math.atan2(d[1],d[0]);c.push(new google.maps.LatLng(u,g))}var f=new google.maps.Polyline({path:c,strokeColor:r,strokeWeight:i,strokeOpacity:o,clickable:!1});f.setMap(s),t.push(f)}},SplitSegment:function(t,a){for(var e=0,r=0;3>r;r++){var i=a[r]-t[r];e+=i*i}var o=[];if(.01>e)return o;for(var s=new Array(3),r=0;3>r;r++)s[r]=t[r]+a[r];for(var n=0,r=0;3>r;r++)pc=s[r],n+=pc*pc;for(var l=1/Math.sqrt(n),r=0;3>r;r++)s[r]*=l;return o.concat(this.SplitSegment(t,s),[s],this.SplitSegment(s,a))},ClearOvlyArray:function(t){for(;t.length>0;){var a=t.pop();a.setMap(null)}}},CityDashboard.Layer=function(t,a){if(this.wrappedLayer=void 0,void 0===t.id)throw Error("All layers must have an ID.");this.id=t.id,this.dataSource=t.dataSource,this.elements=t.data.length?t.data:[t.data],this.elementsAttr=t.layer_attr||{type:"simple",action:"update"},this.map=a},CityDashboard.Layer.prototype={constructor:CityDashboard.Layer,filter:function(){},clear:function(){}},CityDashboard.MarkerLayer=function(t,a){CityDashboard.Layer.call(this,t,a),this.markers=[];for(var e=this.elements.length-1;e>=0;e--){var r=MarkerSelector(this.elements[e],this.elementsAttr,this.map,this);this.markers.push(r),r.addEvents()}this.markers[0].triggerInitialEvent()},CityDashboard.MarkerLayer.prototype=Object.create(CityDashboard.Layer.prototype),CityDashboard.MarkerLayer.prototype={constructor:CityDashboard.MarkerLayer,filter:function(t){for(i=0;i<this.markers.length;i++)this.markers[i].marker.setVisible(t(this.markers[i].layer_params)?!0:!1);for(i=0;i<this.markers.length;i++)if(this.markers[i].marker.getVisible()){this.markers[i].triggerInitialEvent();break}},clear:function(){for(var t=0;t<this.markers.length;t++)this.markers[t].marker.setMap(null)}},CityDashboard.GridLayer=function(t,a){CityDashboard.Layer.call(this,t,a),this.grid=GridSelector(this.elements[0],this.elementsAttr,this.map,this),this.grid.addEvents()},CityDashboard.GridLayer.prototype=Object.create(CityDashboard.Layer.prototype),CityDashboard.GridLayer.prototype={constructor:CityDashboard.GridLayer,clear:function(){for(var t=0;t<this.grid.tiles.length;t++)this.grid.tiles[t].setMap(null)}},CityDashboard.HeatmapLayer=function(t,a){CityDashboard.Layer.call(this,t,a),this.heatmap=new HeatmapSelector(this.elements[0],this.elementsAttr,this.map,this)},CityDashboard.HeatmapLayer.prototype=Object.create(CityDashboard.Layer.prototype),CityDashboard.HeatmapLayer.prototype={constructor:CityDashboard.HeatmapLayer,clear:function(){this.heatmap.heatmap.setMap(null)}},CityDashboard.DelaunayLayer=function(t,a){CityDashboard.Layer.call(this,t,a);var e=DTesselationSelector(this.elements[0],this.elementsAttr,this.map,this);e.addEvents()},CityDashboard.DelaunayLayer.prototype=Object.create(CityDashboard.Layer.prototype),CityDashboard.DelaunayLayer.prototype={constructor:CityDashboard.DelaunayLayer,clear:function(){}},CityDashboard.Visualization=function(t){var a;this.id=t.id,this.data_source=t["data-source"]||this.id,this.properties=t.properties||{},this.title=t.title||"",this.dataPreprocess=t.preprocess||function(t){return t},this.setData(t.data||{});var a=$("<h4>").append(this.title).addClass("viz-title"),e=this;this.viz=$("<div>").setID(this.id).addClass("visualization").append(a).append($("<hr>").addClass("viz-bar")),(void 0===this.properties.closable||this.properties.closable)&&this.viz.closable(function(){return e.remove()}),(void 0===this.properties.movable||this.properties.movable)&&this.viz.movable(),this.viz.append($("<h6>").addClass("latlngView")),$(CityDashboard.infoWindowID).append(this.viz),this.viz.css(this.properties),this.checkbox_handler=t["checkbox-handler"]||function(t,a){return a},t.checkbox&&this.addCheckbox(t.checkbox)},CityDashboard.Visualization.prototype={constructor:CityDashboard.Visualization,setData:function(t){t instanceof Array||(t=jQuery.extend({},t)),this.data=t&&0!==Object.keys(t).length?this.dataPreprocess(t):{}},getData:function(){return this.data},refresh:function(){var t=$(this.id).find(".latlngView").empty();this.viz.find(".deflist").remove();var a=this.getData(),e=a.lat,r=a.lng;e&&r&&t.text("lat: "+e+", lng: "+r).insertAfter($(this.id).find("hr"))},remove:function(){$(CityDashboard.infoWindowID).trigger("remove-viz",{id:this.id,"data-source":this.data_source})},createDefList:function(t){var a=this.id;$.each(t,function(t,e){"lat"!==t&&"lng"!==t&&"value"!==t&&$(a).find(".deflist").append($("<dt>").text(t).addClass("deflist-key")).append($("<dd>").text(e).addClass("deflist-value"))})},addCheckbox:function(t){var a=$("<span>").addClass("checkbox-panel"),e=[];for(var r in t){var i=$("<input>").attr("type","checkbox");e[e.length]=i[0].checked=t[r],a.append(i);var o=this;i.on("change",function(){var t=$(this).parent().children("input:checkbox").map(function(){return $(this).prop("checked")}).get();o.getData=function(){var a=o.data;return o.data instanceof Array||(a=jQuery.extend({},o.data)),o.checkbox_handler(t,a)},o.refresh()}),i.after($("<label>").text(r))}this.viz.append(a),o.getData=function(){var t=o.data;return o.data instanceof Array||(t=jQuery.extend({},o.data)),o.checkbox_handler(e,t)}}},CityDashboard.SummaryVisualization=function(t){CityDashboard.Visualization.call(this,t),this.viz.addClass("summary-viz"),this.refresh()},CityDashboard.SummaryVisualization.prototype=Object.create(CityDashboard.Visualization.prototype),CityDashboard.SummaryVisualization.prototype.refresh=function(){CityDashboard.Visualization.prototype.refresh.call(this),this.viz.append($("<dl>").addClass("deflist")),this.createDefList(this.data)},CityDashboard.GeneralVisualization=function(t){CityDashboard.Visualization.call(this,t),this.viz.addClass("general-viz"),this.dom=t.dom,this.refresh()},CityDashboard.GeneralVisualization.prototype=Object.create(CityDashboard.Visualization.prototype),CityDashboard.GeneralVisualization.prototype.refresh=function(){CityDashboard.Visualization.prototype.refresh.call(this),this.viz.append(this.dom)},CityDashboard.GeneralVisualization.prototype.remove=function(){CityDashboard.Visualization.prototype.remove.call(this)},CityDashboard.ChartistVisualization=function(t,a){CityDashboard.Visualization.call(this,t),this.chartConstructor=a,this.viz.addClass("chartist-viz").append($("<div>").addClass(this.properties["class"])),this.options=t.options||{},this.responsiveOptions=t.responsiveOptions||{},this.labels=t.labels,this.refresh()},CityDashboard.ChartistVisualization.prototype=Object.create(CityDashboard.Visualization.prototype),CityDashboard.ChartistVisualization.prototype.refresh=function(){CityDashboard.Visualization.prototype.refresh.call(this);var t=this.getData();t=t.value||t;var a={series:t,labels:"function"==typeof this.labels?this.labels(t):this.labels};this.chart&&this.chart.optionsProvider?this.chart.update(a):this.chart=new this.chartConstructor(this.id+" > div",a,this.options,this.responsiveOptions),this.viz.append($("<dl>").addClass("deflist")),this.data instanceof Array||this.createDefList(this.data)},CityDashboard.ChartistVisualization.prototype.remove=function(){CityDashboard.Visualization.prototype.remove.call(this),this.chart.detach()},CityDashboard.D3Visualization=function(t){CityDashboard.Visualization.call(this,t);var a=$("<div>");this.viz.addClass("d3-viz").append(a);var e=.61803398875,r=a.width(),i=e*r;this.svg=d3.select(this.id+" div").append("svg"),this._create=t["golden-ratio"]?function(){return arguments[1]=arguments[1].value||arguments[1],arguments[3]=a.width()*e,t.viz.apply(t,arguments)}:function(){return arguments[3]=i,arguments[1]=arguments[1].value||arguments[1],t.viz.apply(t,arguments)},CityDashboard.Visualization.prototype.refresh.call(this),this._create(this.svg,this.getData(),r,i)},CityDashboard.D3Visualization.prototype=Object.create(CityDashboard.Visualization.prototype),CityDashboard.D3Visualization.prototype.refresh=function(){CityDashboard.Visualization.prototype.refresh.call(this),this.svg.selectAll("*").remove();var t=this.getData(),a=$(this.id);this._create(this.svg,t,a.width(),a.height()),this.viz.append($("<dl>").addClass("deflist")),t instanceof Array||this.createDefList(t)},CityDashboard.D3Visualization.prototype.remove=function(){CityDashboard.Visualization.prototype.remove.call(this),this.svg.remove()},CityDashboard.FilterBar=function(t){this.filters={none:function(){return!0}},this.filterNumber=t,this.bar=$("<div>").setID(CityDashboard.filterBarID).addClass("filterBar");var a=new google.maps.Geocoder,e=function(){var t=$(CityDashboard.mainContainerID)[0].data,e=$(CityDashboard.filterBarID+" > .search").val();a.geocode({address:e},function(a,r){r==google.maps.GeocoderStatus.OK?(t.setCenter(a[0].geometry.location),t.fitBounds(a[0].geometry.bounds)):$(CityDashboard.filterBarID+" > .search").val("not found: "+e)})};$(CityDashboard.mainContainerID).append(this.bar),this.bar.append($("<input>").addClass("search").attr("type","search").attr("placeholder","Enter location").on("change",e));var r=this;this.select=[];for(var i=0;i<this.filterNumber;i++)this.select[i]=$("<select>").on("change",function(){$(CityDashboard.mainContainerID).trigger("filterChanged",function(){return r.composeFilters()})}),this.bar.append(this.select[i]);this.placeFilters()},CityDashboard.FilterBar.prototype={constructor:CityDashboard.FilterBar,addFilter:function(t){for(var a in t)this.filters[a]=t[a];for(var e=this.select.length-1;e>=0;e--)this.select[e].empty();this.placeFilters()},placeFilters:function(){for(var t=this,a=0;a<this.filterNumber;a++)for(var e in this.filters){var r=$("<option>");r.val(function(){return t.filters[e]}),r.text(e),this.select[a].append(r)}},composeFilters:function(){for(var t=[],a=this.select.length-1;a>=0;a--)t[t.length]=Function("return "+this.select[a].val())();return function(a){for(var e=t.length-1;e>=0;e--)if(!t[e](a))return!1;return!0}}},CityDashboard.InfoWindow=function(t){t=t||[],this.visualizations={},this.dataSourceTable={};for(var a=0;a<t.length;a++)this.createVisualization(t[a]);var e=$(CityDashboard.infoWindowID),r=this,i=function(t,a){if(e.off("marker-pressed"),a.attr.id&&!(a.attr.id in r.visualizations)){var o=jQuery.extend({},a.attr);o.data=a.value,o["data-source"]=a.id,r.createVisualization(o)}for(var s=r.dataSourceTable[a.id]||[],n=s.length-1;n>=0;n--)s[n].setData(a.value),s[n].refresh();e.on("marker-pressed",i)};e.on("marker-pressed",i),e.on("resize",function(){for(var t in r.visualizations)r.visualizations[t].refresh()}),e.on("remove-viz",function(t,a){delete r.visualizations[a.id];var e=jQuery.inArray(r.dataSourceTable[a["data-source"]],a.id);r.dataSourceTable[a["data-source"]].splice(e,1)})},CityDashboard.InfoWindow.prototype={constructor:CityDashboard.InfoWindow,createVisualization:function(t){var a=this,e=t.visualization,r=function(t){var r;if(e)return"summary-viz"===e?r=new CityDashboard.SummaryVisualization(t):"linechart-viz"===e?r=new CityDashboard.ChartistVisualization(t,Chartist.Line):"barchart-viz"===e?r=new CityDashboard.ChartistVisualization(t,Chartist.Bar):"piechart-viz"===e?r=new CityDashboard.ChartistVisualization(t,Chartist.Pie):"d3-viz"===e?r=new CityDashboard.D3Visualization(t):"general-viz"===e&&(r=new CityDashboard.GeneralVisualization(t)),a.visualizations[r.id]=r,a.dataSourceTable[r.data_source]=a.dataSourceTable[r.data_source]||[],a.dataSourceTable[r.data_source].push(r),r};return CityDashboard.getData(t["data-source"],r,t)}},CityDashboard.Dashboard=function(t){if(this.layers=[],!t.anchor)throw new Error("Anchor ID is required.");this.anchor=t.anchor,this.layout="layout-"+(t.layout||"none");var a,e=$("<div>").setID(CityDashboard.mainContainerID).addClass("mainDashboard").addClass(this.layout);if("layout-none"!==this.layout){a=$("<div>").setID(CityDashboard.infoWindowID).addClass("infoWindow");var r;"layout-left"===this.layout?r="e":"layout-right"===this.layout&&(r="w"),a.resizable(r),e.append(a)}var i=$("<div>").setID(CityDashboard.mapWindowID).addClass("mapWindow");e.append(i),$(this.anchor).append(e),this.filters=new CityDashboard.FilterBar(t["filter-number"]||0);var o=this.layers;e.on("filterChanged",function(t,a){for(var e=a(),r=o.length-1;r>=0;r--)o[r].filter(e)})},CityDashboard.Dashboard.prototype={constructor:CityDashboard.Dashboard,addLayer:function(t){var a=this.layers,e=function(t){a[a.length]=LayerSelector(t,$(CityDashboard.mainContainerID)[0].data)};return CityDashboard.getData(t["data-source"],e,t),this},addFilter:function(t){return this.filters.addFilter(t),this},clear:function(){for(var t=0;t<this.layers.length;t++)this.layers[t].clear();this.layers=[]}};